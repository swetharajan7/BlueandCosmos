<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Stream Images - BlueandCosmos</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --accent: #0033a0;
      --flag-blue: #002366;
      --highlight: #ff4081;
      --text-white: #ffffff;
      --text-light: #cce0ff;
      --dark-bg: #121212;
      --dark-accent: #001f5b;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Work Sans', sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    body.dark {
      background-color: var(--dark-bg);
      color: var(--text-white);
    }

    main {
      flex: 1 0 auto;
    }

    :focus-visible {
      outline: 2px dashed var(--highlight);
      outline-offset: 2px;
    }

    header {
      background: var(--accent);
      color: var(--text-white);
      padding: 1em 2em;
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      align-items: center;
      gap: 1.5em;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    .logo-area img {
      height: 50px;
      width: 50px;
      margin: 0;
      padding: 0;
      background-color: transparent;
      display: block;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
      margin-left: -4px;
    }

    .logo-text .title {
      font-size: 1.4em;
      font-weight: bold;
      color: #fff;
      margin: 0;
    }

    .logo-text .tagline {
      font-size: 0.85em;
      color: var(--text-light);
      margin: 0;
    }

    .nav-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1.2em;
    }

    .nav-right>* {
      display: inline-flex;
      align-items: center;
    }

    .moon-widget {
      display: flex;
      align-items: center;
      gap: 0.6em;
      justify-self: center;
      min-width: 220px;
      user-select: none;
      text-decoration: none;
      color: inherit;
    }

    .moon-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .moon-info {
      display: flex;
      flex-direction: column;
      gap: 0.1em;
    }

    .moon-label {
      color: var(--text-light);
      font-size: 0.95em;
      white-space: nowrap;
      font-weight: 500;
    }

    .moon-context {
      color: var(--text-light);
      font-size: 0.75em;
      opacity: 0.8;
      white-space: nowrap;
    }

    body.dark .moon-label,
    body.dark .moon-context {
      color: #e0ecff;
    }

    @media (max-width: 900px) {
      .moon-widget {
        display: none;
      }
    }

    .mars-widget {
      display: flex;
      align-items: center;
      gap: 0.6em;
      justify-self: center;
      user-select: none;
      text-decoration: none;
      color: inherit;
      transition: transform 0.2s ease;
    }

    .mars-label {
      color: var(--text-light);
      font-size: 0.95em;
      font-weight: 600;
      white-space: nowrap;
    }

    body.dark .mars-label {
      color: #e0ecff;
    }

    .mars-widget:hover {
      transform: scale(1.05);
    }

    .mars-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-image: url('https://photojournal.jpl.nasa.gov/jpeg/PIA00407.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(205, 92, 92, 0.4);
      border: 2px solid rgba(205, 92, 92, 0.3);
    }

    @media (max-width: 1100px) {
      .mars-widget {
        display: none;
      }
    }

    nav {
      display: contents;
    }

    .dropdown {
      position: relative;
    }

    .dropbtn {
      background: none;
      border: none;
      font-size: 1em;
      color: #fff;
      cursor: pointer;
      padding: 0.4em 0;
      position: relative;
      text-decoration: none;
      display: inline-block;
    }

    .dropbtn:hover,
    .dropbtn:focus {
      color: var(--highlight);
    }

    .dropbtn::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease-in-out;
    }

    .dropdown:hover>.dropbtn::after,
    .dropbtn:focus::after,
    .dropdown.open>.dropbtn::after {
      width: 100%;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: calc(100% + 0.6em);
      left: 0;
      background: var(--accent);
      min-width: 220px;
      flex-direction: column;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      padding: 0.3em 0;
      border-radius: 6px;
    }

    .dropdown:hover .dropdown-content,
    .dropdown:focus-within .dropdown-content,
    .dropdown.open .dropdown-content {
      display: flex;
    }

    .dropdown-content a {
      color: var(--text-light);
      text-decoration: none;
      padding: 0.8em 1em;
      position: relative;
      transition: color 0.2s ease, background-color 0.2s ease, transform 0.15s ease;
    }

    .dropdown-content a:hover,
    .dropdown-content a:focus,
    .dropdown-content a.clicked {
      background-color: var(--flag-blue);
      color: #fff !important;
      transform: translateX(5px);
    }

    .dropdown-content a::after {
      content: "";
      position: absolute;
      left: 1em;
      bottom: 6px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease;
    }

    .dropdown-content a:hover::after,
    .dropdown-content a:focus::after,
    .dropdown-content a.clicked::after {
      width: calc(100% - 2em);
    }

    body.dark .dropdown-content a {
      color: #d9e6ff;
    }

    .nav-link {
      color: #fff;
      text-decoration: none;
      position: relative;
      padding-bottom: 2px;
    }

    .nav-link:hover {
      color: var(--highlight);
    }

    .nav-link::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease-in-out;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    .toggle-theme {
      cursor: pointer;
      font-size: 1.5em;
      line-height: 1;
      user-select: none;
    }

    body.dark header,
    body.dark footer {
      background-color: var(--dark-accent);
    }

    body.dark .dropbtn,
    body.dark .nav-link {
      color: #e6f0ff;
    }

    /* Livestream-specific styles */
    .livestream-container {
      padding: 2em;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2em;
    }

    .page-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 0.5em;
      background: linear-gradient(135deg, var(--accent), var(--highlight));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      font-size: 1.2em;
      color: var(--text-light);
      margin-bottom: 1em;
    }

    body.dark .page-subtitle {
      color: #cce0ff;
    }

    /* Enhanced Controls Bar Styles */
    .controls-bar {
      margin-bottom: 2em;
      padding: 1.5em;
      background: rgba(0, 51, 160, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(0, 51, 160, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1.5em;
    }

    body.dark .controls-bar {
      background: rgba(0, 31, 91, 0.2);
      border-color: rgba(0, 31, 91, 0.3);
    }

    /* Search Section */
    .search-section {
      position: relative;
    }

    .search-container {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
    }

    .search-input {
      width: 100%;
      padding: 0.8em 3em 0.8em 1em;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 1em;
      background: white;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
    }

    body.dark .search-input {
      background: #2a2a2a;
      border-color: #444;
      color: white;
    }

    body.dark .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.2);
    }

    .search-icon {
      position: absolute;
      right: 1em;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: 2.5em;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.2em;
      color: #666;
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .search-clear:hover {
      background: #f0f0f0;
      color: #333;
    }

    body.dark .search-clear:hover {
      background: #444;
      color: #fff;
    }

    /* Search Suggestions */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      margin-top: 0.5em;
      padding: 1em;
    }

    body.dark .search-suggestions {
      background: #2a2a2a;
      border-color: #444;
    }

    .suggestion-category h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.dark .suggestion-category h4 {
      color: #aaa;
    }

    .quick-searches {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }

    .suggestion-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 15px;
      padding: 0.4em 0.8em;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .suggestion-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    /* Filter Controls Row */
    .filter-controls {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Advanced Filters */
    .advanced-filters {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 1em;
      border-left: 3px solid var(--accent);
    }

    body.dark .advanced-filters {
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-group {
      margin-bottom: 1em;
    }

    .filter-group:last-child {
      margin-bottom: 0;
    }

    .filter-group label {
      display: block;
      font-size: 0.9em;
      font-weight: 500;
      margin-bottom: 0.5em;
      color: #333;
    }

    body.dark .filter-group label {
      color: #fff;
    }

    .source-filters,
    .date-filters {
      display: flex;
      gap: 0.3em;
      flex-wrap: wrap;
    }

    .source-filter-btn,
    .date-filter-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.4em 0.8em;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .source-filter-btn:hover,
    .date-filter-btn:hover {
      background: #f8f9fa;
    }

    .source-filter-btn.active,
    .date-filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .source-filter-btn,
    body.dark .date-filter-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    body.dark .source-filter-btn:hover,
    body.dark .date-filter-btn:hover {
      background: #495057;
    }

    /* View and Options Row */
    .view-and-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1em;
    }

    .filter-options {
      display: flex;
      gap: 0.5em;
    }

    .options-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.2s ease;
    }

    .options-btn:hover,
    .options-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .options-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    /* Sort Options */
    .sort-options {
      background: rgba(0, 51, 160, 0.05);
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      border-left: 3px solid var(--highlight);
    }

    body.dark .sort-options {
      background: rgba(0, 31, 91, 0.2);
    }

    .sort-group label {
      display: block;
      font-size: 0.9em;
      font-weight: 500;
      margin-bottom: 0.5em;
      color: #333;
    }

    body.dark .sort-group label {
      color: #fff;
    }

    .sort-buttons {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    .sort-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.5em 1em;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sort-btn:hover {
      background: #f8f9fa;
    }

    .sort-btn.active {
      background: var(--highlight);
      color: white;
      border-color: var(--highlight);
    }

    body.dark .sort-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    body.dark .sort-btn:hover {
      background: #495057;
    }

    .filter-controls {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: #fff;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 0.5em 1em;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .filter-btn:hover,
    .filter-btn:focus {
      background: var(--accent);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 51, 160, 0.2);
    }

    .filter-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 160, 0.3);
    }

    body.dark .filter-btn {
      background: var(--dark-bg);
      border-color: var(--text-light);
      color: var(--text-light);
    }

    body.dark .filter-btn:hover,
    body.dark .filter-btn:focus,
    body.dark .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .view-controls {
      display: flex;
      gap: 0.3em;
      background: #fff;
      border-radius: 8px;
      padding: 0.2em;
      border: 1px solid #ddd;
    }

    body.dark .view-controls {
      background: var(--dark-bg);
      border-color: #444;
    }

    .view-btn {
      background: transparent;
      border: none;
      padding: 0.5em 0.8em;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.2s ease;
      color: #666;
    }

    .view-btn:hover,
    .view-btn:focus {
      background: rgba(0, 51, 160, 0.1);
      color: var(--accent);
    }

    .view-btn.active {
      background: var(--accent);
      color: white;
    }

    body.dark .view-btn {
      color: #aaa;
    }

    body.dark .view-btn:hover,
    body.dark .view-btn:focus {
      background: rgba(0, 51, 160, 0.2);
      color: var(--text-light);
    }

    .refresh-indicator {
      display: flex;
      align-items: center;
      gap: 0.8em;
      font-size: 0.9em;
      color: #666;
    }

    body.dark .refresh-indicator {
      color: #aaa;
    }

    .last-updated {
      font-style: italic;
    }

    .refresh-btn {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s ease;
    }

    .refresh-btn:hover,
    .refresh-btn:focus {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: rotate(180deg);
    }

    .refresh-btn.spinning {
      animation: spin 1s linear infinite;
    }

    .refresh-btn.success {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }

    .refresh-btn.error {
      background: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* Auto-refresh status indicator */
    .auto-refresh-status {
      position: fixed;
      bottom: 2em;
      right: 2em;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.8em 1.2em;
      border-radius: 8px;
      font-size: 0.85em;
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .auto-refresh-status.visible {
      display: block;
      animation: slideInUp 0.3s ease;
    }

    .auto-refresh-status.success {
      background: rgba(40, 167, 69, 0.9);
      border-color: rgba(40, 167, 69, 0.5);
    }

    .auto-refresh-status.error {
      background: rgba(220, 53, 69, 0.9);
      border-color: rgba(220, 53, 69, 0.5);
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Auto-refresh controls */
    .auto-refresh-controls {
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.8em;
      color: #666;
    }

    body.dark .auto-refresh-controls {
      color: #aaa;
    }

    .auto-refresh-toggle {
      background: none;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2em 0.5em;
      cursor: pointer;
      font-size: 0.75em;
      transition: all 0.2s ease;
    }

    .auto-refresh-toggle:hover {
      background: #f8f9fa;
    }

    .auto-refresh-toggle.enabled {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .auto-refresh-toggle {
      border-color: #444;
      color: #aaa;
    }

    body.dark .auto-refresh-toggle:hover {
      background: #333;
    }

    body.dark .refresh-btn {
      background: var(--dark-bg);
      border-color: #444;
      color: #aaa;
    }

    body.dark .refresh-btn:hover,
    body.dark .refresh-btn:focus {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Image Gallery Grid Layout */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 2em;
      transition: all 0.3s ease;
    }

    /* List View Layout */
    .image-gallery.list-view {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .image-gallery.list-view .image-card {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5em;
      align-items: start;
    }

    .image-gallery.list-view .image-container {
      aspect-ratio: 16/9;
      width: 100%;
    }

    .image-gallery.list-view .image-info {
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }

    .image-gallery.list-view .image-title {
      font-size: 1.3em;
      margin-bottom: 0.8em;
    }

    .image-gallery.list-view .image-description {
      -webkit-line-clamp: 4;
      margin-bottom: 1.5em;
    }

    @media (max-width: 768px) {
      .image-gallery.list-view .image-card {
        grid-template-columns: 1fr;
        gap: 1em;
      }

      .image-gallery.list-view .image-info {
        padding: 1em;
      }
    }

    /* Fade in animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading message styles */
    .loading-message {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4em 2em;
      font-size: 1.1em;
      color: #666;
      background: linear-gradient(135deg, rgba(0, 51, 160, 0.05), rgba(255, 64, 129, 0.05));
      border-radius: 12px;
      border: 2px dashed rgba(0, 51, 160, 0.2);
    }

    body.dark .loading-message {
      color: #ccc;
      background: linear-gradient(135deg, rgba(0, 31, 91, 0.2), rgba(255, 64, 129, 0.1));
      border-color: rgba(0, 31, 91, 0.3);
    }

    /* Error message styles */
    .error-message {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2em;
      background: rgba(255, 64, 129, 0.1);
      border: 2px dashed var(--highlight);
      border-radius: 12px;
      color: #d63384;
    }

    body.dark .error-message {
      background: rgba(255, 64, 129, 0.2);
      color: #ff6b9d;
    }

    /* NASA-specific styling */
    .apod-image {
      position: relative;
    }

    .apod-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .image-attribution {
      font-size: 0.75em;
      color: #888;
      font-style: italic;
      margin-top: 0.5em;
      padding-top: 0.5em;
      border-top: 1px solid #eee;
    }

    body.dark .image-attribution {
      color: #aaa;
      border-top-color: #333;
    }

    /* Enhanced source styling for all agencies */
    [data-source="nasa"] .source {
      background: linear-gradient(135deg, var(--accent), #0066cc);
      box-shadow: 0 2px 4px rgba(0, 51, 160, 0.3);
    }

    [data-source="nasa"].apod-image .source {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
    }

    [data-source="spacex"] .source {
      background: linear-gradient(135deg, #005288, #0074cc);
      box-shadow: 0 2px 4px rgba(0, 82, 136, 0.3);
    }

    [data-source="esa"] .source {
      background: linear-gradient(135deg, #6f42c1, #8e44ad);
      box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
    }

    [data-source="iss"] .source {
      background: linear-gradient(135deg, #28a745, #20c997);
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    /* Agency-specific card enhancements */
    [data-source="spacex"] {
      border-left: 3px solid #005288;
    }

    [data-source="esa"] {
      border-left: 3px solid #6f42c1;
    }

    [data-source="iss"] {
      border-left: 3px solid #28a745;
    }

    [data-source="nasa"] {
      border-left: 3px solid var(--accent);
    }

    /* Enhanced image loading states and performance optimizations */
    .image-container img {
      transition: opacity 0.4s ease, transform 0.3s ease;
      opacity: 0;
      will-change: opacity, transform;
    }

    .image-container img.loaded {
      opacity: 1;
    }

    .image-container img.loading {
      opacity: 0.3;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    body.dark .image-container img.loading {
      background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
    }

    .image-container img.error {
      opacity: 0.7;
      filter: grayscale(0.5);
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* Performance optimizations */
    .image-card {
      contain: layout style paint;
      transform: translateZ(0);
      /* Force hardware acceleration */
    }

    .image-container {
      contain: layout;
      transform: translateZ(0);
    }

    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {

      .image-container img,
      .image-card,
      .overlay-btn {
        transition: none !important;
        animation: none !important;
      }

      .skeleton {
        animation: none !important;
      }
    }

    /* Optimize for high DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2),
    (min-resolution: 192dpi) {
      .image-container img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    }

    /* Memory optimization for large galleries */
    .image-gallery {
      contain: layout style;
    }

    /* Preload critical images */
    .image-container img[data-priority="high"] {
      opacity: 1;
    }

    /* Modal System Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      padding: 2em;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 90vw;
      max-height: 90vh;
      width: 1200px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
    }

    body.dark .modal-content {
      background: #1a1a1a;
      color: #fff;
    }

    .modal-close {
      position: absolute;
      top: 1em;
      right: 1em;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5em;
      cursor: pointer;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover,
    .modal-close:focus {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .modal-image-container {
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .modal-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.3s ease;
    }

    .modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1em;
      color: white;
      font-size: 0.9em;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .modal-navigation {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      padding: 0 1em;
      pointer-events: none;
    }

    .nav-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5em;
      cursor: pointer;
      pointer-events: auto;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover,
    .nav-btn:focus {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .modal-info {
      padding: 2em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5em;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: bold;
      margin: 0;
      line-height: 1.3;
      color: #333;
    }

    body.dark .modal-title {
      color: #fff;
    }

    .modal-description {
      font-size: 1em;
      line-height: 1.6;
      color: #666;
      margin: 0;
    }

    body.dark .modal-description {
      color: #ccc;
    }

    .modal-meta {
      border-top: 1px solid #eee;
      padding-top: 1.5em;
    }

    body.dark .modal-meta {
      border-top-color: #333;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
      margin-bottom: 1em;
    }

    .meta-item {
      font-size: 0.9em;
    }

    .meta-item strong {
      color: #333;
      display: block;
      margin-bottom: 0.2em;
    }

    body.dark .meta-item strong {
      color: #fff;
    }

    .meta-item span,
    .meta-item time {
      color: #666;
    }

    body.dark .meta-item span,
    body.dark .meta-item time {
      color: #aaa;
    }

    .modal-attribution {
      font-size: 0.8em;
      color: #888;
      font-style: italic;
      padding: 0.5em;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
    }

    body.dark .modal-attribution {
      background: rgba(255, 255, 255, 0.05);
      color: #aaa;
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }

    .primary-actions {
      display: flex;
      gap: 0.8em;
      flex-wrap: wrap;
    }

    .secondary-actions {
      display: flex;
      gap: 0.5em;
      justify-content: center;
      padding-top: 0.5em;
      border-top: 1px solid #eee;
    }

    body.dark .secondary-actions {
      border-top-color: #333;
    }

    .action-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.8em 1.2em;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      flex: 1;
      justify-content: center;
      min-width: 120px;
    }

    .action-btn:hover,
    .action-btn:focus {
      background: var(--flag-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 51, 160, 0.3);
    }

    .action-btn-small {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #dee2e6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1.1em;
    }

    .action-btn-small:hover,
    .action-btn-small:focus {
      background: #e9ecef;
      transform: scale(1.1);
    }

    .action-btn-small.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .action-btn-small {
      background: #343a40;
      color: #fff;
      border-color: #495057;
    }

    body.dark .action-btn-small:hover {
      background: #495057;
    }

    .share-btn {
      background: var(--highlight);
    }

    .share-btn:hover {
      background: #e91e63;
    }

    .download-btn {
      background: #28a745;
    }

    .download-btn:hover {
      background: #218838;
    }

    /* Enhanced metadata styling */
    .modal-technical-info,
    .modal-keywords {
      margin-top: 1.5em;
      padding-top: 1em;
      border-top: 1px solid #eee;
    }

    body.dark .modal-technical-info,
    body.dark .modal-keywords {
      border-top-color: #333;
    }

    .modal-technical-info h4,
    .modal-keywords h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.dark .modal-technical-info h4,
    body.dark .modal-keywords h4 {
      color: #aaa;
    }

    .technical-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8em;
    }

    .tech-item {
      font-size: 0.85em;
    }

    .keywords-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }

    .keyword-tag {
      background: rgba(0, 51, 160, 0.1);
      color: var(--accent);
      padding: 0.3em 0.6em;
      border-radius: 12px;
      font-size: 0.8em;
      border: 1px solid rgba(0, 51, 160, 0.2);
    }

    body.dark .keyword-tag {
      background: rgba(0, 51, 160, 0.2);
      color: #66b3ff;
      border-color: rgba(0, 51, 160, 0.3);
    }

    /* Social sharing menu */
    .social-share-expanded {
      margin-top: 1em;
      padding: 1em;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      border-left: 3px solid var(--highlight);
    }

    body.dark .social-share-expanded {
      background: rgba(255, 255, 255, 0.05);
    }

    .social-share-expanded h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
    }

    body.dark .social-share-expanded h4 {
      color: #aaa;
    }

    .social-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5em;
    }

    .social-btn {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.6em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.85em;
      transition: all 0.2s ease;
    }

    .social-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body.dark .social-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    .twitter-btn:hover {
      background: #1da1f2;
      color: white;
      border-color: #1da1f2;
    }

    .facebook-btn:hover {
      background: #4267b2;
      color: white;
      border-color: #4267b2;
    }

    .reddit-btn:hover {
      background: #ff4500;
      color: white;
      border-color: #ff4500;
    }

    .copy-btn:hover {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }

    /* Mobile responsive modal */
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 1em;
      }

      .modal-content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        max-height: 95vh;
        width: 100%;
      }

      .modal-info {
        padding: 1.5em;
        max-height: 40vh;
      }

      .meta-grid {
        grid-template-columns: 1fr;
        gap: 0.8em;
      }

      .modal-actions {
        flex-direction: column;
      }

      .action-btn {
        flex: none;
      }

      .nav-btn {
        width: 44px;
        height: 44px;
        font-size: 1.2em;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {

      .modal-overlay,
      .modal-content,
      .modal-image,
      .nav-btn,
      .action-btn {
        transition: none !important;
      }

      .loading-spinner {
        animation: none !important;
      }

      .mobile-optimized .image-card {
        transform: none !important;
      }
    }

    /* Mobile-specific optimizations */
    .mobile-optimized {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .mobile-optimized .image-card {
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    /* Touch-friendly improvements */
    @media (max-width: 768px) {
      .overlay-btn {
        width: 48px;
        height: 48px;
        font-size: 1.3em;
      }

      .nav-btn {
        width: 56px;
        height: 56px;
        font-size: 1.6em;
      }

      .modal-close {
        width: 48px;
        height: 48px;
        font-size: 1.6em;
      }

      /* Improve touch scrolling */
      .image-gallery {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }

      /* Mobile image optimizations */
      .image-container img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }

      /* Mobile modal optimizations */
      .modal-content {
        margin: 0.5em;
        max-height: calc(100vh - 1em);
      }

      .modal-info {
        padding: 1em;
        font-size: 0.9em;
      }

      .modal-title {
        font-size: 1.2em;
      }

      .modal-actions {
        gap: 0.5em;
      }

      .action-btn {
        min-height: 48px;
        font-size: 0.85em;
      }

      .social-btn {
        min-height: 44px;
        padding: 0.7em;
      }

      /* Mobile performance optimizations */
      .image-card:hover {
        transform: none; /* Disable hover effects on mobile */
      }

      .image-container:hover img {
        transform: none;
      }

      /* Mobile-specific animations */
      .image-card {
        transition: opacity 0.2s ease;
      }

      /* Optimize for mobile bandwidth */
      @media (max-width: 480px) and (max-resolution: 150dpi) {
        .image-container img {
          max-width: 100%;
          height: auto;
        }
      }
    }

    /* Landscape mobile optimizations */
    @media (max-width: 768px) and (orientation: landscape) {
      .modal-content {
        grid-template-columns: 1.5fr 1fr;
        max-height: 95vh;
      }

      .modal-info {
        font-size: 0.8em;
      }

      .controls-bar {
        padding: 0.8em;
      }

      .filter-controls {
        gap: 0.3em;
      }
    }

    /* Very small screens */
    @media (max-width: 320px) {
      .livestream-container {
        padding: 0.5em;
      }

      .controls-bar {
        padding: 0.8em;
      }

      .filter-btn {
        font-size: 0.75em;
        padding: 0.5em 0.8em;
      }

      .search-input {
        font-size: 14px;
        padding: 0.7em 2.5em 0.7em 0.8em;
      }

      .image-info {
        padding: 0.6em;
      }

      .image-title {
        font-size: 0.9em;
      }

      .image-description {
        font-size: 0.8em;
        -webkit-line-clamp: 2;
      }
    }

    /* Responsive breakpoints */
    @media (max-width: 1200px) {
      .image-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .image-gallery {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .image-gallery {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    /* Image Card Styles */
    .image-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .image-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    body.dark .image-card {
      background: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body.dark .image-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .image-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .image-card:hover .image-container img {
      transform: scale(1.05);
    }

    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.7) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      padding: 1em;
      gap: 0.5em;
    }

    .image-card:hover .image-overlay {
      opacity: 1;
    }

    .overlay-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .overlay-btn:hover,
    .overlay-btn:focus {
      background: #fff;
      transform: scale(1.1);
      outline: 2px solid var(--highlight);
      outline-offset: 2px;
    }

    .overlay-btn:active {
      transform: scale(0.95);
    }

    /* Improve image loading states */
    .image-container img {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .image-container img[data-src] {
      opacity: 0.7;
    }

    .image-container img:not([data-src]) {
      opacity: 1;
    }

    .image-info {
      padding: 1.2em;
    }

    .image-title {
      font-size: 1.1em;
      font-weight: bold;
      margin: 0 0 0.5em 0;
      color: #333;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.dark .image-title {
      color: #fff;
    }

    .image-description {
      font-size: 0.9em;
      color: #666;
      margin: 0 0 1em 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.dark .image-description {
      color: #ccc;
    }

    .image-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8em;
      color: #888;
    }

    body.dark .image-meta {
      color: #aaa;
    }

    .source {
      color: white;
      padding: 0.2em 0.6em;
      border-radius: 12px;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.75em;
    }

    /* Source-specific colors */
    .source:contains("NASA"),
    [data-source="nasa"] .source {
      background: var(--accent);
    }

    [data-source="spacex"] .source {
      background: #005288;
    }

    [data-source="iss"] .source {
      background: #28a745;
    }

    [data-source="esa"] .source {
      background: #6f42c1;
    }

    .timestamp {
      font-style: italic;
    }

    /* Loading Skeleton Animations */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    body.dark .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark .skeleton-card {
      background: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .skeleton-image {
      width: 100%;
      aspect-ratio: 16/9;
    }

    .skeleton-content {
      padding: 1.2em;
    }

    .skeleton-title {
      height: 1.2em;
      border-radius: 4px;
      margin-bottom: 0.5em;
    }

    .skeleton-description {
      height: 0.9em;
      border-radius: 4px;
      margin-bottom: 0.3em;
    }

    .skeleton-description:last-of-type {
      width: 70%;
      margin-bottom: 1em;
    }

    .skeleton-meta {
      display: flex;
      justify-content: space-between;
    }

    .skeleton-source {
      width: 60px;
      height: 1.2em;
      border-radius: 12px;
    }

    .skeleton-timestamp {
      width: 80px;
      height: 1em;
      border-radius: 4px;
    }

    .placeholder-content {
      text-align: center;
      padding: 4em 2em;
      background: linear-gradient(135deg, rgba(0, 51, 160, 0.1), rgba(255, 64, 129, 0.1));
      border-radius: 12px;
      border: 2px dashed var(--accent);
    }

    .placeholder-icon {
      font-size: 4em;
      margin-bottom: 1em;
    }

    .placeholder-text {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
    }

    body.dark .placeholder-content {
      background: linear-gradient(135deg, rgba(0, 31, 91, 0.3), rgba(255, 64, 129, 0.1));
      border-color: var(--dark-accent);
    }

    body.dark .placeholder-text {
      color: #ccc;
    }

    footer {
      background-color: var(--accent);
      color: #fff;
      padding: 2em 1em;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      text-align: center;
      gap: 1em;
    }

    footer a {
      color: #fff;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .livestream-container {
        padding: 1em;
      }

      .page-title {
        font-size: 2em;
      }

      .page-subtitle {
        font-size: 1em;
      }

      .image-info {
        padding: 1em;
      }

      .image-title {
        font-size: 1em;
      }

      .image-description {
        font-size: 0.85em;
        -webkit-line-clamp: 2;
      }

      .overlay-btn {
        width: 36px;
        height: 36px;
        font-size: 1em;
      }
    }

    /* Enhanced Mobile Optimizations */
    @media (max-width: 768px) {
      .livestream-container {
        padding: 1em;
      }

      .controls-bar {
        padding: 1em;
        gap: 1em;
      }

      /* Mobile search optimization */
      .search-container {
        max-width: 100%;
      }

      .search-input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 0.9em 3em 0.9em 1em;
      }

      .search-suggestions {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 16px 16px 0 0;
        max-height: 50vh;
        overflow-y: auto;
      }

      /* Mobile filter controls */
      .filter-controls {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 0.5em;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .filter-controls::-webkit-scrollbar {
        display: none;
      }

      .filter-btn {
        flex-shrink: 0;
        font-size: 0.85em;
        padding: 0.6em 1em;
      }

      /* Mobile advanced filters */
      .advanced-filters {
        padding: 0.8em;
      }

      .source-filters,
      .date-filters {
        gap: 0.2em;
      }

      .source-filter-btn,
      .date-filter-btn {
        font-size: 0.75em;
        padding: 0.5em 0.7em;
      }

      /* Mobile view controls */
      .view-and-options {
        flex-direction: column;
        gap: 0.8em;
      }

      .filter-options {
        justify-content: center;
      }

      .refresh-indicator {
        align-self: center;
      }

      .auto-refresh-controls {
        flex-direction: column;
        align-items: center;
        gap: 0.3em;
        text-align: center;
      }

      /* Mobile sort options */
      .sort-buttons {
        gap: 0.3em;
      }

      .sort-btn {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
      }
    }

    @media (max-width: 480px) {
      .page-header {
        margin-bottom: 1.5em;
      }

      .page-title {
        font-size: 1.8em;
      }

      .image-info {
        padding: 0.8em;
      }

      .image-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3em;
      }

      .controls-bar {
        padding: 1em;
      }

      .filter-btn {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
      }
    }
  </style>
</head>

<body>
  <header>
    <a href="index.html" class="logo-link" aria-label="BlueandCosmos Home">
      <div class="logo-area">
        <img src="https://cdn.jsdelivr.net/gh/swetharajan7/blueandcosmos/assets/logo-transparent.png"
          alt="BlueandCosmos Logo" />
        <div class="logo-text">
          <div class="title">BlueandCosmos</div>
          <div class="tagline">Exploring the Cosmos. Protecting the Earth.</div>
        </div>
      </div>
    </a>

    <a href="moon.html" class="moon-widget" title="View detailed moon phase information">
      <div class="moon-icon" id="moon-display">ðŸŒ™</div>
      <div class="moon-info">
        <span class="moon-label">Loading moon phaseâ€¦</span>
        <span class="moon-context" id="moon-context">New York City, NY</span>
      </div>
    </a>

    <a href="mars.html" class="mars-widget" title="Explore Mars - The Red Planet">
      <div class="mars-icon"></div>
      <span class="mars-label">MARS</span>
    </a>

    <nav>
      <div class="nav-right">
        <!-- About (internal links, same tab) -->
        <div class="dropdown" data-menu="about">
          <button class="dropbtn">About</button>
          <div class="dropdown-content" role="menu" aria-label="About submenu">
            <a href="about.html" role="menuitem">About BlueandCosmos</a>
          </div>
        </div>

        <!-- Livestream (internal placeholders as relative links) -->
        <div class="dropdown" data-menu="livestream">
          <button class="dropbtn">Livestream</button>
          <div class="dropdown-content" role="menu" aria-label="Livestream submenu">
            <a href="livestream-images.html" role="menuitem" class="clicked">Live Stream Images</a>
            <a href="launch-missions.html" role="menuitem">Launch Missions</a>
            <a href="webinars.html" role="menuitem">Webinars</a>
          </div>
        </div>

        <!-- Dashboard (educational tools and features) -->
        <div class="dropdown" data-menu="dashboard">
          <a href="dashboard.html" class="dropbtn">Dashboard</a>
          <div class="dropdown-content" role="menu" aria-label="Dashboard submenu">
            <a href="moon.html" role="menuitem">ðŸŒ™ Lunar Intelligence Center</a>
            <a href="telescope.html" role="menuitem">ðŸ”­ Telescope</a>
            <a href="flashcards.html" role="menuitem">ðŸ§  Flashcards</a>
            <a href="stellarrec.html" role="menuitem">â­ StellarRec</a>
            <a href="discussion.html" role="menuitem">ðŸ’¬ Community</a>
          </div>
        </div>
        <div class="toggle-theme" id="themeToggle">ðŸŒ™</div>
      </div>
    </nav>
  </header>

  <main class="livestream-container">
    <div class="page-header">
      <h1 class="page-title">Live Stream Images</h1>
      <p class="page-subtitle">Real-time space imagery from missions, observatories, and cosmic events</p>
    </div>

    <!-- Controls Bar -->
    <section class="controls-bar">
      <div class="search-section">
        <div class="search-container">
          <input type="text" class="search-input" id="search-input" placeholder="Search space images..."
            autocomplete="off">
          <button class="search-clear" id="search-clear" title="Clear search" style="display: none;">Ã—</button>
          <div class="search-icon">ðŸ”</div>
        </div>
        <div class="search-suggestions" id="search-suggestions" style="display: none;">
          <div class="suggestion-category">
            <h4>Quick Searches</h4>
            <div class="quick-searches">
              <button class="suggestion-btn" data-search="mars rover">Mars Rover</button>
              <button class="suggestion-btn" data-search="hubble telescope">Hubble</button>
              <button class="suggestion-btn" data-search="earth from space">Earth from Space</button>
              <button class="suggestion-btn" data-search="nebula">Nebula</button>
              <button class="suggestion-btn" data-search="jupiter">Jupiter</button>
              <button class="suggestion-btn" data-search="aurora">Aurora</button>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="missions">Missions</button>
        <button class="filter-btn" data-filter="deep-space">Deep Space</button>
        <button class="filter-btn" data-filter="earth">Earth</button>
        <button class="filter-btn" data-filter="planets">Planets</button>
        <button class="filter-btn" data-filter="iss">ISS</button>
      </div>

      <div class="advanced-filters" id="advanced-filters" style="display: none;">
        <div class="filter-group">
          <label>Source:</label>
          <div class="source-filters">
            <button class="source-filter-btn active" data-source="all">All</button>
            <button class="source-filter-btn" data-source="nasa">NASA</button>
            <button class="source-filter-btn" data-source="spacex">SpaceX</button>
            <button class="source-filter-btn" data-source="esa">ESA</button>
            <button class="source-filter-btn" data-source="iss">ISS</button>
          </div>
        </div>

        <div class="filter-group">
          <label>Date Range:</label>
          <div class="date-filters">
            <button class="date-filter-btn active" data-range="all">All Time</button>
            <button class="date-filter-btn" data-range="today">Today</button>
            <button class="date-filter-btn" data-range="week">This Week</button>
            <button class="date-filter-btn" data-range="month">This Month</button>
          </div>
        </div>
      </div>

      <div class="view-and-options">
        <div class="view-controls">
          <button class="view-btn active" data-view="grid" title="Grid View">âŠž</button>
          <button class="view-btn" data-view="list" title="List View">â˜°</button>
        </div>

        <div class="filter-options">
          <button class="options-btn" id="advanced-toggle" title="Advanced Filters">âš™ï¸</button>
          <button class="options-btn" id="sort-toggle" title="Sort Options">â†•ï¸</button>
        </div>

        <div class="refresh-indicator">
          <div class="auto-refresh-controls">
            <span class="last-updated">Updated: <time id="last-refresh">just now</time></span>
            <button class="auto-refresh-toggle enabled" id="auto-refresh-toggle" title="Toggle Auto-refresh">
              Auto
            </button>
          </div>
          <button class="refresh-btn" title="Refresh Now">ðŸ”„</button>
        </div>
      </div>
    </section>

    <!-- Sort Options -->
    <div class="sort-options" id="sort-options" style="display: none;">
      <div class="sort-group">
        <label>Sort by:</label>
        <div class="sort-buttons">
          <button class="sort-btn active" data-sort="date-desc">Newest First</button>
          <button class="sort-btn" data-sort="date-asc">Oldest First</button>
          <button class="sort-btn" data-sort="title-asc">Title A-Z</button>
          <button class="sort-btn" data-sort="source-asc">Source</button>
        </div>
      </div>
    </div>

    <!-- Image Gallery Grid -->
    <section class="image-gallery" id="image-gallery">
      <!-- Sample Image Cards with Real Space Imagery -->
      <article class="image-card" data-category="missions" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg"
            alt="Perseverance Mars Rover Self-Portrait" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Perseverance Mars Rover Self-Portrait</h3>
          <p class="image-description">NASA's Perseverance rover took this selfie over a rock nicknamed "Rochette," on
            Sol 198 (September 10, 2021). The rover is preparing to take its first sample from this rock.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">2 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="deep-space" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg" alt="Hubble Views the Crab Nebula"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Hubble Views the Crab Nebula</h3>
          <p class="image-description">This Hubble Space Telescope image shows the Crab Nebula, the result of a
            supernova explosion that was observed by Chinese astronomers in 1054 AD.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">4 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="earth" data-source="iss">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg"
            alt="Earth from the International Space Station" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Earth from the International Space Station</h3>
          <p class="image-description">A stunning view of Earth's curvature and atmosphere captured from the
            International Space Station, showing the thin blue line of our planet's protective atmosphere.</p>
          <div class="image-meta">
            <span class="source">ISS</span>
            <time class="timestamp">1 hour ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="planets" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA21773/PIA21773~thumb.jpg" alt="Jupiter's Great Red Spot"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Jupiter's Great Red Spot</h3>
          <p class="image-description">This enhanced-color image of Jupiter's Great Red Spot was created by citizen
            scientist Gerald EichstÃ¤dt using data from Juno's JunoCam imager.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">6 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="missions" data-source="spacex">
        <div class="image-container">
          <img
            src="https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg"
            alt="SpaceX Falcon 9 Launch" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">SpaceX Falcon 9 Launch</h3>
          <p class="image-description">A SpaceX Falcon 9 rocket carrying NASA astronauts Doug Hurley and Bob Behnken in
            the Crew Dragon spacecraft lifts off from Launch Complex 39A.</p>
          <div class="image-meta">
            <span class="source">SPACEX</span>
            <time class="timestamp">3 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="deep-space" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg" alt="Webb's First Deep Field"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Webb's First Deep Field</h3>
          <p class="image-description">NASA's James Webb Space Telescope has delivered the deepest and sharpest infrared
            image of the distant universe so far, showing galaxy cluster SMACS 0723.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">5 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="planets" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA23791/PIA23791~thumb.jpg" alt="Saturn's Rings in Infrared"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Saturn's Rings in Infrared</h3>
          <p class="image-description">This infrared image from NASA's Cassini spacecraft shows Saturn's rings in
            exquisite detail, revealing the complex structure and composition of the ring system.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">8 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="iss" data-source="iss">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg" alt="Aurora from Space"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">ðŸ”</button>
            <button class="overlay-btn share-btn" title="Share Image">ðŸ“¤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Aurora from Space</h3>
          <p class="image-description">A spectacular aurora borealis captured from the International Space Station,
            showing the dancing lights of charged particles interacting with Earth's magnetic field.</p>
          <div class="image-meta">
            <span class="source">ISS</span>
            <time class="timestamp">30 minutes ago</time>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Image Modal -->
  <div class="modal-overlay" id="image-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" title="Close Modal" aria-label="Close">&times;</button>

      <div class="modal-image-container">
        <img class="modal-image" src="" alt="" id="modal-image">
        <div class="modal-navigation">
          <button class="nav-btn prev-btn" title="Previous Image" aria-label="Previous Image">â€¹</button>
          <button class="nav-btn next-btn" title="Next Image" aria-label="Next Image">â€º</button>
        </div>
        <div class="modal-loading">
          <div class="loading-spinner"></div>
          <span>Loading high-resolution image...</span>
        </div>
      </div>

      <div class="modal-info">
        <h2 class="modal-title" id="modal-title"></h2>
        <p class="modal-description"></p>

        <div class="modal-meta">
          <div class="meta-grid">
            <div class="meta-item">
              <strong>Source:</strong>
              <span class="modal-source"></span>
            </div>
            <div class="meta-item">
              <strong>Date:</strong>
              <time class="modal-date"></time>
            </div>
            <div class="meta-item">
              <strong>Category:</strong>
              <span class="modal-category"></span>
            </div>
            <div class="meta-item modal-mission" style="display: none;">
              <strong>Mission:</strong>
              <span class="modal-mission-name"></span>
            </div>
            <div class="meta-item modal-instrument" style="display: none;">
              <strong>Instrument:</strong>
              <span class="modal-instrument-name"></span>
            </div>
            <div class="meta-item modal-location" style="display: none;">
              <strong>Location:</strong>
              <span class="modal-location-name"></span>
            </div>
          </div>

          <div class="modal-technical-info" style="display: none;">
            <h4>Technical Details</h4>
            <div class="technical-grid">
              <div class="tech-item modal-resolution" style="display: none;">
                <strong>Resolution:</strong>
                <span class="modal-resolution-value"></span>
              </div>
              <div class="tech-item modal-coordinates" style="display: none;">
                <strong>Coordinates:</strong>
                <span class="modal-coordinates-value"></span>
              </div>
              <div class="tech-item modal-altitude" style="display: none;">
                <strong>Altitude:</strong>
                <span class="modal-altitude-value"></span>
              </div>
            </div>
          </div>

          <div class="modal-keywords" style="display: none;">
            <h4>Keywords</h4>
            <div class="keywords-container"></div>
          </div>

          <div class="modal-attribution"></div>
        </div>

        <div class="modal-actions">
          <div class="primary-actions">
            <button class="action-btn share-btn" id="modal-share">
              <span class="btn-icon">ðŸ“¤</span>
              <span class="btn-text">Share</span>
            </button>
            <a class="action-btn source-btn" href="#" target="_blank" rel="noopener" id="modal-source-link">
              <span class="btn-icon">ðŸ”—</span>
              <span class="btn-text">View Source</span>
            </a>
            <button class="action-btn download-btn" id="modal-download">
              <span class="btn-icon">â¬‡ï¸</span>
              <span class="btn-text">Download</span>
            </button>
          </div>

          <div class="secondary-actions">
            <button class="action-btn-small favorite-btn" id="modal-favorite" title="Add to Favorites">
              <span class="btn-icon">â¤ï¸</span>
            </button>
            <button class="action-btn-small fullscreen-btn" id="modal-fullscreen" title="View Fullscreen">
              <span class="btn-icon">â›¶</span>
            </button>
            <button class="action-btn-small info-toggle-btn" id="modal-info-toggle" title="Toggle Technical Info">
              <span class="btn-icon">â„¹ï¸</span>
            </button>
          </div>

          <div class="social-share-expanded" id="social-share-menu" style="display: none;">
            <h4>Share on Social Media</h4>
            <div class="social-buttons">
              <button class="social-btn twitter-btn" data-platform="twitter">
                <span class="social-icon">ðŸ¦</span>
                <span class="social-text">Twitter</span>
              </button>
              <button class="social-btn facebook-btn" data-platform="facebook">
                <span class="social-icon">ðŸ“˜</span>
                <span class="social-text">Facebook</span>
              </button>
              <button class="social-btn reddit-btn" data-platform="reddit">
                <span class="social-icon">ðŸ”´</span>
                <span class="social-text">Reddit</span>
              </button>
              <button class="social-btn copy-btn" data-platform="copy">
                <span class="social-icon">ðŸ“‹</span>
                <span class="social-text">Copy Link</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto-refresh status indicator -->
  <div class="auto-refresh-status" id="auto-refresh-status">
    <span class="status-text"></span>
  </div>

  <footer>
    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-start;gap:0.5em;">
      <a href="#"><img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg"
          alt="Google Play Store" style="height:40px;"></a>
      <a href="#"><img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg"
          alt="Apple Store" style="height:40px;"></a>
    </div>

    <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:0.5em;">
      <div style="font-weight:bold;">BlueandCosmosâ„¢ 2025</div>
      <div style="display:flex;flex-wrap:wrap;gap:1em;justify-content:center;font-size:0.9em;">
        <a href="privacy.html">Privacy Policy</a>
        <a href="terms.html">Terms of Use</a>
        <a href="sitemap.html">Sitemap</a>
      </div>
    </div>

    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:0.5em;">
      <div style="font-weight:bold;">Let's Connect!</div>
      <div style="display:flex;gap:0.5em;">
        <a href="https://twitter.com/blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="X"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://instagram.com/blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://tiktok.com/@blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://youtube.com/@blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"
            style="height:24px;filter:invert(1);"></a>
      </div>
    </div>
  </footer>

  <script src="maximus.js"></script>
  <script>
    // Image Data Management System
    class ImageDataManager {
      constructor() {
        this.cache = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
        this.retryAttempts = 3;
        this.retryDelay = 1000; // 1 second
      }

      // Main method to fetch all images from multiple sources
      async fetchAllImages() {
        const sources = [
          this.fetchNASAImages(),
          this.fetchESAImages(),
          this.fetchSpaceXImages(),
          this.fetchISSImages(),
          this.fetchAPOD()
        ];

        try {
          const results = await Promise.allSettled(sources);
          const allImages = [];

          results.forEach((result, index) => {
            if (result.status === 'fulfilled' && result.value) {
              if (Array.isArray(result.value)) {
                allImages.push(...result.value);
              } else {
                allImages.push(result.value);
              }
            } else {
              console.warn(`Source ${index} failed:`, result.reason);
            }
          });

          return this.combineAndSort(allImages);
        } catch (error) {
          console.error('Error fetching images:', error);
          return this.getFallbackImages();
        }
      }

      // Enhanced NASA Image and Video Library API
      async fetchNASAImages() {
        const cacheKey = 'nasa_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch multiple NASA collections for diverse content
          const queries = [
            'mars rover perseverance',
            'hubble telescope',
            'james webb telescope',
            'earth from space',
            'jupiter saturn planets',
            'nebula galaxy stars'
          ];

          const allImages = [];

          for (const query of queries) {
            try {
              const response = await this.fetchWithRetry(
                `https://images-api.nasa.gov/search?q=${encodeURIComponent(query)}&media_type=image&page_size=5&year_start=2020`
              );

              if (response.ok) {
                const data = await response.json();
                const images = data.collection.items
                  .filter(item => item.links && item.links.length > 0)
                  .map(item => this.parseNASAImage(item))
                  .filter(img => img.imageUrl && !img.imageUrl.includes('placeholder'));

                allImages.push(...images);
              }
            } catch (queryError) {
              console.warn(`NASA query failed for "${query}":`, queryError);
            }
          }

          // Remove duplicates and limit results
          const uniqueImages = this.removeDuplicates(allImages).slice(0, 15);

          this.setCache(cacheKey, uniqueImages);
          return uniqueImages.length > 0 ? uniqueImages : this.getNASAFallback();

        } catch (error) {
          console.error('NASA API error:', error);
          return this.getNASAFallback();
        }
      }

      // Enhanced NASA API response parsing
      parseNASAImage(item) {
        const data = item.data[0];
        const links = item.links || [];
        const imageLink = links.find(link => link.rel === 'preview') || links[0];

        // Clean and truncate description
        let description = data.description || 'Image from NASA';
        if (description.length > 200) {
          description = description.substring(0, 200) + '...';
        }

        // Clean title
        let title = data.title || 'NASA Image';
        if (title.length > 80) {
          title = title.substring(0, 80) + '...';
        }

        return {
          id: `nasa_${data.nasa_id}`,
          title: title,
          description: description,
          imageUrl: imageLink ? imageLink.href : this.getPlaceholderImage(),
          thumbnailUrl: imageLink ? imageLink.href : this.getPlaceholderImage(),
          source: 'nasa',
          category: this.categorizeNASAImage(data),
          timestamp: new Date(data.date_created || Date.now()),
          sourceUrl: `https://images.nasa.gov/details/${data.nasa_id}`,
          metadata: {
            nasaId: data.nasa_id,
            photographer: data.photographer,
            center: data.center,
            keywords: data.keywords || [],
            location: data.location,
            album: data.album,
            mediaType: data.media_type,
            attribution: this.getNASAAttribution(data)
          }
        };
      }

      // Generate proper NASA attribution
      getNASAAttribution(data) {
        let attribution = 'NASA';

        if (data.center) {
          attribution += `/${data.center}`;
        }

        if (data.photographer) {
          attribution += ` - ${data.photographer}`;
        }

        return attribution;
      }

      // Enhanced NASA image categorization
      categorizeNASAImage(data) {
        const title = (data.title || '').toLowerCase();
        const description = (data.description || '').toLowerCase();
        const keywords = (data.keywords || []).join(' ').toLowerCase();
        const content = `${title} ${description} ${keywords}`;

        // Mission-related content
        const missionTerms = ['mars', 'rover', 'perseverance', 'curiosity', 'opportunity', 'mission', 'launch', 'spacecraft', 'probe', 'lander', 'orbiter', 'apollo', 'artemis'];
        if (missionTerms.some(term => content.includes(term))) {
          return 'missions';
        }

        // Earth observation
        const earthTerms = ['earth', 'planet earth', 'blue marble', 'landsat', 'terra', 'aqua', 'modis', 'hurricane', 'weather', 'climate'];
        if (earthTerms.some(term => content.includes(term))) {
          return 'earth';
        }

        // Planetary content
        const planetTerms = ['jupiter', 'saturn', 'venus', 'mercury', 'uranus', 'neptune', 'planet', 'rings', 'moons', 'europa', 'titan', 'io', 'ganymede'];
        if (planetTerms.some(term => content.includes(term))) {
          return 'planets';
        }

        // Deep space objects
        const deepSpaceTerms = ['nebula', 'galaxy', 'star', 'constellation', 'hubble', 'webb', 'telescope', 'supernova', 'black hole', 'quasar', 'pulsar', 'cosmic', 'universe'];
        if (deepSpaceTerms.some(term => content.includes(term))) {
          return 'deep-space';
        }

        // ISS and space station content
        const issTerms = ['iss', 'international space station', 'space station', 'expedition', 'spacewalk', 'eva', 'crew', 'astronaut'];
        if (issTerms.some(term => content.includes(term))) {
          return 'iss';
        }

        // Default to missions for space-related content
        return 'missions';
      }

      // Enhanced ESA Images (European Space Agency)
      async fetchESAImages() {
        const cacheKey = 'esa_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // ESA doesn't have a public API, but we can try their RSS feed
          // For now, we'll use enhanced curated content with real ESA imagery
          const images = this.getESAEnhancedContent();
          this.setCache(cacheKey, images);
          return images;
        } catch (error) {
          console.error('ESA content error:', error);
          return this.getESAFallback();
        }
      }

      // Enhanced ESA content with real imagery
      getESAEnhancedContent() {
        const baseTime = Date.now();

        return [
          {
            id: 'esa_gaia_1',
            title: 'Gaia\'s Stellar Census of the Milky Way',
            description: 'ESA\'s Gaia mission has created the most detailed 3D map of our galaxy, revealing the positions and motions of nearly 2 billion stars.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/06/gaia_s_stellar_motion_for_the_next_400_000_years/24302366-1-eng-GB/Gaia_s_stellar_motion_for_the_next_400_000_years_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/06/gaia_s_stellar_motion_for_the_next_400_000_years/24302366-1-eng-GB/Gaia_s_stellar_motion_for_the_next_400_000_years_pillars.jpg',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 3 * 60 * 60 * 1000), // 3 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Gaia',
            metadata: {
              mission: 'Gaia',
              type: 'Stellar Cartography',
              attribution: 'ESA/Gaia/DPAC'
            }
          },
          {
            id: 'esa_jwst_1',
            title: 'Webb Telescope - ESA Partnership',
            description: 'The James Webb Space Telescope, a collaboration between NASA, ESA, and CSA, continues to revolutionize our understanding of the cosmos.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/07/webb_s_first_deep_field/24317738-1-eng-GB/Webb_s_first_deep_field_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/07/webb_s_first_deep_field/24317738-1-eng-GB/Webb_s_first_deep_field_pillars.jpg',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 5 * 60 * 60 * 1000), // 5 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Webb',
            metadata: {
              mission: 'James Webb Space Telescope',
              type: 'Deep Field',
              attribution: 'NASA/ESA/CSA/STScI'
            }
          },
          {
            id: 'esa_mars_1',
            title: 'Mars Express - Red Planet Explorer',
            description: 'ESA\'s Mars Express continues its mission to study the Red Planet, providing crucial data about Mars\' atmosphere and surface.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2023/01/mars_express_image_of_mars/24675234-1-eng-GB/Mars_Express_image_of_Mars_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2023/01/mars_express_image_of_mars/24675234-1-eng-GB/Mars_Express_image_of_Mars_pillars.jpg',
            source: 'esa',
            category: 'planets',
            timestamp: new Date(baseTime - 7 * 60 * 60 * 1000), // 7 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Mars_Express',
            metadata: {
              mission: 'Mars Express',
              type: 'Planetary Observation',
              attribution: 'ESA/DLR/FU Berlin'
            }
          }
        ];
      }

      // Enhanced SpaceX API Integration
      async fetchSpaceXImages() {
        const cacheKey = 'spacex_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch multiple recent launches for more content
          const [latestResponse, recentResponse] = await Promise.all([
            this.fetchWithRetry('https://api.spacexdata.com/v4/launches/latest'),
            this.fetchWithRetry('https://api.spacexdata.com/v4/launches/query', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: {
                  success: true,
                  'links.flickr.original': { $ne: [] }
                },
                options: {
                  limit: 5,
                  sort: { date_utc: -1 },
                  populate: ['rocket', 'payloads']
                }
              })
            })
          ]);

          const allImages = [];

          // Process latest launch
          if (latestResponse.ok) {
            const latestLaunch = await latestResponse.json();
            const latestImages = this.parseSpaceXLaunch(latestLaunch);
            allImages.push(...latestImages);
          }

          // Process recent launches
          if (recentResponse.ok) {
            const recentData = await recentResponse.json();
            if (recentData.docs) {
              recentData.docs.forEach(launch => {
                const launchImages = this.parseSpaceXLaunch(launch);
                allImages.push(...launchImages);
              });
            }
          }

          // Remove duplicates and limit results
          const uniqueImages = this.removeDuplicates(allImages).slice(0, 8);

          this.setCache(cacheKey, uniqueImages);
          return uniqueImages.length > 0 ? uniqueImages : this.getSpaceXFallback();

        } catch (error) {
          console.error('SpaceX API error:', error);
          return this.getSpaceXFallback();
        }
      }

      // Enhanced SpaceX launch data parsing
      parseSpaceXLaunch(launch) {
        const images = [];

        if (launch.links && launch.links.flickr && launch.links.flickr.original && launch.links.flickr.original.length > 0) {
          const rocketName = launch.rocket?.name || 'Falcon 9';
          const flightNumber = launch.flight_number || 'Unknown';

          // Limit to 3 images per launch to avoid overwhelming
          const imageUrls = launch.links.flickr.original.slice(0, 3);

          imageUrls.forEach((imageUrl, index) => {
            let description = launch.details || `SpaceX ${launch.name} mission launch`;

            // Enhance description with mission details
            if (launch.payloads && launch.payloads.length > 0) {
              const payloadNames = launch.payloads.map(p => p.name || 'payload').join(', ');
              description += ` carrying ${payloadNames}`;
            }

            // Truncate long descriptions
            if (description.length > 200) {
              description = description.substring(0, 200) + '...';
            }

            images.push({
              id: `spacex_${launch.id}_${index}`,
              title: `${launch.name} - Flight ${flightNumber}`,
              description: description,
              imageUrl: imageUrl,
              thumbnailUrl: imageUrl,
              source: 'spacex',
              category: 'missions',
              timestamp: new Date(launch.date_utc),
              sourceUrl: launch.links.webcast || launch.links.wikipedia || 'https://www.spacex.com',
              metadata: {
                mission: launch.name,
                rocket: rocketName,
                success: launch.success,
                flightNumber: flightNumber,
                launchpad: launch.launchpad,
                payloads: launch.payloads?.map(p => p.name).join(', ') || 'Unknown',
                attribution: 'SpaceX'
              }
            });
          });
        }

        return images;
      }

      // Enhanced ISS Images (International Space Station)
      async fetchISSImages() {
        const cacheKey = 'iss_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Try to get ISS position for context
          const issPosition = await this.getISSPosition();

          // Generate ISS content with current position context
          const images = this.getISSEnhancedContent(issPosition);
          this.setCache(cacheKey, images);
          return images;
        } catch (error) {
          console.error('ISS content error:', error);
          return this.getISSFallback();
        }
      }

      // Get current ISS position
      async getISSPosition() {
        try {
          const response = await this.fetchWithRetry('http://api.open-notify.org/iss-now.json');
          if (response.ok) {
            const data = await response.json();
            return {
              latitude: parseFloat(data.iss_position.latitude),
              longitude: parseFloat(data.iss_position.longitude),
              timestamp: data.timestamp
            };
          }
        } catch (error) {
          console.warn('ISS position API unavailable:', error);
        }
        return null;
      }

      // Enhanced ISS content with position context
      getISSEnhancedContent(issPosition) {
        const baseTime = Date.now();
        const locationContext = issPosition ?
          `Currently over ${this.getLocationFromCoords(issPosition.latitude, issPosition.longitude)}` :
          'Orbiting Earth at 408 km altitude';

        return [
          {
            id: 'iss_earth_1',
            title: 'Earth from the International Space Station',
            description: `A stunning view of Earth captured from the ISS. ${locationContext}. The station completes an orbit every 90 minutes, providing astronauts with breathtaking views of our planet.`,
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            source: 'iss',
            category: 'earth',
            timestamp: new Date(baseTime - 45 * 60 * 1000), // 45 minutes ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              altitude: '408 km',
              crew: 'Expedition 70',
              attribution: 'NASA/ISS Expedition Crew',
              coordinates: issPosition
            }
          },
          {
            id: 'iss_aurora_1',
            title: 'Aurora Borealis from Space',
            description: 'A spectacular aurora borealis captured from the International Space Station, showing the dancing lights of charged particles interacting with Earth\'s magnetic field.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(baseTime - 2 * 60 * 60 * 1000), // 2 hours ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              phenomenon: 'Aurora Borealis',
              attribution: 'NASA/ISS Expedition Crew'
            }
          },
          {
            id: 'iss_spacewalk_1',
            title: 'Spacewalk Outside the ISS',
            description: 'Astronauts conducting a spacewalk (EVA) outside the International Space Station for maintenance and scientific experiments.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss067e000001/iss067e000001~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss067e000001/iss067e000001~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(baseTime - 4 * 60 * 60 * 1000), // 4 hours ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              activity: 'Spacewalk (EVA)',
              attribution: 'NASA/ISS Expedition Crew'
            }
          }
        ];
      }

      // Simple location approximation from coordinates
      getLocationFromCoords(lat, lon) {
        // Simplified location detection - in a real app, you'd use a geocoding service
        if (lat > 60) return 'the Arctic region';
        if (lat < -60) return 'Antarctica';
        if (lat > 30 && lon > -30 && lon < 60) return 'Europe/Asia';
        if (lat > 30 && lon > -130 && lon < -60) return 'North America';
        if (lat < -30 && lon > 110 && lon < 180) return 'Australia/Oceania';
        if (lat < 30 && lat > -30 && lon > -90 && lon < -30) return 'South America';
        if (lat < 30 && lat > -30 && lon > -20 && lon < 50) return 'Africa';
        return 'the Pacific Ocean';
      }

      // Enhanced NASA Astronomy Picture of the Day
      async fetchAPOD() {
        const cacheKey = 'nasa_apod';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch current APOD and recent ones for more content
          const today = new Date();
          const dates = [];

          // Get last 5 days of APOD
          for (let i = 0; i < 5; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            dates.push(date.toISOString().split('T')[0]);
          }

          const apodImages = [];

          for (const date of dates) {
            try {
              const response = await this.fetchWithRetry(
                `https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&date=${date}`
              );

              if (response.ok) {
                const data = await response.json();

                if (data.media_type === 'image' && data.url) {
                  // Truncate long descriptions
                  let description = data.explanation || 'Astronomy Picture of the Day from NASA';
                  if (description.length > 300) {
                    description = description.substring(0, 300) + '...';
                  }

                  const image = {
                    id: `apod_${data.date}`,
                    title: `APOD: ${data.title}`,
                    description: description,
                    imageUrl: data.hdurl || data.url,
                    thumbnailUrl: data.url,
                    source: 'nasa',
                    category: 'deep-space',
                    timestamp: new Date(data.date),
                    sourceUrl: `https://apod.nasa.gov/apod/ap${data.date.replace(/-/g, '').substring(2)}.html`,
                    metadata: {
                      copyright: data.copyright,
                      type: 'APOD',
                      date: data.date,
                      attribution: data.copyright ? `Â© ${data.copyright}` : 'NASA APOD',
                      hdUrl: data.hdurl
                    }
                  };

                  apodImages.push(image);
                }
              }
            } catch (dateError) {
              console.warn(`APOD fetch failed for ${date}:`, dateError);
            }
          }

          this.setCache(cacheKey, apodImages);
          return apodImages;

        } catch (error) {
          console.error('APOD API error:', error);
          return this.getAPODFallback();
        }
      }

      // APOD fallback data
      getAPODFallback() {
        return [
          {
            id: 'apod_fallback_1',
            title: 'APOD: Webb\'s First Deep Field',
            description: 'NASA\'s James Webb Space Telescope has delivered the deepest and sharpest infrared image of the distant universe so far.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg',
            source: 'nasa',
            category: 'deep-space',
            timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000), // 5 hours ago
            sourceUrl: 'https://apod.nasa.gov/',
            metadata: {
              type: 'APOD',
              attribution: 'NASA/ESA/CSA/STScI'
            }
          }
        ];
      }

      // Combine and sort images from all sources
      combineAndSort(imageArrays) {
        const allImages = imageArrays.flat();

        // Remove duplicates based on title similarity
        const uniqueImages = this.removeDuplicates(allImages);

        // Sort by timestamp (newest first)
        return uniqueImages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }

      // Remove duplicate images
      removeDuplicates(images) {
        const seen = new Set();
        return images.filter(image => {
          const key = image.title.toLowerCase().replace(/[^a-z0-9]/g, '');
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      // Filter images by category
      filterByCategory(images, category) {
        if (category === 'all') return images;
        return images.filter(image => image.category === category);
      }

      // Fetch with retry logic
      async fetchWithRetry(url, attempts = this.retryAttempts) {
        for (let i = 0; i < attempts; i++) {
          try {
            const response = await fetch(url);
            if (response.ok) return response;
            throw new Error(`HTTP ${response.status}`);
          } catch (error) {
            if (i === attempts - 1) throw error;
            await this.delay(this.retryDelay * Math.pow(2, i)); // Exponential backoff
          }
        }
      }

      // Utility methods
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      getFromCache(key) {
        const cached = this.cache.get(key);
        if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
          return cached.data;
        }
        return null;
      }

      setCache(key, data) {
        this.cache.set(key, {
          data: data,
          timestamp: Date.now()
        });
      }

      getPlaceholderImage() {
        return 'https://via.placeholder.com/400x225/0033a0/ffffff?text=Space+Image';
      }

      // Fallback data when APIs are unavailable
      getFallbackImages() {
        return [
          ...this.getNASAFallback(),
          ...this.getESAFallback(),
          ...this.getSpaceXFallback(),
          ...this.getISSFallback()
        ];
      }

      getNASAFallback() {
        return [
          {
            id: 'nasa_fallback_1',
            title: 'Perseverance Mars Rover Self-Portrait',
            description: 'NASA\'s Perseverance rover took this selfie over a rock nicknamed "Rochette," on Sol 198.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg',
            source: 'nasa',
            category: 'missions',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            sourceUrl: 'https://images.nasa.gov/',
            metadata: { mission: 'Mars 2020' }
          },
          {
            id: 'nasa_fallback_2',
            title: 'Hubble Views the Crab Nebula',
            description: 'This Hubble Space Telescope image shows the Crab Nebula, the result of a supernova explosion.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg',
            source: 'nasa',
            category: 'deep-space',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
            sourceUrl: 'https://images.nasa.gov/',
            metadata: { telescope: 'Hubble' }
          }
        ];
      }

      getESAFallback() {
        const baseTime = Date.now();
        return [
          {
            id: 'esa_fallback_1',
            title: 'Gaia\'s Stellar Census',
            description: 'ESA\'s Gaia mission has created the most detailed 3D map of our galaxy, cataloging nearly 2 billion stars.',
            imageUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Gaia+Mission',
            thumbnailUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Gaia+Mission',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 6 * 60 * 60 * 1000), // 6 hours ago
            sourceUrl: 'https://www.esa.int/',
            metadata: {
              mission: 'Gaia',
              type: 'Stellar Cartography',
              attribution: 'ESA/Gaia/DPAC'
            }
          },
          {
            id: 'esa_fallback_2',
            title: 'BepiColombo Mercury Mission',
            description: 'ESA\'s BepiColombo mission continues its journey to Mercury, studying the innermost planet of our solar system.',
            imageUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+BepiColombo',
            thumbnailUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+BepiColombo',
            source: 'esa',
            category: 'missions',
            timestamp: new Date(baseTime - 8 * 60 * 60 * 1000), // 8 hours ago
            sourceUrl: 'https://www.esa.int/',
            metadata: {
              mission: 'BepiColombo',
              target: 'Mercury',
              attribution: 'ESA/JAXA'
            }
          }
        ];
      }

      getSpaceXFallback() {
        const baseTime = Date.now();
        return [
          {
            id: 'spacex_fallback_1',
            title: 'Falcon Heavy - Arabsat-6A Mission',
            description: 'SpaceX Falcon Heavy rocket launches the Arabsat-6A communications satellite, demonstrating the power of reusable rocket technology.',
            imageUrl: 'https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg',
            source: 'spacex',
            category: 'missions',
            timestamp: new Date(baseTime - 3 * 60 * 60 * 1000), // 3 hours ago
            sourceUrl: 'https://www.spacex.com/',
            metadata: {
              rocket: 'Falcon Heavy',
              mission: 'Arabsat-6A',
              attribution: 'SpaceX'
            }
          },
          {
            id: 'spacex_fallback_2',
            title: 'Starship Development Test',
            description: 'SpaceX continues development of Starship, the next-generation spacecraft designed for missions to Mars and beyond.',
            imageUrl: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Starship',
            thumbnailUrl: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Starship',
            source: 'spacex',
            category: 'missions',
            timestamp: new Date(baseTime - 6 * 60 * 60 * 1000), // 6 hours ago
            sourceUrl: 'https://www.spacex.com/',
            metadata: {
              rocket: 'Starship',
              mission: 'Development Test',
              attribution: 'SpaceX'
            }
          }
        ];
      }

      getISSFallback() {
        return [
          {
            id: 'iss_fallback_1',
            title: 'Earth from the International Space Station',
            description: 'A stunning view of Earth\'s curvature captured from the International Space Station.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            source: 'iss',
            category: 'earth',
            timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000), // 1 hour ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/',
            metadata: { location: 'ISS' }
          },
          {
            id: 'iss_fallback_2',
            title: 'Aurora from Space',
            description: 'A spectacular aurora borealis captured from the International Space Station.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/',
            metadata: { location: 'ISS', phenomenon: 'Aurora' }
          }
        ];
      }
    }

    // Initialize the data manager
    const imageDataManager = new ImageDataManager();

    // Global image data store for interaction handling
    let currentImageData = [];

    // Performance monitoring
    const performanceMonitor = {
      startTime: Date.now(),
      imageLoadTimes: [],

      recordImageLoad(startTime, endTime, success = true) {
        this.imageLoadTimes.push({
          duration: endTime - startTime,
          success: success,
          timestamp: Date.now()
        });
      },

      getAverageLoadTime() {
        const successfulLoads = this.imageLoadTimes.filter(load => load.success);
        if (successfulLoads.length === 0) return 0;

        const total = successfulLoads.reduce((sum, load) => sum + load.duration, 0);
        return Math.round(total / successfulLoads.length);
      },

      getLoadSuccessRate() {
        if (this.imageLoadTimes.length === 0) return 100;

        const successful = this.imageLoadTimes.filter(load => load.success).length;
        return Math.round((successful / this.imageLoadTimes.length) * 100);
      },

      logPerformanceStats() {
        console.log('ðŸš€ Performance Stats:', {
          averageImageLoadTime: `${this.getAverageLoadTime()}ms`,
          loadSuccessRate: `${this.getLoadSuccessRate()}%`,
          totalImagesLoaded: this.imageLoadTimes.length,
          pageLoadTime: `${Date.now() - this.startTime}ms`
        });
      }
    };
  </script>
  <script>
    (function initTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") { document.body.classList.add("dark"); document.getElementById("themeToggle").textContent = "â˜€ï¸"; }
      document.getElementById("themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        document.getElementById("themeToggle").textContent = isDark ? "â˜€ï¸" : "ðŸŒ™";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });
    })();

    (function stickyDropdowns() {
      const OPEN = "open"; const DELAY = 160;
      document.querySelectorAll(".dropdown").forEach(dd => {
        let t = null; const btn = dd.querySelector(".dropbtn"); const menu = dd.querySelector(".dropdown-content");
        function open() { dd.classList.add(OPEN); btn?.setAttribute("aria-expanded", "true"); if (t) { clearTimeout(t); t = null; } }
        function close() { if (t) clearTimeout(t); t = setTimeout(() => { dd.classList.remove(OPEN); btn?.setAttribute("aria-expanded", "false"); }, DELAY); }
        dd.addEventListener("pointerenter", open); dd.addEventListener("pointerleave", close);
        btn?.addEventListener("focus", open);
        menu?.addEventListener("focusout", e => { if (!dd.contains(e.relatedTarget)) close(); });
        menu?.querySelectorAll("a").forEach(a => { a.addEventListener("click", () => { menu.querySelectorAll("a").forEach(el => el.classList.remove("clicked")); a.classList.add("clicked"); dd.classList.remove(OPEN); btn?.setAttribute("aria-expanded", "false"); }); });
      });
    })();

    (function initMoonPhase() {
      function getMoonPhase() {
        const now = new Date(); const m = now.getMonth() + 1; const d = now.getDate(); const y = now.getFullYear();
        if (y === 2025 && m === 8) {
          if (d <= 3) return 7; if (d <= 6) return 0; if (d <= 10) return 1; if (d <= 13) return 2; if (d <= 17) return 3; if (d <= 20) return 4; if (d <= 24) return 5; if (d <= 27) return 6; return 7;
        }
        const base = new Date(2024, 7, 4); const days = (now - base) / (1000 * 60 * 60 * 24); const cycle = days / 29.53; return Math.floor((cycle - Math.floor(cycle)) * 8) % 8;
      }
      function info(p) { return [{ name: "New Moon", emoji: "ðŸŒ‘" }, { name: "Waxing Crescent", emoji: "ðŸŒ’" }, { name: "First Quarter", emoji: "ðŸŒ“" }, { name: "Waxing Gibbous", emoji: "ðŸŒ”" }, { name: "Full Moon", emoji: "ðŸŒ•" }, { name: "Waning Gibbous", emoji: "ðŸŒ–" }, { name: "Last Quarter", emoji: "ðŸŒ—" }, { name: "Waning Crescent", emoji: "ðŸŒ˜" }][p]; }
      const phase = getMoonPhase(), data = info(phase), now = new Date();
      document.getElementById("moon-display").textContent = data.emoji;
      document.querySelector(".moon-label").textContent = data.name;
      document.getElementById("moon-context").textContent = `${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} â€¢ New York City, NY`;
    })();

    // Enhanced Image Modal System
    (function initImageModal() {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const modalTitle = document.querySelector('.modal-title');
      const modalDescription = document.querySelector('.modal-description');
      const modalSource = document.querySelector('.modal-source');
      const modalDate = document.querySelector('.modal-date');
      const modalCategory = document.querySelector('.modal-category');
      const modalMission = document.querySelector('.modal-mission');
      const modalMissionName = document.querySelector('.modal-mission-name');
      const modalInstrument = document.querySelector('.modal-instrument');
      const modalInstrumentName = document.querySelector('.modal-instrument-name');
      const modalLocation = document.querySelector('.modal-location');
      const modalLocationName = document.querySelector('.modal-location-name');
      const modalTechnicalInfo = document.querySelector('.modal-technical-info');
      const modalResolution = document.querySelector('.modal-resolution');
      const modalResolutionValue = document.querySelector('.modal-resolution-value');
      const modalCoordinates = document.querySelector('.modal-coordinates');
      const modalCoordinatesValue = document.querySelector('.modal-coordinates-value');
      const modalAltitude = document.querySelector('.modal-altitude');
      const modalAltitudeValue = document.querySelector('.modal-altitude-value');
      const modalKeywords = document.querySelector('.modal-keywords');
      const keywordsContainer = document.querySelector('.keywords-container');
      const modalAttribution = document.querySelector('.modal-attribution');
      const modalSourceLink = document.getElementById('modal-source-link');
      const modalLoading = document.querySelector('.modal-loading');

      const closeBtn = document.querySelector('.modal-close');
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      const shareBtn = document.getElementById('modal-share');
      const downloadBtn = document.getElementById('modal-download');
      const favoriteBtn = document.getElementById('modal-favorite');
      const fullscreenBtn = document.getElementById('modal-fullscreen');
      const infoToggleBtn = document.getElementById('modal-info-toggle');
      const socialShareMenu = document.getElementById('social-share-menu');

      let currentImageIndex = 0;
      let filteredImages = [];

      // Open modal with image data
      function openModal(imageId) {
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        // Get current filtered images for navigation
        filteredImages = getCurrentFilteredImages();
        currentImageIndex = filteredImages.findIndex(img => img.id === imageId);

        // Show modal
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        modal.setAttribute('aria-hidden', 'false');

        // Load image data
        loadModalImage(imageData);

        // Update navigation buttons
        updateNavigationButtons();

        // Focus management
        closeBtn.focus();
      }

      // Load image and metadata into modal
      function loadModalImage(imageData) {
        // Show loading state
        modalLoading.style.display = 'flex';
        modalImage.style.opacity = '0';

        // Load high-resolution image
        const highResImage = new Image();

        highResImage.onload = function () {
          modalImage.src = imageData.imageUrl;
          modalImage.alt = imageData.title;
          modalLoading.style.display = 'none';
          modalImage.style.opacity = '1';
        };

        highResImage.onerror = function () {
          modalImage.src = imageData.thumbnailUrl;
          modalImage.alt = imageData.title;
          modalLoading.style.display = 'none';
          modalImage.style.opacity = '1';
        };

        // Start loading
        highResImage.src = imageData.imageUrl;

        // Update metadata
        modalTitle.textContent = imageData.title;
        modalDescription.textContent = imageData.description;
        modalSource.textContent = imageData.source.toUpperCase();
        modalDate.textContent = formatModalDate(imageData.timestamp);
        modalDate.setAttribute('datetime', imageData.timestamp.toISOString());
        modalCategory.textContent = formatCategory(imageData.category);

        // Update mission info if available
        if (imageData.metadata?.mission) {
          modalMission.style.display = 'block';
          modalMissionName.textContent = imageData.metadata.mission;
        } else {
          modalMission.style.display = 'none';
        }

        // Update instrument info if available
        if (imageData.metadata?.instrument) {
          modalInstrument.style.display = 'block';
          modalInstrumentName.textContent = imageData.metadata.instrument;
        } else {
          modalInstrument.style.display = 'none';
        }

        // Update location info if available
        if (imageData.metadata?.location) {
          modalLocation.style.display = 'block';
          modalLocationName.textContent = imageData.metadata.location;
        } else {
          modalLocation.style.display = 'none';
        }

        // Update technical information
        updateTechnicalInfo(imageData);

        // Update keywords
        updateKeywords(imageData);

        // Update attribution
        const attribution = imageData.metadata?.attribution || `${imageData.source.toUpperCase()}`;
        modalAttribution.textContent = attribution;

        // Update source link
        modalSourceLink.href = imageData.sourceUrl;

        // Update favorite status
        updateFavoriteStatus(imageData.id);

        // Store current image data for actions
        modal.dataset.currentImageId = imageData.id;
      }

      // Get currently filtered images
      function getCurrentFilteredImages() {
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
        if (activeFilter === 'all') {
          return currentImageData;
        }
        return currentImageData.filter(img => img.category === activeFilter);
      }

      // Update navigation button states
      function updateNavigationButtons() {
        prevBtn.disabled = currentImageIndex <= 0;
        nextBtn.disabled = currentImageIndex >= filteredImages.length - 1;
      }

      // Navigate to previous image
      function navigatePrevious() {
        if (currentImageIndex > 0) {
          currentImageIndex--;
          const imageData = filteredImages[currentImageIndex];
          loadModalImage(imageData);
          updateNavigationButtons();
        }
      }

      // Navigate to next image
      function navigateNext() {
        if (currentImageIndex < filteredImages.length - 1) {
          currentImageIndex++;
          const imageData = filteredImages[currentImageIndex];
          loadModalImage(imageData);
          updateNavigationButtons();
        }
      }

      // Close modal
      function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        modal.setAttribute('aria-hidden', 'true');

        // Clear image source to save memory
        setTimeout(() => {
          modalImage.src = '';
        }, 300);
      }

      // Format date for modal display
      function formatModalDate(timestamp) {
        return new Date(timestamp).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Format category for display
      function formatCategory(category) {
        const categoryMap = {
          'missions': 'Space Missions',
          'deep-space': 'Deep Space',
          'earth': 'Earth Observation',
          'planets': 'Planetary Science',
          'iss': 'International Space Station'
        };
        return categoryMap[category] || category;
      }

      // Share functionality
      function shareImage() {
        const imageId = modal.dataset.currentImageId;
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        const shareData = {
          title: imageData.title,
          text: `Check out this amazing space image: ${imageData.title}`,
          url: `${window.location.href}#image-${imageId}`
        };

        if (navigator.share) {
          navigator.share(shareData);
        } else {
          // Fallback: copy to clipboard
          const shareText = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
          navigator.clipboard.writeText(shareText).then(() => {
            showToast('Link copied to clipboard!');
          }).catch(() => {
            // Final fallback: show share text
            prompt('Copy this link to share:', shareData.url);
          });
        }
      }

      // Download functionality
      function downloadImage() {
        const imageId = modal.dataset.currentImageId;
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        const link = document.createElement('a');
        link.href = imageData.imageUrl;
        link.download = `${imageData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Update technical information
      function updateTechnicalInfo(imageData) {
        let hasInfo = false;

        // Resolution info
        if (imageData.metadata?.resolution) {
          modalResolution.style.display = 'block';
          modalResolutionValue.textContent = imageData.metadata.resolution;
          hasInfo = true;
        } else {
          modalResolution.style.display = 'none';
        }

        // Coordinates info (for ISS images)
        if (imageData.metadata?.coordinates) {
          modalCoordinates.style.display = 'block';
          const coords = imageData.metadata.coordinates;
          modalCoordinatesValue.textContent = `${coords.latitude.toFixed(2)}Â°, ${coords.longitude.toFixed(2)}Â°`;
          hasInfo = true;
        } else {
          modalCoordinates.style.display = 'none';
        }

        // Altitude info (for ISS images)
        if (imageData.metadata?.altitude) {
          modalAltitude.style.display = 'block';
          modalAltitudeValue.textContent = imageData.metadata.altitude;
          hasInfo = true;
        } else {
          modalAltitude.style.display = 'none';
        }

        // Show/hide technical info section
        modalTechnicalInfo.style.display = hasInfo ? 'block' : 'none';
      }

      // Update keywords display
      function updateKeywords(imageData) {
        keywordsContainer.innerHTML = '';

        if (imageData.metadata?.keywords && imageData.metadata.keywords.length > 0) {
          imageData.metadata.keywords.forEach(keyword => {
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.textContent = keyword;
            keywordsContainer.appendChild(tag);
          });
          modalKeywords.style.display = 'block';
        } else {
          modalKeywords.style.display = 'none';
        }
      }

      // Favorites management
      function getFavorites() {
        return JSON.parse(localStorage.getItem('space-image-favorites') || '[]');
      }

      function addToFavorites(imageId) {
        const favorites = getFavorites();
        if (!favorites.includes(imageId)) {
          favorites.push(imageId);
          localStorage.setItem('space-image-favorites', JSON.stringify(favorites));
          showToast('Added to favorites!');
        }
      }

      function removeFromFavorites(imageId) {
        const favorites = getFavorites();
        const index = favorites.indexOf(imageId);
        if (index > -1) {
          favorites.splice(index, 1);
          localStorage.setItem('space-image-favorites', JSON.stringify(favorites));
          showToast('Removed from favorites');
        }
      }

      function updateFavoriteStatus(imageId) {
        const favorites = getFavorites();
        const isFavorite = favorites.includes(imageId);
        favoriteBtn.classList.toggle('active', isFavorite);
        favoriteBtn.title = isFavorite ? 'Remove from Favorites' : 'Add to Favorites';
      }

      // Toggle technical info visibility
      function toggleTechnicalInfo() {
        const isVisible = modalTechnicalInfo.style.display !== 'none';
        modalTechnicalInfo.style.display = isVisible ? 'none' : 'block';
        modalKeywords.style.display = isVisible ? 'none' : 'block';
        infoToggleBtn.classList.toggle('active', !isVisible);
      }

      // Fullscreen functionality
      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          modalImage.requestFullscreen().catch(err => {
            showToast('Fullscreen not supported');
          });
        } else {
          document.exitFullscreen();
        }
      }

      // Enhanced social sharing
      function shareToSocial(platform) {
        const imageId = modal.dataset.currentImageId;
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        const url = `${window.location.href}#image-${imageId}`;
        const text = `Check out this amazing space image: ${imageData.title}`;

        let shareUrl = '';

        switch (platform) {
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            break;
          case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            break;
          case 'reddit':
            shareUrl = `https://reddit.com/submit?title=${encodeURIComponent(imageData.title)}&url=${encodeURIComponent(url)}`;
            break;
          case 'copy':
            navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
              showToast('Link copied to clipboard!');
            });
            return;
        }

        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
      }

      // Toggle social share menu
      function toggleSocialShareMenu() {
        const isVisible = socialShareMenu.style.display !== 'none';
        socialShareMenu.style.display = isVisible ? 'none' : 'block';
      }

      // Show auto-refresh status
      function showAutoRefreshStatus(message, type = 'info') {
        const statusElement = document.getElementById('auto-refresh-status');
        const statusText = statusElement.querySelector('.status-text');

        statusText.textContent = message;
        statusElement.className = `auto-refresh-status visible ${type}`;

        // Auto-hide after 3 seconds
        setTimeout(() => {
          statusElement.classList.remove('visible');
        }, 3000);
      }

      // Show toast notification
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 2em;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 1em 2em;
          border-radius: 8px;
          z-index: 10002;
          font-size: 0.9em;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 3000);
      }

      // Event listeners
      document.addEventListener('click', function (e) {
        // Handle expand button clicks
        if (e.target.classList.contains('expand-btn')) {
          e.preventDefault();
          const imageId = e.target.dataset.imageId;
          openModal(imageId);
        }

        // Handle gallery share button clicks
        if (e.target.classList.contains('share-btn') && !e.target.id) {
          e.preventDefault();
          const imageId = e.target.dataset.imageId;
          const imageData = currentImageData.find(img => img.id === imageId);
          if (imageData) {
            const shareData = {
              title: imageData.title,
              text: `Check out this space image: ${imageData.title}`,
              url: window.location.href
            };

            if (navigator.share) {
              navigator.share(shareData);
            } else {
              navigator.clipboard.writeText(`${shareData.title} - ${shareData.url}`).then(() => {
                showToast('Link copied to clipboard!');
              });
            }
          }
        }
      });

      // Modal event listeners
      closeBtn.addEventListener('click', closeModal);
      prevBtn.addEventListener('click', navigatePrevious);
      nextBtn.addEventListener('click', navigateNext);
      shareBtn.addEventListener('click', toggleSocialShareMenu);
      downloadBtn.addEventListener('click', downloadImage);
      favoriteBtn.addEventListener('click', function () {
        const imageId = modal.dataset.currentImageId;
        const favorites = getFavorites();
        if (favorites.includes(imageId)) {
          removeFromFavorites(imageId);
        } else {
          addToFavorites(imageId);
        }
        updateFavoriteStatus(imageId);
      });
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      infoToggleBtn.addEventListener('click', toggleTechnicalInfo);

      // Social sharing event listeners
      document.addEventListener('click', function (e) {
        if (e.target.closest('.social-btn')) {
          const platform = e.target.closest('.social-btn').dataset.platform;
          shareToSocial(platform);
        }
      });

      // Close modal when clicking overlay
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', function (e) {
        if (modal.classList.contains('active')) {
          switch (e.key) {
            case 'Escape':
              closeModal();
              break;
            case 'ArrowLeft':
              navigatePrevious();
              break;
            case 'ArrowRight':
              navigateNext();
              break;
          }
        }

        // Handle expand/share button keyboard activation
        if (e.key === 'Enter' || e.key === ' ') {
          if (e.target.classList.contains('expand-btn') || e.target.classList.contains('share-btn')) {
            e.preventDefault();
            e.target.click();
          }
        }
      });
    })();

    // Filter and Controls Functionality
    (function initControls() {
      const gallery = document.getElementById('image-gallery');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const viewBtns = document.querySelectorAll('.view-btn');
      const refreshBtn = document.querySelector('.refresh-btn');
      const lastRefreshTime = document.getElementById('last-refresh');

      let currentFilter = 'all';
      let currentView = 'grid';
      let currentSearch = '';
      let currentSourceFilter = 'all';
      let currentDateFilter = 'all';
      let currentSort = 'date-desc';

      // Enhanced filter functionality
      function filterImages(category = currentFilter) {
        currentFilter = category;
        applyAllFilters();

        // Update active filter button
        filterBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === category);
        });
      }

      // Apply all active filters
      function applyAllFilters() {
        const cards = Array.from(gallery.querySelectorAll('.image-card'));
        let visibleCount = 0;

        cards.forEach(card => {
          const shouldShow = passesAllFilters(card);

          if (shouldShow) {
            card.style.display = 'block';
            card.style.animation = 'fadeIn 0.3s ease-in-out';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Sort visible cards
        sortVisibleCards();

        // Update results count
        updateResultsCount(visibleCount, cards.length);
      }

      // Check if card passes all active filters
      function passesAllFilters(card) {
        const cardCategory = card.dataset.category;
        const cardSource = card.dataset.source;
        const cardImageId = card.dataset.imageId;

        // Find image data for this card
        const imageData = currentImageData.find(img => img.id === cardImageId);
        if (!imageData) return false;

        // Category filter
        if (currentFilter !== 'all' && cardCategory !== currentFilter) {
          return false;
        }

        // Source filter
        if (currentSourceFilter !== 'all' && cardSource !== currentSourceFilter) {
          return false;
        }

        // Date filter
        if (!passesDateFilter(imageData)) {
          return false;
        }

        // Search filter
        if (currentSearch && !passesSearchFilter(imageData)) {
          return false;
        }

        return true;
      }

      // Check if image passes date filter
      function passesDateFilter(imageData) {
        if (currentDateFilter === 'all') return true;

        const imageDate = new Date(imageData.timestamp);
        const now = new Date();

        switch (currentDateFilter) {
          case 'today':
            return imageDate.toDateString() === now.toDateString();
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return imageDate >= weekAgo;
          case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            return imageDate >= monthAgo;
          default:
            return true;
        }
      }

      // Check if image passes search filter
      function passesSearchFilter(imageData) {
        if (!currentSearch) return true;

        const searchTerm = currentSearch.toLowerCase();
        const searchableText = [
          imageData.title,
          imageData.description,
          imageData.source,
          imageData.category,
          imageData.metadata?.mission || '',
          imageData.metadata?.instrument || '',
          imageData.metadata?.location || '',
          ...(imageData.metadata?.keywords || [])
        ].join(' ').toLowerCase();

        return searchableText.includes(searchTerm);
      }

      // Sort visible cards
      function sortVisibleCards() {
        const visibleCards = Array.from(gallery.querySelectorAll('.image-card[style*="block"]'));

        visibleCards.sort((a, b) => {
          const aData = currentImageData.find(img => img.id === a.dataset.imageId);
          const bData = currentImageData.find(img => img.id === b.dataset.imageId);

          if (!aData || !bData) return 0;

          switch (currentSort) {
            case 'date-desc':
              return new Date(bData.timestamp) - new Date(aData.timestamp);
            case 'date-asc':
              return new Date(aData.timestamp) - new Date(bData.timestamp);
            case 'title-asc':
              return aData.title.localeCompare(bData.title);
            case 'source-asc':
              return aData.source.localeCompare(bData.source);
            default:
              return 0;
          }
        });

        // Reorder DOM elements
        visibleCards.forEach(card => {
          gallery.appendChild(card);
        });
      }

      // Update results count display
      function updateResultsCount(visible, total) {
        let countElement = document.getElementById('results-count');
        if (!countElement) {
          countElement = document.createElement('div');
          countElement.id = 'results-count';
          countElement.className = 'results-count';
          gallery.parentNode.insertBefore(countElement, gallery);
        }

        if (visible === total) {
          countElement.textContent = `Showing all ${total} images`;
        } else {
          countElement.textContent = `Showing ${visible} of ${total} images`;
        }

        countElement.style.cssText = `
          text-align: center;
          margin-bottom: 1em;
          font-size: 0.9em;
          color: #666;
          font-style: italic;
        `;
      }

      // View switching functionality
      function switchView(view) {
        if (view === 'list') {
          gallery.classList.add('list-view');
        } else {
          gallery.classList.remove('list-view');
        }

        // Update active view button
        viewBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === view);
        });

        currentView = view;
      }

      // Enhanced refresh functionality
      async function refreshGallery() {
        const startTime = performance.now();
        refreshBtn.classList.add('spinning');

        try {
          // Fetch fresh data from all sources
          const images = await imageDataManager.fetchAllImages();

          // Check if we got new content
          const hasNewContent = images.length !== currentImageData.length ||
            images.some((img, index) => img.id !== currentImageData[index]?.id);

          // Update the gallery with new images
          await updateGalleryWithImages(images);

          updateLastRefreshTime();

          // Re-apply all filters to maintain state
          applyAllFilters();

          const endTime = performance.now();
          const refreshTime = Math.round(endTime - startTime);

          // Show success feedback
          const originalText = refreshBtn.title;
          refreshBtn.title = `Refreshed in ${refreshTime}ms`;
          setTimeout(() => {
            refreshBtn.title = originalText;
          }, 2000);

          // Show status for auto-refresh
          if (hasNewContent) {
            showAutoRefreshStatus(`Gallery updated with fresh content (${refreshTime}ms)`, 'success');
          } else {
            showAutoRefreshStatus(`No new content available (${refreshTime}ms)`, 'info');
          }

          return true; // Success

        } catch (error) {
          console.error('Refresh failed:', error);

          // Show error feedback
          const originalText = refreshBtn.title;
          refreshBtn.title = 'Refresh failed - try again';
          setTimeout(() => {
            refreshBtn.title = originalText;
          }, 3000);

          showAutoRefreshStatus('Refresh failed - check connection', 'error');

          throw error; // Re-throw for auto-refresh manager

        } finally {
          refreshBtn.classList.remove('spinning');
        }
      }

      // Update gallery with new image data
      async function updateGalleryWithImages(images) {
        // Store image data globally for interaction handling
        currentImageData = images;

        // Clear existing content
        gallery.innerHTML = '';

        // Add loading indicator
        gallery.innerHTML = '<div class="loading-message">Loading fresh space imagery...</div>';

        // Simulate loading delay for better UX
        await new Promise(resolve => setTimeout(resolve, 500));

        // Clear loading message
        gallery.innerHTML = '';

        // Create image cards from data with performance optimization
        const fragment = document.createDocumentFragment();

        images.forEach((imageData, index) => {
          const card = createImageCard(imageData, index);
          fragment.appendChild(card);
        });

        // Batch DOM update for better performance
        gallery.appendChild(fragment);

        // Reinitialize lazy loading for new images
        initializeLazyLoading();

        // Log NASA API integration success
        const nasaImages = images.filter(img => img.source === 'nasa');
        console.log(`NASA API Integration: Loaded ${nasaImages.length} images from NASA sources`);
      }

      // Enhanced image card creation with performance optimizations
      function createImageCard(imageData, index = 0) {
        const card = document.createElement('article');
        card.className = 'image-card';
        card.dataset.category = imageData.category;
        card.dataset.source = imageData.source;
        card.dataset.imageId = imageData.id;

        const timeAgo = getTimeAgo(imageData.timestamp);
        const attribution = imageData.metadata?.attribution || imageData.source.toUpperCase();

        // Add NASA-specific styling for APOD images
        const isAPOD = imageData.metadata?.type === 'APOD';
        const apodClass = isAPOD ? ' apod-image' : '';

        // Determine loading strategy based on position
        const isAboveFold = index < 4; // First 4 images are above fold
        const loadingStrategy = isAboveFold ? 'eager' : 'lazy';
        const priority = isAboveFold ? 'high' : 'low';

        // Optimize image URLs for different screen sizes
        const optimizedImageUrl = getOptimizedImageUrl(imageData.thumbnailUrl, imageData.imageUrl);
        const fallbackUrl = getImageFallback(imageData.source);

        card.innerHTML = `
          <div class="image-container${apodClass}">
            <img ${isAboveFold ? `src="${optimizedImageUrl}"` : `data-src="${optimizedImageUrl}"`}
                 alt="${escapeHtml(imageData.title)}" 
                 loading="${loadingStrategy}"
                 data-priority="${priority}"
                 data-source="${imageData.source}"
                 decoding="async"
                 onerror="this.src='${fallbackUrl}'; this.classList.add('error');">
            <div class="image-overlay">
              <button class="overlay-btn expand-btn" title="View Full Size" data-image-id="${imageData.id}">ðŸ”</button>
              <button class="overlay-btn share-btn" title="Share Image" data-image-id="${imageData.id}">ðŸ“¤</button>
            </div>
            ${isAPOD ? '<div class="apod-badge">APOD</div>' : ''}
          </div>
          <div class="image-info">
            <h3 class="image-title">${escapeHtml(imageData.title)}</h3>
            <p class="image-description">${escapeHtml(imageData.description)}</p>
            <div class="image-meta">
              <span class="source" title="${escapeHtml(attribution)}">${imageData.source.toUpperCase()}</span>
              <time class="timestamp" datetime="${imageData.timestamp.toISOString()}">${timeAgo}</time>
            </div>
            ${imageData.metadata?.copyright ? `<div class="image-attribution">Â© ${escapeHtml(imageData.metadata.copyright)}</div>` : ''}
          </div>
        `;

        return card;
      }

      // Optimize image URLs based on screen size and connection
      function getOptimizedImageUrl(thumbnailUrl, fullUrl) {
        // Check for mobile device
        const isMobile = window.innerWidth <= 768;
        
        // Check for high DPI displays
        const isHighDPI = window.devicePixelRatio > 1.5;
        
        // Check connection speed (if available)
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');
        
        // Mobile-specific optimizations
        if (isMobile) {
          // Always use thumbnails on slow connections
          if (isSlowConnection) {
            return thumbnailUrl;
          }
          
          // Use thumbnails on small screens even with fast connection
          if (window.innerWidth <= 480) {
            return thumbnailUrl;
          }
          
          // Use full resolution only for high DPI mobile displays with good connection
          if (isHighDPI && !isSlowConnection && fullUrl && fullUrl !== thumbnailUrl) {
            return fullUrl;
          }
          
          return thumbnailUrl;
        }
        
        // Desktop behavior (existing logic)
        if (isHighDPI && !isSlowConnection && fullUrl && fullUrl !== thumbnailUrl) {
          return fullUrl;
        }
        
        return thumbnailUrl;
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Calculate time ago string
      function getTimeAgo(timestamp) {
        const now = new Date();
        const diff = now - new Date(timestamp);
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (minutes < 60) {
          return minutes <= 1 ? 'just now' : `${minutes} minutes ago`;
        } else if (hours < 24) {
          return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
        } else {
          return days === 1 ? '1 day ago' : `${days} days ago`;
        }
      }

      // Enhanced lazy loading with performance optimizations
      function initializeLazyLoading() {
        if ('IntersectionObserver' in window) {
          // Create optimized intersection observer
          const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                loadImageWithOptimization(img, observer);
              }
            });
          }, {
            // Load images when they're 100px away from viewport
            rootMargin: '100px 0px',
            // Trigger when 10% of image is visible
            threshold: 0.1
          });

          // Observe all images that need lazy loading
          document.querySelectorAll('img[data-src], img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
          });

          // Store observer globally for cleanup
          window.lazyImageObserver = imageObserver;
        } else {
          // Fallback for older browsers
          loadAllImagesImmediately();
        }
      }

      // Enhanced image loading with performance monitoring
      function loadImageWithOptimization(img, observer) {
        const originalSrc = img.dataset.src || img.src;
        const loadStartTime = performance.now();

        // Create a new image element for preloading
        const imageLoader = new Image();

        // Add loading state
        img.classList.add('loading');

        // Set up performance monitoring
        const timeoutId = setTimeout(() => {
          console.warn('Image loading timeout:', originalSrc);
          performanceMonitor.recordImageLoad(loadStartTime, performance.now(), false);
        }, 10000); // 10 second timeout

        imageLoader.onload = function () {
          clearTimeout(timeoutId);
          const loadEndTime = performance.now();

          // Record successful load
          performanceMonitor.recordImageLoad(loadStartTime, loadEndTime, true);

          // Image loaded successfully
          img.src = originalSrc;
          img.classList.remove('loading');
          img.classList.add('loaded');

          // Remove data-src attribute
          if (img.dataset.src) {
            img.removeAttribute('data-src');
          }

          // Stop observing this image
          observer.unobserve(img);

          // Trigger fade-in animation with RAF for smooth performance
          requestAnimationFrame(() => {
            img.style.opacity = '1';
          });
        };

        imageLoader.onerror = function () {
          clearTimeout(timeoutId);
          const loadEndTime = performance.now();

          // Record failed load
          performanceMonitor.recordImageLoad(loadStartTime, loadEndTime, false);

          // Handle loading error
          img.classList.remove('loading');
          img.classList.add('error');

          // Set fallback image
          img.src = getImageFallback(img.dataset.source || 'nasa');
          img.alt = 'Image unavailable - ' + (img.alt || 'Space image');

          observer.unobserve(img);
        };

        // Optimize loading based on connection
        if (navigator.connection) {
          const connection = navigator.connection;
          if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
            // Add delay for slow connections to prevent overwhelming
            setTimeout(() => {
              imageLoader.src = originalSrc;
            }, 100);
          } else {
            imageLoader.src = originalSrc;
          }
        } else {
          imageLoader.src = originalSrc;
        }
      }

      // Fallback for browsers without IntersectionObserver
      function loadAllImagesImmediately() {
        document.querySelectorAll('img[data-src]').forEach(img => {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        });
      }

      // Get appropriate fallback image based on source
      function getImageFallback(source) {
        const fallbacks = {
          nasa: 'https://via.placeholder.com/400x225/0033a0/ffffff?text=NASA+Image+Unavailable',
          spacex: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Image+Unavailable',
          esa: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Image+Unavailable',
          iss: 'https://via.placeholder.com/400x225/28a745/ffffff?text=ISS+Image+Unavailable'
        };
        return fallbacks[source] || fallbacks.nasa;
      }

      // Update last refresh time
      function updateLastRefreshTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        lastRefreshTime.textContent = timeString;
      }

      // Search functionality
      const searchInput = document.getElementById('search-input');
      const searchClear = document.getElementById('search-clear');
      const searchSuggestions = document.getElementById('search-suggestions');
      const advancedToggle = document.getElementById('advanced-toggle');
      const sortToggle = document.getElementById('sort-toggle');
      const advancedFilters = document.getElementById('advanced-filters');
      const sortOptions = document.getElementById('sort-options');

      // Search input handling
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value.trim();
        searchClear.style.display = currentSearch ? 'block' : 'none';
        applyAllFilters();

        // Hide suggestions when typing
        if (currentSearch) {
          searchSuggestions.style.display = 'none';
        }
      });

      searchInput.addEventListener('focus', () => {
        if (!currentSearch) {
          searchSuggestions.style.display = 'block';
        }
      });

      searchInput.addEventListener('blur', () => {
        // Delay hiding to allow clicking suggestions
        setTimeout(() => {
          searchSuggestions.style.display = 'none';
        }, 200);
      });

      searchClear.addEventListener('click', () => {
        searchInput.value = '';
        currentSearch = '';
        searchClear.style.display = 'none';
        applyAllFilters();
        searchInput.focus();
      });

      // Search suggestions
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-btn')) {
          const searchTerm = e.target.dataset.search;
          searchInput.value = searchTerm;
          currentSearch = searchTerm;
          searchClear.style.display = 'block';
          searchSuggestions.style.display = 'none';
          applyAllFilters();
        }
      });

      // Advanced filters toggle
      advancedToggle.addEventListener('click', () => {
        const isVisible = advancedFilters.style.display !== 'none';
        advancedFilters.style.display = isVisible ? 'none' : 'block';
        advancedToggle.classList.toggle('active', !isVisible);
      });

      // Sort options toggle
      sortToggle.addEventListener('click', () => {
        const isVisible = sortOptions.style.display !== 'none';
        sortOptions.style.display = isVisible ? 'none' : 'block';
        sortToggle.classList.toggle('active', !isVisible);
      });

      // Source filter buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('source-filter-btn')) {
          currentSourceFilter = e.target.dataset.source;
          document.querySelectorAll('.source-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.source === currentSourceFilter);
          });
          applyAllFilters();
        }
      });

      // Date filter buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('date-filter-btn')) {
          currentDateFilter = e.target.dataset.range;
          document.querySelectorAll('.date-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.range === currentDateFilter);
          });
          applyAllFilters();
        }
      });

      // Sort buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('sort-btn')) {
          currentSort = e.target.dataset.sort;
          document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.sort === currentSort);
          });
          applyAllFilters();
        }
      });

      // Event listeners
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterImages(btn.dataset.filter);
        });
      });

      viewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          switchView(btn.dataset.view);
        });
      });

      refreshBtn.addEventListener('click', () => {
        autoRefreshManager.forceRefresh();
      });

      // Auto-refresh toggle
      const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
      autoRefreshToggle.addEventListener('click', () => {
        autoRefreshManager.toggle();
        autoRefreshToggle.classList.toggle('enabled', autoRefreshManager.isEnabled);
        autoRefreshToggle.textContent = autoRefreshManager.isEnabled ? 'Auto' : 'Manual';

        showAutoRefreshStatus(
          autoRefreshManager.isEnabled ? 'Auto-refresh enabled' : 'Auto-refresh disabled',
          autoRefreshManager.isEnabled ? 'success' : 'error'
        );
      });

      // Keyboard navigation for controls
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          if (e.target.classList.contains('filter-btn') ||
            e.target.classList.contains('view-btn') ||
            e.target.classList.contains('refresh-btn')) {
            e.preventDefault();
            e.target.click();
          }
        }
      });

      // Initialize
      updateLastRefreshTime();

      // Load initial data
      async function initializeGallery() {
        try {
          // Show loading state
          gallery.innerHTML = '<div class="loading-message">Loading space imagery from NASA, ESA, SpaceX, and ISS...</div>';

          // Fetch initial data
          const images = await imageDataManager.fetchAllImages();

          if (images.length > 0) {
            await updateGalleryWithImages(images);
          } else {
            // Show error if no images loaded
            gallery.innerHTML = '<div class="error-message">Unable to load images. Please check your connection and try refreshing.</div>';
          }
        } catch (error) {
          console.error('Failed to initialize gallery:', error);
          gallery.innerHTML = '<div class="error-message">Failed to load images. Please try refreshing the page.</div>';
        }
      }

      // Memory management and cleanup
      function cleanupResources() {
        // Clean up intersection observer
        if (window.lazyImageObserver) {
          window.lazyImageObserver.disconnect();
        }

        // Clear image cache periodically
        if (imageDataManager.cache.size > 50) {
          const oldestEntries = Array.from(imageDataManager.cache.entries())
            .sort((a, b) => a[1].timestamp - b[1].timestamp)
            .slice(0, 20);

          oldestEntries.forEach(([key]) => {
            imageDataManager.cache.delete(key);
          });

          console.log('ðŸ§¹ Cleaned up old cache entries');
        }
      }

      // Performance optimization: Cleanup on page visibility change
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          cleanupResources();
        } else if (document.visibilityState === 'visible') {
          // Log performance stats when page becomes visible
          performanceMonitor.logPerformanceStats();
        }
      });

      // Start initialization
      initializeGallery();

      // Enhanced Auto-Refresh System
      const autoRefreshManager = {
        interval: 5 * 60 * 1000, // 5 minutes default
        minInterval: 2 * 60 * 1000, // 2 minutes minimum
        maxInterval: 15 * 60 * 1000, // 15 minutes maximum
        currentInterval: 5 * 60 * 1000,
        intervalId: null,
        lastUserActivity: Date.now(),
        isEnabled: true,
        consecutiveFailures: 0,

        init() {
          this.startAutoRefresh();
          this.setupActivityTracking();
          this.setupVisibilityTracking();
          this.setupNetworkTracking();
        },

        startAutoRefresh() {
          this.stopAutoRefresh();
          this.intervalId = setInterval(() => {
            this.performAutoRefresh();
          }, this.currentInterval);

          console.log(`ðŸ”„ Auto-refresh started: ${this.currentInterval / 1000}s interval`);
        },

        stopAutoRefresh() {
          if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
          }
        },

        async performAutoRefresh() {
          if (!this.shouldRefresh()) {
            return;
          }

          console.log('ðŸ”„ Auto-refresh triggered');

          try {
            await refreshGallery();
            this.onRefreshSuccess();
          } catch (error) {
            this.onRefreshFailure(error);
          }
        },

        shouldRefresh() {
          // Don't refresh if disabled
          if (!this.isEnabled) {
            console.log('â¸ï¸ Auto-refresh disabled');
            return false;
          }

          // Don't refresh if page is not visible
          if (document.visibilityState !== 'visible') {
            console.log('ðŸ‘ï¸ Page not visible, skipping refresh');
            return false;
          }

          // Don't refresh if modal is open
          if (document.getElementById('image-modal').classList.contains('active')) {
            console.log('ðŸ–¼ï¸ Modal open, skipping refresh');
            return false;
          }

          // Don't refresh if performance is poor
          const avgLoadTime = performanceMonitor.getAverageLoadTime();
          if (avgLoadTime > 5000) {
            console.log('â³ Poor performance, skipping refresh');
            this.adjustInterval('increase');
            return false;
          }

          // Don't refresh if user was recently active
          const timeSinceActivity = Date.now() - this.lastUserActivity;
          if (timeSinceActivity < 30000) { // 30 seconds
            console.log('ðŸ‘† Recent user activity, skipping refresh');
            return false;
          }

          return true;
        },

        onRefreshSuccess() {
          this.consecutiveFailures = 0;

          // Improve interval if performance is good
          const avgLoadTime = performanceMonitor.getAverageLoadTime();
          if (avgLoadTime < 2000) {
            this.adjustInterval('decrease');
          }

          this.updateRefreshIndicator('success');
        },

        onRefreshFailure(error) {
          console.error('Auto-refresh failed:', error);
          this.consecutiveFailures++;

          // Increase interval after failures
          if (this.consecutiveFailures >= 2) {
            this.adjustInterval('increase');
          }

          // Disable after too many failures
          if (this.consecutiveFailures >= 5) {
            this.disable();
            showToast('Auto-refresh disabled due to repeated failures');
          }

          this.updateRefreshIndicator('error');
        },

        adjustInterval(direction) {
          const oldInterval = this.currentInterval;

          if (direction === 'increase') {
            this.currentInterval = Math.min(this.currentInterval * 1.5, this.maxInterval);
          } else if (direction === 'decrease') {
            this.currentInterval = Math.max(this.currentInterval * 0.8, this.minInterval);
          }

          if (this.currentInterval !== oldInterval) {
            console.log(`â±ï¸ Interval adjusted: ${oldInterval / 1000}s â†’ ${this.currentInterval / 1000}s`);
            this.startAutoRefresh(); // Restart with new interval
          }
        },

        setupActivityTracking() {
          const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

          events.forEach(event => {
            document.addEventListener(event, () => {
              this.lastUserActivity = Date.now();
            }, { passive: true });
          });
        },

        setupVisibilityTracking() {
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              console.log('ðŸ‘ï¸ Page visible, resuming auto-refresh');
              this.lastUserActivity = Date.now();

              // Check if we should refresh immediately after becoming visible
              const timeSinceLastRefresh = Date.now() - this.getLastRefreshTime();
              if (timeSinceLastRefresh > this.currentInterval) {
                setTimeout(() => this.performAutoRefresh(), 2000); // Small delay
              }
            } else {
              console.log('ðŸ‘ï¸ Page hidden, auto-refresh will pause');
            }
          });
        },

        setupNetworkTracking() {
          if ('connection' in navigator) {
            const connection = navigator.connection;

            const updateForConnection = () => {
              const effectiveType = connection.effectiveType;

              if (effectiveType === 'slow-2g' || effectiveType === '2g') {
                this.currentInterval = this.maxInterval;
                console.log('ðŸ“¶ Slow connection detected, using maximum interval');
              } else if (effectiveType === '4g') {
                this.currentInterval = this.minInterval;
                console.log('ðŸ“¶ Fast connection detected, using minimum interval');
              }

              this.startAutoRefresh();
            };

            connection.addEventListener('change', updateForConnection);
            updateForConnection(); // Initial setup
          }
        },

        getLastRefreshTime() {
          const lastRefreshElement = document.getElementById('last-refresh');
          const lastRefreshText = lastRefreshElement?.textContent;

          if (lastRefreshText && lastRefreshText !== '--' && lastRefreshText !== 'just now') {
            // Parse time from "3:45 PM" format
            const today = new Date();
            const [time, period] = lastRefreshText.split(' ');
            const [hours, minutes] = time.split(':').map(Number);

            let hour24 = hours;
            if (period === 'PM' && hours !== 12) hour24 += 12;
            if (period === 'AM' && hours === 12) hour24 = 0;

            const lastRefresh = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour24, minutes);
            return lastRefresh.getTime();
          }

          return Date.now() - this.currentInterval; // Assume it's time to refresh
        },

        updateRefreshIndicator(status) {
          const refreshBtn = document.querySelector('.refresh-btn');

          refreshBtn.classList.remove('success', 'error');

          if (status === 'success') {
            refreshBtn.classList.add('success');
            setTimeout(() => refreshBtn.classList.remove('success'), 2000);
          } else if (status === 'error') {
            refreshBtn.classList.add('error');
            setTimeout(() => refreshBtn.classList.remove('error'), 3000);
          }
        },

        enable() {
          this.isEnabled = true;
          this.consecutiveFailures = 0;
          this.startAutoRefresh();
          console.log('âœ… Auto-refresh enabled');
        },

        disable() {
          this.isEnabled = false;
          this.stopAutoRefresh();
          console.log('âŒ Auto-refresh disabled');
        },

        toggle() {
          if (this.isEnabled) {
            this.disable();
          } else {
            this.enable();
          }
        },

        forceRefresh() {
          console.log('ðŸ”„ Force refresh triggered');
          this.lastUserActivity = Date.now() - 60000; // Fake old activity
          this.performAutoRefresh();
        }
      };

      // Initialize auto-refresh system
      autoRefreshManager.init();

      // Mobile Touch Gesture System
      const mobileGestureManager = {
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        isDragging: false,
        isModalOpen: false,
        
        init() {
          if ('ontouchstart' in window) {
            this.setupTouchEvents();
            this.setupPullToRefresh();
            this.optimizeForMobile();
          }
        },
        
        setupTouchEvents() {
          // Gallery swipe navigation
          gallery.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
          gallery.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
          gallery.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
          
          // Modal swipe navigation
          const modal = document.getElementById('image-modal');
          modal.addEventListener('touchstart', this.handleModalTouchStart.bind(this), { passive: false });
          modal.addEventListener('touchmove', this.handleModalTouchMove.bind(this), { passive: false });
          modal.addEventListener('touchend', this.handleModalTouchEnd.bind(this), { passive: false });
        },
        
        handleTouchStart(e) {
          this.startX = e.touches[0].clientX;
          this.startY = e.touches[0].clientY;
          this.isDragging = false;
        },
        
        handleTouchMove(e) {
          if (!this.startX || !this.startY) return;
          
          this.currentX = e.touches[0].clientX;
          this.currentY = e.touches[0].clientY;
          
          const diffX = Math.abs(this.currentX - this.startX);
          const diffY = Math.abs(this.currentY - this.startY);
          
          // Detect horizontal swipe
          if (diffX > diffY && diffX > 50) {
            this.isDragging = true;
            e.preventDefault(); // Prevent scrolling
          }
        },
        
        handleTouchEnd(e) {
          if (!this.isDragging) return;
          
          const diffX = this.currentX - this.startX;
          const threshold = 100;
          
          if (Math.abs(diffX) > threshold) {
            if (diffX > 0) {
              // Swipe right - previous filter
              this.navigateFilter('previous');
            } else {
              // Swipe left - next filter
              this.navigateFilter('next');
            }
          }
          
          this.resetTouch();
        },
        
        handleModalTouchStart(e) {
          if (!document.getElementById('image-modal').classList.contains('active')) return;
          
          this.isModalOpen = true;
          this.startX = e.touches[0].clientX;
          this.startY = e.touches[0].clientY;
        },
        
        handleModalTouchMove(e) {
          if (!this.isModalOpen) return;
          
          this.currentX = e.touches[0].clientX;
          this.currentY = e.touches[0].clientY;
          
          const diffX = Math.abs(this.currentX - this.startX);
          const diffY = Math.abs(this.currentY - this.startY);
          
          if (diffX > diffY && diffX > 30) {
            e.preventDefault();
          }
        },
        
        handleModalTouchEnd(e) {
          if (!this.isModalOpen) return;
          
          const diffX = this.currentX - this.startX;
          const diffY = this.currentY - this.startY;
          const threshold = 80;
          
          if (Math.abs(diffX) > threshold && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX > 0) {
              // Swipe right - previous image
              document.querySelector('.prev-btn').click();
            } else {
              // Swipe left - next image
              document.querySelector('.next-btn').click();
            }
          } else if (diffY > threshold && Math.abs(diffY) > Math.abs(diffX)) {
            // Swipe down - close modal
            document.querySelector('.modal-close').click();
          }
          
          this.resetTouch();
        },
        
        navigateFilter(direction) {
          const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
          const activeBtn = filterBtns.find(btn => btn.classList.contains('active'));
          const currentIndex = filterBtns.indexOf(activeBtn);
          
          let newIndex;
          if (direction === 'next') {
            newIndex = (currentIndex + 1) % filterBtns.length;
          } else {
            newIndex = currentIndex === 0 ? filterBtns.length - 1 : currentIndex - 1;
          }
          
          filterBtns[newIndex].click();
          this.showSwipeHint(direction);
        },
        
        showSwipeHint(direction) {
          const hint = document.createElement('div');
          hint.className = 'swipe-hint';
          hint.textContent = direction === 'next' ? 'Next Filter â†’' : 'â† Previous Filter';
          hint.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1em 2em;
            border-radius: 8px;
            z-index: 10000;
            font-size: 0.9em;
            pointer-events: none;
          `;
          
          document.body.appendChild(hint);
          setTimeout(() => {
            document.body.removeChild(hint);
          }, 1500);
        },
        
        setupPullToRefresh() {
          let startY = 0;
          let pullDistance = 0;
          const threshold = 100;
          
          document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
              startY = e.touches[0].clientY;
            }
          }, { passive: true });
          
          document.addEventListener('touchmove', (e) => {
            if (startY && window.scrollY === 0) {
              pullDistance = e.touches[0].clientY - startY;
              
              if (pullDistance > 0) {
                this.updatePullIndicator(pullDistance, threshold);
              }
            }
          }, { passive: true });
          
          document.addEventListener('touchend', () => {
            if (pullDistance > threshold) {
              autoRefreshManager.forceRefresh();
              showAutoRefreshStatus('Pull to refresh triggered', 'success');
            }
            
            this.hidePullIndicator();
            startY = 0;
            pullDistance = 0;
          }, { passive: true });
        },
        
        updatePullIndicator(distance, threshold) {
          let indicator = document.getElementById('pull-indicator');
          if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'pull-indicator';
            indicator.innerHTML = 'â†“ Pull to refresh';
            indicator.style.cssText = `
              position: fixed;
              top: 0;
              left: 50%;
              transform: translateX(-50%);
              background: var(--accent);
              color: white;
              padding: 0.5em 1em;
              border-radius: 0 0 8px 8px;
              z-index: 9999;
              font-size: 0.8em;
              transition: all 0.2s ease;
            `;
            document.body.appendChild(indicator);
          }
          
          const progress = Math.min(distance / threshold, 1);
          indicator.style.opacity = progress;
          indicator.style.transform = `translateX(-50%) translateY(${-20 + (progress * 20)}px)`;
          
          if (progress >= 1) {
            indicator.innerHTML = 'â†‘ Release to refresh';
            indicator.style.background = 'var(--highlight)';
          } else {
            indicator.innerHTML = 'â†“ Pull to refresh';
            indicator.style.background = 'var(--accent)';
          }
        },
        
        hidePullIndicator() {
          const indicator = document.getElementById('pull-indicator');
          if (indicator) {
            indicator.style.opacity = '0';
            setTimeout(() => {
              if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
              }
            }, 200);
          }
        },
        
        optimizeForMobile() {
          // Optimize touch targets
          const touchTargets = document.querySelectorAll('button, .image-card, .filter-btn');
          touchTargets.forEach(target => {
            const rect = target.getBoundingClientRect();
            if (rect.height < 44) {
              target.style.minHeight = '44px';
            }
          });
          
          // Add mobile-specific classes
          document.body.classList.add('mobile-optimized');
          
          // Optimize scroll performance
          document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.image-gallery')) {
              e.target.style.webkitOverflowScrolling = 'touch';
            }
          }, { passive: true });
        },
        
        resetTouch() {
          this.startX = 0;
          this.startY = 0;
          this.currentX = 0;
          this.currentY = 0;
          this.isDragging = false;
          this.isModalOpen = false;
        }
      };
      
      // Initialize mobile gestures
      mobileGestureManager.init();

      // Cleanup on page unload
      window.addEventListener('beforeunload', cleanupResources);

      // Log initial performance after 5 seconds
      setTimeout(() => {
        performanceMonitor.logPerformanceStats();
      }, 5000);
    })();
  </script>
</body>

</html>