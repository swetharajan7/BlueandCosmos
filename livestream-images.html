<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Stream Images - BlueandCosmos</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --accent: #0033a0;
      --flag-blue: #002366;
      --highlight: #ff4081;
      --text-white: #ffffff;
      --text-light: #cce0ff;
      --dark-bg: #121212;
      --dark-accent: #001f5b;

      /* Theme-aware custom properties */
      --image-overlay-bg: rgba(0, 0, 0, 0.6);
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --text-primary: #333333;
      --text-secondary: #666666;
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --border-color: #eeeeee;
      --modal-backdrop: rgba(0, 0, 0, 0.8);
      --search-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --status-border: rgba(0, 0, 0, 0.2);
    }

    /* Dark theme custom properties */
    body.dark {
      --image-overlay-bg: rgba(0, 0, 0, 0.8);
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --bg-primary: #121212;
      --bg-secondary: #1a1a1a;
      --border-color: #333333;
      --modal-backdrop: rgba(0, 0, 0, 0.95);
      --search-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      --status-border: rgba(255, 255, 255, 0.2);
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: 'Work Sans', sans-serif;
      background: #fff;
      color: #000;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    body.dark {
      background-color: var(--dark-bg);
      color: var(--text-white);
    }

    main {
      flex: 1 0 auto;
    }

    :focus-visible {
      outline: 2px dashed var(--highlight);
      outline-offset: 2px;
    }

    header {
      background: var(--accent);
      color: var(--text-white);
      padding: 1em 2em;
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      align-items: center;
      gap: 1.5em;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo-link {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    .logo-area img {
      height: 50px;
      width: 50px;
      margin: 0;
      padding: 0;
      background-color: transparent;
      display: block;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
      margin-left: -4px;
    }

    .logo-text .title {
      font-size: 1.4em;
      font-weight: bold;
      color: #fff;
      margin: 0;
    }

    .logo-text .tagline {
      font-size: 0.85em;
      color: var(--text-light);
      margin: 0;
    }

    .nav-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 1.2em;
    }

    .nav-right>* {
      display: inline-flex;
      align-items: center;
    }

    .moon-widget {
      display: flex;
      align-items: center;
      gap: 0.6em;
      justify-self: center;
      min-width: 220px;
      user-select: none;
      text-decoration: none;
      color: inherit;
    }

    .moon-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .moon-info {
      display: flex;
      flex-direction: column;
      gap: 0.1em;
    }

    .moon-label {
      color: var(--text-light);
      font-size: 0.95em;
      white-space: nowrap;
      font-weight: 500;
    }

    .moon-context {
      color: var(--text-light);
      font-size: 0.75em;
      opacity: 0.8;
      white-space: nowrap;
    }

    body.dark .moon-label,
    body.dark .moon-context {
      color: #e0ecff;
    }

    @media (max-width: 900px) {
      .moon-widget {
        display: none;
      }
    }

    .mars-widget {
      display: flex;
      align-items: center;
      gap: 0.6em;
      justify-self: center;
      user-select: none;
      text-decoration: none;
      color: inherit;
      transition: transform 0.2s ease;
    }

    .mars-label {
      color: var(--text-light);
      font-size: 0.95em;
      font-weight: 600;
      white-space: nowrap;
    }

    body.dark .mars-label {
      color: #e0ecff;
    }

    .mars-widget:hover {
      transform: scale(1.05);
    }

    .mars-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-image: url('https://photojournal.jpl.nasa.gov/jpeg/PIA00407.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(205, 92, 92, 0.4);
      border: 2px solid rgba(205, 92, 92, 0.3);
    }

    @media (max-width: 1100px) {
      .mars-widget {
        display: none;
      }
    }

    nav {
      display: contents;
    }

    .dropdown {
      position: relative;
    }

    .dropbtn {
      background: none;
      border: none;
      font-size: 1em;
      color: #fff;
      cursor: pointer;
      padding: 0.4em 0;
      position: relative;
      text-decoration: none;
      display: inline-block;
    }

    .dropbtn:hover,
    .dropbtn:focus {
      color: var(--highlight);
    }

    .dropbtn::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease-in-out;
    }

    .dropdown:hover>.dropbtn::after,
    .dropbtn:focus::after,
    .dropdown.open>.dropbtn::after {
      width: 100%;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: calc(100% + 0.6em);
      left: 0;
      background: var(--accent);
      min-width: 220px;
      flex-direction: column;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      padding: 0.3em 0;
      border-radius: 6px;
    }

    .dropdown:hover .dropdown-content,
    .dropdown:focus-within .dropdown-content,
    .dropdown.open .dropdown-content {
      display: flex;
    }

    .dropdown-content a {
      color: var(--text-light);
      text-decoration: none;
      padding: 0.8em 1em;
      position: relative;
      transition: color 0.2s ease, background-color 0.2s ease, transform 0.15s ease;
    }

    .dropdown-content a:hover,
    .dropdown-content a:focus,
    .dropdown-content a.clicked {
      background-color: var(--flag-blue);
      color: #fff !important;
      transform: translateX(5px);
    }

    .dropdown-content a::after {
      content: "";
      position: absolute;
      left: 1em;
      bottom: 6px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease;
    }

    .dropdown-content a:hover::after,
    .dropdown-content a:focus::after,
    .dropdown-content a.clicked::after {
      width: calc(100% - 2em);
    }

    body.dark .dropdown-content a {
      color: #d9e6ff;
    }

    .nav-link {
      color: #fff;
      text-decoration: none;
      position: relative;
      padding-bottom: 2px;
    }

    .nav-link:hover {
      color: var(--highlight);
    }

    .nav-link::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 2px;
      background: var(--highlight);
      transition: width 0.25s ease-in-out;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    .toggle-theme {
      cursor: pointer;
      font-size: 1.5em;
      line-height: 1;
      user-select: none;
    }

    body.dark header,
    body.dark footer {
      background-color: var(--dark-accent);
    }

    body.dark .dropbtn,
    body.dark .nav-link {
      color: #e6f0ff;
    }

    /* Livestream-specific styles */
    .livestream-container {
      padding: 2em;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2em;
    }

    .page-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 0.5em;
      background: linear-gradient(135deg, var(--accent), var(--highlight));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      font-size: 1.2em;
      color: var(--text-light);
      margin-bottom: 1em;
    }

    body.dark .page-subtitle {
      color: #cce0ff;
    }

    /* Enhanced Controls Bar Styles */
    .controls-bar {
      margin-bottom: 2em;
      padding: 1.5em;
      background: rgba(0, 51, 160, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(0, 51, 160, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1.5em;
    }

    body.dark .controls-bar {
      background: rgba(0, 31, 91, 0.2);
      border-color: rgba(0, 31, 91, 0.3);
    }

    /* Search Section */
    .search-section {
      position: relative;
    }

    .search-container {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
    }

    .search-input {
      width: 100%;
      padding: 0.8em 3em 0.8em 1em;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 1em;
      background: white;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
    }

    body.dark .search-input {
      background: #2a2a2a;
      border-color: #444;
      color: white;
    }

    body.dark .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.2);
    }

    .search-icon {
      position: absolute;
      right: 1em;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: 2.5em;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.2em;
      color: #666;
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .search-clear:hover {
      background: #f0f0f0;
      color: #333;
    }

    body.dark .search-clear:hover {
      background: #444;
      color: #fff;
    }

    /* Search Suggestions */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      margin-top: 0.5em;
      padding: 1em;
    }

    body.dark .search-suggestions {
      background: #2a2a2a;
      border-color: #444;
    }

    .suggestion-category h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.dark .suggestion-category h4 {
      color: #aaa;
    }

    .quick-searches {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }

    .suggestion-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 15px;
      padding: 0.4em 0.8em;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .suggestion-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    /* Filter Controls Row */
    .filter-controls {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Advanced Filters */
    .advanced-filters {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 1em;
      border-left: 3px solid var(--accent);
    }

    body.dark .advanced-filters {
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-group {
      margin-bottom: 1em;
    }

    .filter-group:last-child {
      margin-bottom: 0;
    }

    .filter-group label {
      display: block;
      font-size: 0.9em;
      font-weight: 500;
      margin-bottom: 0.5em;
      color: #333;
    }

    body.dark .filter-group label {
      color: #fff;
    }

    .source-filters,
    .date-filters {
      display: flex;
      gap: 0.3em;
      flex-wrap: wrap;
    }

    .source-filter-btn,
    .date-filter-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.4em 0.8em;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .source-filter-btn:hover,
    .date-filter-btn:hover {
      background: #f8f9fa;
    }

    .source-filter-btn.active,
    .date-filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .source-filter-btn,
    body.dark .date-filter-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    body.dark .source-filter-btn:hover,
    body.dark .date-filter-btn:hover {
      background: #495057;
    }

    /* View and Options Row */
    .view-and-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1em;
    }

    .filter-options {
      display: flex;
      gap: 0.5em;
    }

    .options-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.2s ease;
    }

    .options-btn:hover,
    .options-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .options-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    /* Sort Options */
    .sort-options {
      background: rgba(0, 51, 160, 0.05);
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      border-left: 3px solid var(--highlight);
    }

    body.dark .sort-options {
      background: rgba(0, 31, 91, 0.2);
    }

    .sort-group label {
      display: block;
      font-size: 0.9em;
      font-weight: 500;
      margin-bottom: 0.5em;
      color: #333;
    }

    body.dark .sort-group label {
      color: #fff;
    }

    .sort-buttons {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    .sort-btn {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.5em 1em;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sort-btn:hover {
      background: #f8f9fa;
    }

    .sort-btn.active {
      background: var(--highlight);
      color: white;
      border-color: var(--highlight);
    }

    body.dark .sort-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    body.dark .sort-btn:hover {
      background: #495057;
    }

    .filter-controls {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: #fff;
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 0.5em 1em;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .filter-btn:hover,
    .filter-btn:focus {
      background: var(--accent);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 51, 160, 0.2);
    }

    .filter-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 51, 160, 0.3);
    }

    body.dark .filter-btn {
      background: var(--dark-bg);
      border-color: var(--text-light);
      color: var(--text-light);
    }

    body.dark .filter-btn:hover,
    body.dark .filter-btn:focus,
    body.dark .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .view-controls {
      display: flex;
      gap: 0.3em;
      background: #fff;
      border-radius: 8px;
      padding: 0.2em;
      border: 1px solid #ddd;
    }

    body.dark .view-controls {
      background: var(--dark-bg);
      border-color: #444;
    }

    .view-btn {
      background: transparent;
      border: none;
      padding: 0.5em 0.8em;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.2s ease;
      color: #666;
    }

    .view-btn:hover,
    .view-btn:focus {
      background: rgba(0, 51, 160, 0.1);
      color: var(--accent);
    }

    .view-btn.active {
      background: var(--accent);
      color: white;
    }

    body.dark .view-btn {
      color: #aaa;
    }

    body.dark .view-btn:hover,
    body.dark .view-btn:focus {
      background: rgba(0, 51, 160, 0.2);
      color: var(--text-light);
    }

    .refresh-indicator {
      display: flex;
      align-items: center;
      gap: 0.8em;
      font-size: 0.9em;
      color: #666;
    }

    body.dark .refresh-indicator {
      color: #aaa;
    }

    .last-updated {
      font-style: italic;
    }

    .refresh-btn {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s ease;
    }

    .refresh-btn:hover,
    .refresh-btn:focus {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: rotate(180deg);
    }

    .refresh-btn.spinning {
      animation: spin 1s linear infinite;
    }

    .refresh-btn.success {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }

    .refresh-btn.error {
      background: #dc3545;
      border-color: #dc3545;
      color: white;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* Auto-refresh status indicator */
    .auto-refresh-status {
      position: fixed;
      bottom: 2em;
      right: 2em;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.8em 1.2em;
      border-radius: 8px;
      font-size: 0.85em;
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .auto-refresh-status.visible {
      display: block;
      animation: slideInUp 0.3s ease;
    }

    .auto-refresh-status.success {
      background: rgba(40, 167, 69, 0.9);
      border-color: rgba(40, 167, 69, 0.5);
    }

    .auto-refresh-status.error {
      background: rgba(220, 53, 69, 0.9);
      border-color: rgba(220, 53, 69, 0.5);
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Auto-refresh controls */
    .auto-refresh-controls {
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.8em;
      color: #666;
    }

    body.dark .auto-refresh-controls {
      color: #aaa;
    }

    .auto-refresh-toggle {
      background: none;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.2em 0.5em;
      cursor: pointer;
      font-size: 0.75em;
      transition: all 0.2s ease;
    }

    .auto-refresh-toggle:hover {
      background: #f8f9fa;
    }

    .auto-refresh-toggle.enabled {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .auto-refresh-toggle {
      border-color: #444;
      color: #aaa;
    }

    body.dark .auto-refresh-toggle:hover {
      background: #333;
    }

    body.dark .refresh-btn {
      background: var(--dark-bg);
      border-color: #444;
      color: #aaa;
    }

    body.dark .refresh-btn:hover,
    body.dark .refresh-btn:focus {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Image Gallery Grid Layout */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 2em;
      transition: all 0.3s ease;
    }

    /* List View Layout */
    .image-gallery.list-view {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .image-gallery.list-view .image-card {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5em;
      align-items: start;
    }

    .image-gallery.list-view .image-container {
      aspect-ratio: 16/9;
      width: 100%;
    }

    .image-gallery.list-view .image-info {
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }

    .image-gallery.list-view .image-title {
      font-size: 1.3em;
      margin-bottom: 0.8em;
    }

    .image-gallery.list-view .image-description {
      -webkit-line-clamp: 4;
      margin-bottom: 1.5em;
    }

    @media (max-width: 768px) {
      .image-gallery.list-view .image-card {
        grid-template-columns: 1fr;
        gap: 1em;
      }

      .image-gallery.list-view .image-info {
        padding: 1em;
      }
    }

    /* Fade in animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading message styles */
    .loading-message {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4em 2em;
      font-size: 1.1em;
      color: #666;
      background: linear-gradient(135deg, rgba(0, 51, 160, 0.05), rgba(255, 64, 129, 0.05));
      border-radius: 12px;
      border: 2px dashed rgba(0, 51, 160, 0.2);
    }

    body.dark .loading-message {
      color: #ccc;
      background: linear-gradient(135deg, rgba(0, 31, 91, 0.2), rgba(255, 64, 129, 0.1));
      border-color: rgba(0, 31, 91, 0.3);
    }

    /* Error message styles */
    .error-message {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2em;
      background: rgba(255, 64, 129, 0.1);
      border: 2px dashed var(--highlight);
      border-radius: 12px;
      color: #d63384;
    }

    body.dark .error-message {
      background: rgba(255, 64, 129, 0.2);
      color: #ff6b9d;
    }

    /* NASA-specific styling */
    .apod-image {
      position: relative;
    }

    .apod-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      padding: 0.3em 0.6em;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .image-attribution {
      font-size: 0.75em;
      color: #888;
      font-style: italic;
      margin-top: 0.5em;
      padding-top: 0.5em;
      border-top: 1px solid #eee;
    }

    body.dark .image-attribution {
      color: #aaa;
      border-top-color: #333;
    }

    /* Enhanced source styling for all agencies */
    [data-source="nasa"] .source {
      background: linear-gradient(135deg, var(--accent), #0066cc);
      box-shadow: 0 2px 4px rgba(0, 51, 160, 0.3);
    }

    [data-source="nasa"].apod-image .source {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
    }

    [data-source="spacex"] .source {
      background: linear-gradient(135deg, #005288, #0074cc);
      box-shadow: 0 2px 4px rgba(0, 82, 136, 0.3);
    }

    [data-source="esa"] .source {
      background: linear-gradient(135deg, #6f42c1, #8e44ad);
      box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
    }

    [data-source="iss"] .source {
      background: linear-gradient(135deg, #28a745, #20c997);
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    /* Agency-specific card enhancements */
    [data-source="spacex"] {
      border-left: 3px solid #005288;
    }

    [data-source="esa"] {
      border-left: 3px solid #6f42c1;
    }

    [data-source="iss"] {
      border-left: 3px solid #28a745;
    }

    [data-source="nasa"] {
      border-left: 3px solid var(--accent);
    }

    /* Enhanced image loading states and performance optimizations */
    .image-container img {
      transition: opacity 0.4s ease, transform 0.3s ease;
      opacity: 0;
      will-change: opacity, transform;
    }

    .image-container img.loaded {
      opacity: 1;
    }

    .image-container img.loading {
      opacity: 0.3;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    body.dark .image-container img.loading {
      background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
    }

    .image-container img.error {
      opacity: 0.7;
      filter: grayscale(0.5);
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* Performance optimizations */
    .image-card {
      contain: layout style paint;
      transform: translateZ(0);
      /* Force hardware acceleration */
    }

    .image-container {
      contain: layout;
      transform: translateZ(0);
    }

    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {

      .image-container img,
      .image-card,
      .overlay-btn {
        transition: none !important;
        animation: none !important;
      }

      .skeleton {
        animation: none !important;
      }
    }

    /* Optimize for high DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2),
    (min-resolution: 192dpi) {
      .image-container img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    }

    /* Memory optimization for large galleries */
    .image-gallery {
      contain: layout style;
    }

    /* Preload critical images */
    .image-container img[data-priority="high"] {
      opacity: 1;
    }

    /* Modal System Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      padding: 2em;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 90vw;
      max-height: 90vh;
      width: 1200px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
    }

    body.dark .modal-content {
      background: #1a1a1a;
      color: #fff;
    }

    .modal-close {
      position: absolute;
      top: 1em;
      right: 1em;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5em;
      cursor: pointer;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover,
    .modal-close:focus {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .modal-image-container {
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .modal-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.3s ease;
    }

    .modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1em;
      color: white;
      font-size: 0.9em;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .modal-navigation {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      padding: 0 1em;
      pointer-events: none;
    }

    .nav-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5em;
      cursor: pointer;
      pointer-events: auto;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover,
    .nav-btn:focus {
      background: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .modal-info {
      padding: 2em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5em;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: bold;
      margin: 0;
      line-height: 1.3;
      color: #333;
    }

    body.dark .modal-title {
      color: #fff;
    }

    .modal-description {
      font-size: 1em;
      line-height: 1.6;
      color: #666;
      margin: 0;
    }

    body.dark .modal-description {
      color: #ccc;
    }

    .modal-meta {
      border-top: 1px solid #eee;
      padding-top: 1.5em;
    }

    body.dark .modal-meta {
      border-top-color: #333;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
      margin-bottom: 1em;
    }

    .meta-item {
      font-size: 0.9em;
    }

    .meta-item strong {
      color: #333;
      display: block;
      margin-bottom: 0.2em;
    }

    body.dark .meta-item strong {
      color: #fff;
    }

    .meta-item span,
    .meta-item time {
      color: #666;
    }

    body.dark .meta-item span,
    body.dark .meta-item time {
      color: #aaa;
    }

    .modal-attribution {
      font-size: 0.8em;
      color: #888;
      font-style: italic;
      padding: 0.5em;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
    }

    body.dark .modal-attribution {
      background: rgba(255, 255, 255, 0.05);
      color: #aaa;
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }

    .primary-actions {
      display: flex;
      gap: 0.8em;
      flex-wrap: wrap;
    }

    .secondary-actions {
      display: flex;
      gap: 0.5em;
      justify-content: center;
      padding-top: 0.5em;
      border-top: 1px solid #eee;
    }

    body.dark .secondary-actions {
      border-top-color: #333;
    }

    .action-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.8em 1.2em;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s ease;
      flex: 1;
      justify-content: center;
      min-width: 120px;
    }

    .action-btn:hover,
    .action-btn:focus {
      background: var(--flag-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 51, 160, 0.3);
    }

    .action-btn-small {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #dee2e6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1.1em;
    }

    .action-btn-small:hover,
    .action-btn-small:focus {
      background: #e9ecef;
      transform: scale(1.1);
    }

    .action-btn-small.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    body.dark .action-btn-small {
      background: #343a40;
      color: #fff;
      border-color: #495057;
    }

    body.dark .action-btn-small:hover {
      background: #495057;
    }

    .share-btn {
      background: var(--highlight);
    }

    .share-btn:hover {
      background: #e91e63;
    }

    .download-btn {
      background: #28a745;
    }

    .download-btn:hover {
      background: #218838;
    }

    /* Enhanced metadata styling */
    .modal-technical-info,
    .modal-keywords {
      margin-top: 1.5em;
      padding-top: 1em;
      border-top: 1px solid #eee;
    }

    body.dark .modal-technical-info,
    body.dark .modal-keywords {
      border-top-color: #333;
    }

    .modal-technical-info h4,
    .modal-keywords h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.dark .modal-technical-info h4,
    body.dark .modal-keywords h4 {
      color: #aaa;
    }

    .technical-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8em;
    }

    .tech-item {
      font-size: 0.85em;
    }

    .keywords-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }

    .keyword-tag {
      background: rgba(0, 51, 160, 0.1);
      color: var(--accent);
      padding: 0.3em 0.6em;
      border-radius: 12px;
      font-size: 0.8em;
      border: 1px solid rgba(0, 51, 160, 0.2);
    }

    body.dark .keyword-tag {
      background: rgba(0, 51, 160, 0.2);
      color: #66b3ff;
      border-color: rgba(0, 51, 160, 0.3);
    }

    /* Social sharing menu */
    .social-share-expanded {
      margin-top: 1em;
      padding: 1em;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      border-left: 3px solid var(--highlight);
    }

    body.dark .social-share-expanded {
      background: rgba(255, 255, 255, 0.05);
    }

    .social-share-expanded h4 {
      margin: 0 0 0.8em 0;
      font-size: 0.9em;
      color: #666;
    }

    body.dark .social-share-expanded h4 {
      color: #aaa;
    }

    .social-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5em;
    }

    .social-btn {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.6em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.85em;
      transition: all 0.2s ease;
    }

    .social-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body.dark .social-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    .twitter-btn:hover {
      background: #1da1f2;
      color: white;
      border-color: #1da1f2;
    }

    .facebook-btn:hover {
      background: #4267b2;
      color: white;
      border-color: #4267b2;
    }

    .reddit-btn:hover {
      background: #ff4500;
      color: white;
      border-color: #ff4500;
    }

    .copy-btn:hover {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }

    /* Mobile responsive modal */
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 1em;
      }

      .modal-content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        max-height: 95vh;
        width: 100%;
      }

      .modal-info {
        padding: 1.5em;
        max-height: 40vh;
      }

      .meta-grid {
        grid-template-columns: 1fr;
        gap: 0.8em;
      }

      .modal-actions {
        flex-direction: column;
      }

      .action-btn {
        flex: none;
      }

      .nav-btn {
        width: 44px;
        height: 44px;
        font-size: 1.2em;
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {

      .modal-overlay,
      .modal-content,
      .modal-image,
      .nav-btn,
      .action-btn {
        transition: none !important;
      }

      .loading-spinner {
        animation: none !important;
      }

      .mobile-optimized .image-card {
        transform: none !important;
      }
    }

    /* Mobile-specific optimizations */
    .mobile-optimized {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .mobile-optimized .image-card {
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    /* Touch-friendly improvements */
    @media (max-width: 768px) {
      .overlay-btn {
        width: 48px;
        height: 48px;
        font-size: 1.3em;
      }

      .nav-btn {
        width: 56px;
        height: 56px;
        font-size: 1.6em;
      }

      .modal-close {
        width: 48px;
        height: 48px;
        font-size: 1.6em;
      }

      /* Improve touch scrolling */
      .image-gallery {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }

      /* Mobile image optimizations */
      .image-container img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }

      /* Mobile modal optimizations */
      .modal-content {
        margin: 0.5em;
        max-height: calc(100vh - 1em);
      }

      .modal-info {
        padding: 1em;
        font-size: 0.9em;
      }

      .modal-title {
        font-size: 1.2em;
      }

      .modal-actions {
        gap: 0.5em;
      }

      .action-btn {
        min-height: 48px;
        font-size: 0.85em;
      }

      .social-btn {
        min-height: 44px;
        padding: 0.7em;
      }

      /* Mobile performance optimizations */
      .image-card:hover {
        transform: none;
        /* Disable hover effects on mobile */
      }

      .image-container:hover img {
        transform: none;
      }

      /* Mobile-specific animations */
      .image-card {
        transition: opacity 0.2s ease;
      }

      /* Optimize for mobile bandwidth */
      @media (max-width: 480px) and (max-resolution: 150dpi) {
        .image-container img {
          max-width: 100%;
          height: auto;
        }
      }
    }

    /* Landscape mobile optimizations */
    @media (max-width: 768px) and (orientation: landscape) {
      .modal-content {
        grid-template-columns: 1.5fr 1fr;
        max-height: 95vh;
      }

      .modal-info {
        font-size: 0.8em;
      }

      .controls-bar {
        padding: 0.8em;
      }

      .filter-controls {
        gap: 0.3em;
      }
    }

    /* Very small screens */
    @media (max-width: 320px) {
      .livestream-container {
        padding: 0.5em;
      }

      .controls-bar {
        padding: 0.8em;
      }

      .filter-btn {
        font-size: 0.75em;
        padding: 0.5em 0.8em;
      }

      .search-input {
        font-size: 14px;
        padding: 0.7em 2.5em 0.7em 0.8em;
      }

      .image-info {
        padding: 0.6em;
      }

      .image-title {
        font-size: 0.9em;
      }

      .image-description {
        font-size: 0.8em;
        -webkit-line-clamp: 2;
      }
    }

    /* Responsive breakpoints */
    @media (max-width: 1200px) {
      .image-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .image-gallery {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      .image-gallery {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    /* Image Card Styles */
    .image-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .image-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    body.dark .image-card {
      background: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body.dark .image-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    /* Enhanced Dark Mode Styles */
    body.dark {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    }

    body.dark .livestream-container {
      background: transparent;
    }

    body.dark .page-title {
      background: linear-gradient(135deg, #66b3ff, #ff6b9d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    body.dark .controls-bar {
      background: rgba(0, 31, 91, 0.3);
      border-color: rgba(0, 31, 91, 0.4);
      backdrop-filter: blur(10px);
    }

    body.dark .search-input {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    body.dark .search-input::placeholder {
      color: #888;
    }

    body.dark .search-input:focus {
      border-color: #66b3ff;
      box-shadow: 0 0 0 3px rgba(102, 179, 255, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    body.dark .search-suggestions {
      background: #2a2a2a;
      border-color: #444;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    body.dark .image-card {
      background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    body.dark .image-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      border-color: #444;
    }

    body.dark .image-overlay {
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.9) 100%);
    }

    body.dark .overlay-btn {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }

    body.dark .overlay-btn:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    body.dark .modal-content {
      background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
      border: 1px solid #333;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    body.dark .modal-close {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #444;
    }

    body.dark .modal-close:hover {
      background: rgba(0, 0, 0, 0.95);
      border-color: #666;
    }

    body.dark .nav-btn {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #444;
    }

    body.dark .nav-btn:hover {
      background: rgba(0, 0, 0, 0.95);
      border-color: #666;
    }

    body.dark .modal-attribution {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #66b3ff;
    }

    body.dark .social-share-expanded {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #ff6b9d;
    }

    body.dark .auto-refresh-status {
      background: rgba(0, 0, 0, 0.9);
      border-color: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
    }

    body.dark .results-count {
      color: #aaa !important;
    }

    /* Dark mode loading states */
    body.dark .loading-message {
      background: linear-gradient(135deg, rgba(0, 31, 91, 0.3), rgba(255, 64, 129, 0.2));
      border-color: rgba(0, 31, 91, 0.4);
      color: #ccc;
    }

    body.dark .error-message {
      background: rgba(255, 64, 129, 0.3);
      border-color: #ff6b9d;
      color: #ff9db4;
    }

    /* Enhanced contrast for better readability */
    body.dark .image-title {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    body.dark .image-description {
      color: #ddd;
    }

    body.dark .image-meta {
      color: #bbb;
    }

    body.dark .modal-title {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    body.dark .modal-description {
      color: #ddd;
      line-height: 1.7;
    }

    /* Dark mode animations */
    @keyframes darkModeGlow {

      0%,
      100% {
        box-shadow: 0 0 5px rgba(102, 179, 255, 0.3);
      }

      50% {
        box-shadow: 0 0 20px rgba(102, 179, 255, 0.5);
      }
    }

    body.dark .image-card:hover {
      animation: darkModeGlow 2s ease-in-out infinite;
    }

    /* Disable glow animation on mobile for performance */
    @media (max-width: 768px) {
      body.dark .image-card:hover {
        animation: none;
      }
    }

    /* Error Handling UI Styles */
    .user-error {
      font-family: 'Work Sans', sans-serif;
      backdrop-filter: blur(10px);
    }

    .error-content {
      position: relative;
      padding-right: 2em;
    }

    .error-title {
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 0.5em;
    }

    .error-message {
      font-size: 0.9em;
      line-height: 1.4;
      opacity: 0.9;
    }

    .error-close {
      position: absolute;
      top: -0.5em;
      right: -0.5em;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      color: inherit;
      cursor: pointer;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .error-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .image-placeholder {
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .image-placeholder:hover {
      background: #e9ecef;
    }

    body.dark .image-placeholder {
      background: #2a2a2a;
      color: #aaa;
    }

    body.dark .image-placeholder:hover {
      background: #333;
    }

    .placeholder-icon {
      font-size: 2em;
      margin-bottom: 0.5em;
      opacity: 0.7;
    }

    .placeholder-text {
      font-size: 0.85em;
      opacity: 0.8;
    }

    .error-fallback {
      opacity: 0.7;
      filter: grayscale(0.5);
      border: 2px dashed #dc3545;
    }

    /* Error animations */
    @keyframes slideInDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutUp {
      from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      to {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Error state improvements */
    .image-card.error-state {
      border-color: #dc3545;
      background: rgba(220, 53, 69, 0.05);
    }

    body.dark .image-card.error-state {
      border-color: #ff6b9d;
      background: rgba(255, 107, 157, 0.1);
    }

    /* Retry button styling */
    .retry-btn {
      background: var(--highlight);
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8em;
      margin-top: 0.5em;
      transition: all 0.2s ease;
    }

    .retry-btn:hover {
      background: #e91e63;
      transform: translateY(-1px);
    }

    /* Enhanced Social Sharing Styles */
    .social-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5em;
    }

    .social-btn {
      background: #fff;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 0.8em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.85em;
      transition: all 0.2s ease;
      text-decoration: none;
      color: inherit;
    }

    .social-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.dark .social-btn {
      background: #343a40;
      border-color: #495057;
      color: #fff;
    }

    .social-icon {
      font-size: 1.2em;
      flex-shrink: 0;
    }

    .social-text {
      font-weight: 500;
    }

    /* Platform-specific hover effects */
    .social-btn[data-platform="twitter"]:hover {
      background: #1da1f2;
      border-color: #1da1f2;
      color: white;
    }

    .social-btn[data-platform="facebook"]:hover {
      background: #4267b2;
      border-color: #4267b2;
      color: white;
    }

    .social-btn[data-platform="reddit"]:hover {
      background: #ff4500;
      border-color: #ff4500;
      color: white;
    }

    .social-btn[data-platform="linkedin"]:hover {
      background: #0077b5;
      border-color: #0077b5;
      color: white;
    }

    .social-btn[data-platform="whatsapp"]:hover {
      background: #25d366;
      border-color: #25d366;
      color: white;
    }

    .social-btn[data-platform="copy"]:hover {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }

    /* Share notification animations */
    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }

      to {
        transform: translateY(100%);
        opacity: 0;
      }
    }

    /* Quick share options */
    .share-options {
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    body.dark .share-options {
      background: #2a2a2a;
      border-color: #444;
    }

    body.dark .quick-share-btn:hover {
      background: #333;
    }

    /* Enhanced share menu */
    .social-share-expanded {
      margin-top: 1em;
      padding: 1.5em;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      border-left: 4px solid var(--highlight);
    }

    body.dark .social-share-expanded {
      background: rgba(255, 255, 255, 0.05);
    }

    .social-share-expanded h4 {
      margin: 0 0 1em 0;
      font-size: 1em;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    body.dark .social-share-expanded h4 {
      color: #fff;
    }

    .social-share-expanded h4::before {
      content: '📤';
      font-size: 1.2em;
    }

    /* Share statistics display */
    .share-stats {
      margin-top: 1em;
      padding: 1em;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
      font-size: 0.8em;
      color: #666;
    }

    body.dark .share-stats {
      background: rgba(255, 255, 255, 0.03);
      color: #aaa;
    }

    /* Mobile optimizations for sharing */
    @media (max-width: 768px) {
      .social-buttons {
        grid-template-columns: 1fr 1fr;
        gap: 0.8em;
      }

      .social-btn {
        padding: 1em;
        font-size: 0.9em;
      }

      .social-share-expanded {
        padding: 1em;
      }

      .share-options {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 16px 16px 0 0;
        max-height: 50vh;
        overflow-y: auto;
      }
    }

    .image-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .image-card:hover .image-container img {
      transform: scale(1.05);
    }

    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.7) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      padding: 1em;
      gap: 0.5em;
    }

    .image-card:hover .image-overlay {
      opacity: 1;
    }

    .overlay-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .overlay-btn:hover,
    .overlay-btn:focus {
      background: #fff;
      transform: scale(1.1);
      outline: 2px solid var(--highlight);
      outline-offset: 2px;
    }

    .overlay-btn:active {
      transform: scale(0.95);
    }

    /* Improve image loading states */
    .image-container img {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .image-container img[data-src] {
      opacity: 0.7;
    }

    .image-container img:not([data-src]) {
      opacity: 1;
    }

    .image-info {
      padding: 1.2em;
    }

    .image-title {
      font-size: 1.1em;
      font-weight: bold;
      margin: 0 0 0.5em 0;
      color: #333;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.dark .image-title {
      color: #fff;
    }

    .image-description {
      font-size: 0.9em;
      color: #666;
      margin: 0 0 1em 0;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    body.dark .image-description {
      color: #ccc;
    }

    .image-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8em;
      color: #888;
    }

    body.dark .image-meta {
      color: #aaa;
    }

    .source {
      color: white;
      padding: 0.2em 0.6em;
      border-radius: 12px;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.75em;
    }

    /* Source-specific colors */
    .source:contains("NASA"),
    [data-source="nasa"] .source {
      background: var(--accent);
    }

    [data-source="spacex"] .source {
      background: #005288;
    }

    [data-source="iss"] .source {
      background: #28a745;
    }

    [data-source="esa"] .source {
      background: #6f42c1;
    }

    .timestamp {
      font-style: italic;
    }

    /* Loading Skeleton Animations */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    body.dark .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark .skeleton-card {
      background: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .skeleton-image {
      width: 100%;
      aspect-ratio: 16/9;
    }

    .skeleton-content {
      padding: 1.2em;
    }

    .skeleton-title {
      height: 1.2em;
      border-radius: 4px;
      margin-bottom: 0.5em;
    }

    .skeleton-description {
      height: 0.9em;
      border-radius: 4px;
      margin-bottom: 0.3em;
    }

    .skeleton-description:last-of-type {
      width: 70%;
      margin-bottom: 1em;
    }

    .skeleton-meta {
      display: flex;
      justify-content: space-between;
    }

    .skeleton-source {
      width: 60px;
      height: 1.2em;
      border-radius: 12px;
    }

    .skeleton-timestamp {
      width: 80px;
      height: 1em;
      border-radius: 4px;
    }

    .placeholder-content {
      text-align: center;
      padding: 4em 2em;
      background: linear-gradient(135deg, rgba(0, 51, 160, 0.1), rgba(255, 64, 129, 0.1));
      border-radius: 12px;
      border: 2px dashed var(--accent);
    }

    .placeholder-icon {
      font-size: 4em;
      margin-bottom: 1em;
    }

    .placeholder-text {
      font-size: 1.1em;
      color: #666;
      line-height: 1.6;
    }

    body.dark .placeholder-content {
      background: linear-gradient(135deg, rgba(0, 31, 91, 0.3), rgba(255, 64, 129, 0.1));
      border-color: var(--dark-accent);
    }

    body.dark .placeholder-text {
      color: #ccc;
    }

    footer {
      background-color: var(--accent);
      color: #fff;
      padding: 2em 1em;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      text-align: center;
      gap: 1em;
    }

    footer a {
      color: #fff;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .livestream-container {
        padding: 1em;
      }

      .page-title {
        font-size: 2em;
      }

      .page-subtitle {
        font-size: 1em;
      }

      .image-info {
        padding: 1em;
      }

      .image-title {
        font-size: 1em;
      }

      .image-description {
        font-size: 0.85em;
        -webkit-line-clamp: 2;
      }

      .overlay-btn {
        width: 36px;
        height: 36px;
        font-size: 1em;
      }
    }

    /* Enhanced Mobile Optimizations */
    @media (max-width: 768px) {
      .livestream-container {
        padding: 1em;
      }

      .controls-bar {
        padding: 1em;
        gap: 1em;
      }

      /* Mobile search optimization */
      .search-container {
        max-width: 100%;
      }

      .search-input {
        font-size: 16px;
        /* Prevents zoom on iOS */
        padding: 0.9em 3em 0.9em 1em;
      }

      .search-suggestions {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 16px 16px 0 0;
        max-height: 50vh;
        overflow-y: auto;
      }

      /* Mobile filter controls */
      .filter-controls {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 0.5em;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .filter-controls::-webkit-scrollbar {
        display: none;
      }

      .filter-btn {
        flex-shrink: 0;
        font-size: 0.85em;
        padding: 0.6em 1em;
      }

      /* Mobile advanced filters */
      .advanced-filters {
        padding: 0.8em;
      }

      .source-filters,
      .date-filters {
        gap: 0.2em;
      }

      .source-filter-btn,
      .date-filter-btn {
        font-size: 0.75em;
        padding: 0.5em 0.7em;
      }

      /* Mobile view controls */
      .view-and-options {
        flex-direction: column;
        gap: 0.8em;
      }

      .filter-options {
        justify-content: center;
      }

      .refresh-indicator {
        align-self: center;
      }

      .auto-refresh-controls {
        flex-direction: column;
        align-items: center;
        gap: 0.3em;
        text-align: center;
      }

      /* Mobile sort options */
      .sort-buttons {
        gap: 0.3em;
      }

      .sort-btn {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
      }
    }

    @media (max-width: 480px) {
      .page-header {
        margin-bottom: 1.5em;
      }

      .page-title {
        font-size: 1.8em;
      }

      .image-info {
        padding: 0.8em;
      }

      .image-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3em;
      }

      .controls-bar {
        padding: 1em;
      }

      .filter-btn {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
      }
    }

    /* Enhanced Performance Analytics Styles */
    .performance-indicator {
      position: fixed;
      top: 50px;
      left: 2em;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.8em;
      border-radius: 8px;
      font-size: 0.75em;
      z-index: 10004;
      font-family: monospace;
      max-width: 280px;
      backdrop-filter: blur(10px);
      animation: slideInLeft 0.3s ease;
    }

    .performance-indicator.good {
      border-left: 4px solid #28a745;
    }

    .performance-indicator.warning {
      border-left: 4px solid #ffc107;
      color: #000;
      background: rgba(255, 193, 7, 0.95);
    }

    .performance-indicator.error {
      border-left: 4px solid #dc3545;
      background: rgba(220, 53, 69, 0.95);
    }

    /* Performance Dashboard Enhancements */
    #performance-dashboard {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInRight 0.3s ease;
      line-height: 1.3;
    }

    /* Core Web Vitals Status Colors */
    .cwv-good {
      color: #28a745;
    }

    .cwv-needs-improvement {
      color: #ffc107;
    }

    .cwv-poor {
      color: #dc3545;
    }

    /* Bundle optimization indicators */
    .webp-support .image-card img {
      /* WebP optimized images would be served here */
    }

    .slow-connection .image-card img {
      /* Lower quality images for slow connections */
      filter: contrast(0.9) brightness(1.1);
    }

    .slow-connection .loading-skeleton {
      animation-duration: 2s;
      /* Slower animation for slow connections */
    }

    /* Performance budget exceeded animation */
    @keyframes budgetExceeded {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
        background-color: rgba(220, 53, 69, 0.1);
      }

      100% {
        transform: scale(1);
      }
    }

    .budget-exceeded {
      animation: budgetExceeded 0.5s ease-in-out;
    }

    /* Analytics visualization */
    .analytics-chart {
      width: 100%;
      height: 40px;
      background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
      border-radius: 4px;
      margin: 0.3em 0;
      position: relative;
      overflow: hidden;
    }

    .analytics-chart::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(90deg,
          transparent,
          transparent 8px,
          rgba(255, 255, 255, 0.1) 8px,
          rgba(255, 255, 255, 0.1) 9px);
    }

    /* Performance monitoring help text */
    .perf-help {
      position: fixed;
      bottom: 2em;
      left: 2em;
      background: rgba(0, 0, 0, 0.8);
      color: #ccc;
      padding: 0.5em;
      border-radius: 4px;
      font-size: 0.7em;
      z-index: 10003;
      font-family: monospace;
      opacity: 0.7;
    }

    /* Development mode indicator */
    body[data-dev-mode="true"]::before {
      content: "🚀 DEV MODE - Performance Analytics Active";
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #17a2b8;
      color: white;
      text-align: center;
      padding: 0.3em;
      font-size: 0.8em;
      z-index: 10006;
    }
  </style>
</head>

<body>
  <header>
    <a href="index.html" class="logo-link" aria-label="BlueandCosmos Home">
      <div class="logo-area">
        <img src="https://cdn.jsdelivr.net/gh/swetharajan7/blueandcosmos/assets/logo-transparent.png"
          alt="BlueandCosmos Logo" />
        <div class="logo-text">
          <div class="title">BlueandCosmos</div>
          <div class="tagline">Exploring the Cosmos. Protecting the Earth.</div>
        </div>
      </div>
    </a>

    <a href="moon.html" class="moon-widget" title="View detailed moon phase information">
      <div class="moon-icon" id="moon-display">🌙</div>
      <div class="moon-info">
        <span class="moon-label">Loading moon phase…</span>
        <span class="moon-context" id="moon-context">New York City, NY</span>
      </div>
    </a>

    <a href="explorex.html" class="explorex-widget" title="ExploreX - Discover Space Travel Experiences">
      <div class="explorex-icon">🚀</div>
      <span class="explorex-label">ExploreX</span>
    </a>

    <a href="mars.html" class="mars-widget" title="Explore Mars - The Red Planet">
      <div class="mars-icon"></div>
      <span class="mars-label">MARS</span>
    </a>

    <nav>
      <div class="nav-right">
        <!-- About (internal links, same tab) -->
        <div class="dropdown" data-menu="about">
          <button class="dropbtn">About</button>
          <div class="dropdown-content" role="menu" aria-label="About submenu">
            <a href="about.html" role="menuitem">About BlueandCosmos</a>
          </div>
        </div>

        <!-- Livestream (internal placeholders as relative links) -->
        <div class="dropdown" data-menu="livestream">
          <button class="dropbtn">Livestream</button>
          <div class="dropdown-content" role="menu" aria-label="Livestream submenu">
            <a href="livestream-images.html" role="menuitem" class="clicked">Live Stream Images</a>
            <a href="launch-missions.html" role="menuitem">Launch Missions</a>
            <a href="webinars.html" role="menuitem">Webinars</a>
          </div>
        </div>

        <!-- Dashboard (educational tools and features) -->
        <div class="dropdown" data-menu="dashboard">
          <a href="dashboard.html" class="dropbtn">Dashboard</a>
          <div class="dropdown-content" role="menu" aria-label="Dashboard submenu">
            <a href="moon.html" role="menuitem">🌙 Lunar Intelligence Center</a>
            <a href="telescope.html" role="menuitem">🔭 Telescope</a>
            <a href="flashcards.html" role="menuitem">🧠 Flashcards</a>
            <a href="stellarrec.html" role="menuitem">⭐ StellarRec</a>
            <a href="discussion.html" role="menuitem">💬 Community</a>
          </div>
        </div>
        <div class="toggle-theme" id="themeToggle">🌙</div>
      </div>
    </nav>
  </header>

  <main class="livestream-container">
    <div class="page-header">
      <h1 class="page-title">Live Stream Images</h1>
      <p class="page-subtitle">Real-time space imagery from missions, observatories, and cosmic events</p>
    </div>

    <!-- Controls Bar -->
    <section class="controls-bar">
      <div class="search-section">
        <div class="search-container">
          <input type="text" class="search-input" id="search-input" placeholder="Search space images..."
            autocomplete="off">
          <button class="search-clear" id="search-clear" title="Clear search" style="display: none;">×</button>
          <div class="search-icon">🔍</div>
        </div>
        <div class="search-suggestions" id="search-suggestions" style="display: none;">
          <div class="suggestion-category">
            <h4>Quick Searches</h4>
            <div class="quick-searches">
              <button class="suggestion-btn" data-search="mars rover">Mars Rover</button>
              <button class="suggestion-btn" data-search="hubble telescope">Hubble</button>
              <button class="suggestion-btn" data-search="earth from space">Earth from Space</button>
              <button class="suggestion-btn" data-search="nebula">Nebula</button>
              <button class="suggestion-btn" data-search="jupiter">Jupiter</button>
              <button class="suggestion-btn" data-search="aurora">Aurora</button>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="missions">Missions</button>
        <button class="filter-btn" data-filter="deep-space">Deep Space</button>
        <button class="filter-btn" data-filter="earth">Earth</button>
        <button class="filter-btn" data-filter="planets">Planets</button>
        <button class="filter-btn" data-filter="iss">ISS</button>
      </div>

      <div class="advanced-filters" id="advanced-filters" style="display: none;">
        <div class="filter-group">
          <label>Source:</label>
          <div class="source-filters">
            <button class="source-filter-btn active" data-source="all">All</button>
            <button class="source-filter-btn" data-source="nasa">NASA</button>
            <button class="source-filter-btn" data-source="spacex">SpaceX</button>
            <button class="source-filter-btn" data-source="esa">ESA</button>
            <button class="source-filter-btn" data-source="iss">ISS</button>
          </div>
        </div>

        <div class="filter-group">
          <label>Date Range:</label>
          <div class="date-filters">
            <button class="date-filter-btn active" data-range="all">All Time</button>
            <button class="date-filter-btn" data-range="today">Today</button>
            <button class="date-filter-btn" data-range="week">This Week</button>
            <button class="date-filter-btn" data-range="month">This Month</button>
          </div>
        </div>
      </div>

      <div class="view-and-options">
        <div class="view-controls">
          <button class="view-btn active" data-view="grid" title="Grid View">⊞</button>
          <button class="view-btn" data-view="list" title="List View">☰</button>
        </div>

        <div class="filter-options">
          <button class="options-btn" id="advanced-toggle" title="Advanced Filters">⚙️</button>
          <button class="options-btn" id="sort-toggle" title="Sort Options">↕️</button>
        </div>

        <div class="refresh-indicator">
          <div class="auto-refresh-controls">
            <span class="last-updated">Updated: <time id="last-refresh">just now</time></span>
            <button class="auto-refresh-toggle enabled" id="auto-refresh-toggle" title="Toggle Auto-refresh">
              Auto
            </button>
          </div>
          <button class="refresh-btn" title="Refresh Now">🔄</button>
        </div>
      </div>
    </section>

    <!-- Sort Options -->
    <div class="sort-options" id="sort-options" style="display: none;">
      <div class="sort-group">
        <label>Sort by:</label>
        <div class="sort-buttons">
          <button class="sort-btn active" data-sort="date-desc">Newest First</button>
          <button class="sort-btn" data-sort="date-asc">Oldest First</button>
          <button class="sort-btn" data-sort="title-asc">Title A-Z</button>
          <button class="sort-btn" data-sort="source-asc">Source</button>
        </div>
      </div>
    </div>

    <!-- Image Gallery Grid -->
    <section class="image-gallery" id="image-gallery">
      <!-- Sample Image Cards with Real Space Imagery -->
      <article class="image-card" data-category="missions" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg"
            alt="Perseverance Mars Rover Self-Portrait" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Perseverance Mars Rover Self-Portrait</h3>
          <p class="image-description">NASA's Perseverance rover took this selfie over a rock nicknamed "Rochette," on
            Sol 198 (September 10, 2021). The rover is preparing to take its first sample from this rock.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">2 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="deep-space" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg" alt="Hubble Views the Crab Nebula"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Hubble Views the Crab Nebula</h3>
          <p class="image-description">This Hubble Space Telescope image shows the Crab Nebula, the result of a
            supernova explosion that was observed by Chinese astronomers in 1054 AD.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">4 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="earth" data-source="iss">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg"
            alt="Earth from the International Space Station" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Earth from the International Space Station</h3>
          <p class="image-description">A stunning view of Earth's curvature and atmosphere captured from the
            International Space Station, showing the thin blue line of our planet's protective atmosphere.</p>
          <div class="image-meta">
            <span class="source">ISS</span>
            <time class="timestamp">1 hour ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="planets" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA21773/PIA21773~thumb.jpg" alt="Jupiter's Great Red Spot"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Jupiter's Great Red Spot</h3>
          <p class="image-description">This enhanced-color image of Jupiter's Great Red Spot was created by citizen
            scientist Gerald Eichstädt using data from Juno's JunoCam imager.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">6 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="missions" data-source="spacex">
        <div class="image-container">
          <img
            src="https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg"
            alt="SpaceX Falcon 9 Launch" loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">SpaceX Falcon 9 Launch</h3>
          <p class="image-description">A SpaceX Falcon 9 rocket carrying NASA astronauts Doug Hurley and Bob Behnken in
            the Crew Dragon spacecraft lifts off from Launch Complex 39A.</p>
          <div class="image-meta">
            <span class="source">SPACEX</span>
            <time class="timestamp">3 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="deep-space" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg" alt="Webb's First Deep Field"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Webb's First Deep Field</h3>
          <p class="image-description">NASA's James Webb Space Telescope has delivered the deepest and sharpest infrared
            image of the distant universe so far, showing galaxy cluster SMACS 0723.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">5 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="planets" data-source="nasa">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/PIA23791/PIA23791~thumb.jpg" alt="Saturn's Rings in Infrared"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Saturn's Rings in Infrared</h3>
          <p class="image-description">This infrared image from NASA's Cassini spacecraft shows Saturn's rings in
            exquisite detail, revealing the complex structure and composition of the ring system.</p>
          <div class="image-meta">
            <span class="source">NASA</span>
            <time class="timestamp">8 hours ago</time>
          </div>
        </div>
      </article>

      <article class="image-card" data-category="iss" data-source="iss">
        <div class="image-container">
          <img src="https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg" alt="Aurora from Space"
            loading="lazy">
          <div class="image-overlay">
            <button class="overlay-btn expand-btn" title="View Full Size">🔍</button>
            <button class="overlay-btn share-btn" title="Share Image">📤</button>
          </div>
        </div>
        <div class="image-info">
          <h3 class="image-title">Aurora from Space</h3>
          <p class="image-description">A spectacular aurora borealis captured from the International Space Station,
            showing the dancing lights of charged particles interacting with Earth's magnetic field.</p>
          <div class="image-meta">
            <span class="source">ISS</span>
            <time class="timestamp">30 minutes ago</time>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Image Modal -->
  <div class="modal-overlay" id="image-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" title="Close Modal" aria-label="Close">&times;</button>

      <div class="modal-image-container">
        <img class="modal-image" src="" alt="" id="modal-image">
        <div class="modal-navigation">
          <button class="nav-btn prev-btn" title="Previous Image" aria-label="Previous Image">‹</button>
          <button class="nav-btn next-btn" title="Next Image" aria-label="Next Image">›</button>
        </div>
        <div class="modal-loading">
          <div class="loading-spinner"></div>
          <span>Loading high-resolution image...</span>
        </div>
      </div>

      <div class="modal-info">
        <h2 class="modal-title" id="modal-title"></h2>
        <p class="modal-description"></p>

        <div class="modal-meta">
          <div class="meta-grid">
            <div class="meta-item">
              <strong>Source:</strong>
              <span class="modal-source"></span>
            </div>
            <div class="meta-item">
              <strong>Date:</strong>
              <time class="modal-date"></time>
            </div>
            <div class="meta-item">
              <strong>Category:</strong>
              <span class="modal-category"></span>
            </div>
            <div class="meta-item modal-mission" style="display: none;">
              <strong>Mission:</strong>
              <span class="modal-mission-name"></span>
            </div>
            <div class="meta-item modal-instrument" style="display: none;">
              <strong>Instrument:</strong>
              <span class="modal-instrument-name"></span>
            </div>
            <div class="meta-item modal-location" style="display: none;">
              <strong>Location:</strong>
              <span class="modal-location-name"></span>
            </div>
          </div>

          <div class="modal-technical-info" style="display: none;">
            <h4>Technical Details</h4>
            <div class="technical-grid">
              <div class="tech-item modal-resolution" style="display: none;">
                <strong>Resolution:</strong>
                <span class="modal-resolution-value"></span>
              </div>
              <div class="tech-item modal-coordinates" style="display: none;">
                <strong>Coordinates:</strong>
                <span class="modal-coordinates-value"></span>
              </div>
              <div class="tech-item modal-altitude" style="display: none;">
                <strong>Altitude:</strong>
                <span class="modal-altitude-value"></span>
              </div>
            </div>
          </div>

          <div class="modal-keywords" style="display: none;">
            <h4>Keywords</h4>
            <div class="keywords-container"></div>
          </div>

          <div class="modal-attribution"></div>
        </div>

        <div class="modal-actions">
          <div class="primary-actions">
            <button class="action-btn share-btn" id="modal-share">
              <span class="btn-icon">📤</span>
              <span class="btn-text">Share</span>
            </button>
            <a class="action-btn source-btn" href="#" target="_blank" rel="noopener" id="modal-source-link">
              <span class="btn-icon">🔗</span>
              <span class="btn-text">View Source</span>
            </a>
            <button class="action-btn download-btn" id="modal-download">
              <span class="btn-icon">⬇️</span>
              <span class="btn-text">Download</span>
            </button>
          </div>

          <div class="secondary-actions">
            <button class="action-btn-small favorite-btn" id="modal-favorite" title="Add to Favorites">
              <span class="btn-icon">❤️</span>
            </button>
            <button class="action-btn-small fullscreen-btn" id="modal-fullscreen" title="View Fullscreen">
              <span class="btn-icon">⛶</span>
            </button>
            <button class="action-btn-small info-toggle-btn" id="modal-info-toggle" title="Toggle Technical Info">
              <span class="btn-icon">ℹ️</span>
            </button>
          </div>

          <div class="social-share-expanded" id="social-share-menu" style="display: none;">
            <h4>Share on Social Media</h4>
            <div class="social-buttons">
              <button class="social-btn twitter-btn" data-platform="twitter">
                <span class="social-icon">🐦</span>
                <span class="social-text">Twitter</span>
              </button>
              <button class="social-btn facebook-btn" data-platform="facebook">
                <span class="social-icon">📘</span>
                <span class="social-text">Facebook</span>
              </button>
              <button class="social-btn reddit-btn" data-platform="reddit">
                <span class="social-icon">🔴</span>
                <span class="social-text">Reddit</span>
              </button>
              <button class="social-btn copy-btn" data-platform="copy">
                <span class="social-icon">📋</span>
                <span class="social-text">Copy Link</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto-refresh status indicator -->
  <div class="auto-refresh-status" id="auto-refresh-status">
    <span class="status-text"></span>
  </div>

  <footer>
    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-start;gap:0.5em;">
      <a href="#"><img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg"
          alt="Google Play Store" style="height:40px;"></a>
      <a href="#"><img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg"
          alt="Apple Store" style="height:40px;"></a>
    </div>

    <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:0.5em;">
      <div style="font-weight:bold;">BlueandCosmos™ 2025</div>
      <div style="display:flex;flex-wrap:wrap;gap:1em;justify-content:center;font-size:0.9em;">
        <a href="privacy.html">Privacy Policy</a>
        <a href="terms.html">Terms of Use</a>
        <a href="sitemap.html">Sitemap</a>
      </div>
    </div>

    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:0.5em;">
      <div style="font-weight:bold;">Let's Connect!</div>
      <div style="display:flex;gap:0.5em;">
        <a href="https://twitter.com/blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="X"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://instagram.com/blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://tiktok.com/@blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"
            style="height:24px;filter:invert(1);"></a>
        <a href="https://youtube.com/@blueandcosmos" target="_blank" rel="noopener"><img
            src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"
            style="height:24px;filter:invert(1);"></a>
      </div>
    </div>
  </footer>

  <script src="maximus.js"></script>
  <script>
    // Image Data Management System
    class ImageDataManager {
      constructor() {
        this.cache = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
        this.retryAttempts = 3;
        this.retryDelay = 1000; // 1 second
      }

      // Main method to fetch all images from multiple sources
      async fetchAllImages() {
        const sources = [
          this.fetchNASAImages(),
          this.fetchESAImages(),
          this.fetchSpaceXImages(),
          this.fetchISSImages(),
          this.fetchAPOD()
        ];

        try {
          const results = await Promise.allSettled(sources);
          const allImages = [];

          results.forEach((result, index) => {
            if (result.status === 'fulfilled' && result.value) {
              if (Array.isArray(result.value)) {
                allImages.push(...result.value);
              } else {
                allImages.push(result.value);
              }
            } else {
              console.warn(`Source ${index} failed:`, result.reason);
            }
          });

          return this.combineAndSort(allImages);
        } catch (error) {
          console.error('Error fetching images:', error);
          return this.getFallbackImages();
        }
      }

      // Enhanced NASA Image and Video Library API
      async fetchNASAImages() {
        const cacheKey = 'nasa_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch multiple NASA collections for diverse content
          const queries = [
            'mars rover perseverance',
            'hubble telescope',
            'james webb telescope',
            'earth from space',
            'jupiter saturn planets',
            'nebula galaxy stars'
          ];

          const allImages = [];

          for (const query of queries) {
            try {
              const response = await this.fetchWithRetry(
                `https://images-api.nasa.gov/search?q=${encodeURIComponent(query)}&media_type=image&page_size=5&year_start=2020`
              );

              if (response.ok) {
                const data = await response.json();
                const images = data.collection.items
                  .filter(item => item.links && item.links.length > 0)
                  .map(item => this.parseNASAImage(item))
                  .filter(img => img.imageUrl && !img.imageUrl.includes('placeholder'));

                allImages.push(...images);
              }
            } catch (queryError) {
              console.warn(`NASA query failed for "${query}":`, queryError);
            }
          }

          // Remove duplicates and limit results
          const uniqueImages = this.removeDuplicates(allImages).slice(0, 15);

          this.setCache(cacheKey, uniqueImages);
          return uniqueImages.length > 0 ? uniqueImages : this.getNASAFallback();

        } catch (error) {
          console.error('NASA API error:', error);

          // Report error to error manager
          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError(
              'NASA API Error',
              'Unable to load fresh NASA images. Using cached content.',
              'warning'
            );
          }

          return this.getNASAFallback();
        }
      }

      // Enhanced NASA API response parsing
      parseNASAImage(item) {
        const data = item.data[0];
        const links = item.links || [];
        const imageLink = links.find(link => link.rel === 'preview') || links[0];

        // Clean and truncate description
        let description = data.description || 'Image from NASA';
        if (description.length > 200) {
          description = description.substring(0, 200) + '...';
        }

        // Clean title
        let title = data.title || 'NASA Image';
        if (title.length > 80) {
          title = title.substring(0, 80) + '...';
        }

        return {
          id: `nasa_${data.nasa_id}`,
          title: title,
          description: description,
          imageUrl: imageLink ? imageLink.href : this.getPlaceholderImage(),
          thumbnailUrl: imageLink ? imageLink.href : this.getPlaceholderImage(),
          source: 'nasa',
          category: this.categorizeNASAImage(data),
          timestamp: new Date(data.date_created || Date.now()),
          sourceUrl: `https://images.nasa.gov/details/${data.nasa_id}`,
          metadata: {
            nasaId: data.nasa_id,
            photographer: data.photographer,
            center: data.center,
            keywords: data.keywords || [],
            location: data.location,
            album: data.album,
            mediaType: data.media_type,
            attribution: this.getNASAAttribution(data)
          }
        };
      }

      // Generate proper NASA attribution
      getNASAAttribution(data) {
        let attribution = 'NASA';

        if (data.center) {
          attribution += `/${data.center}`;
        }

        if (data.photographer) {
          attribution += ` - ${data.photographer}`;
        }

        return attribution;
      }

      // Enhanced NASA image categorization
      categorizeNASAImage(data) {
        const title = (data.title || '').toLowerCase();
        const description = (data.description || '').toLowerCase();
        const keywords = (data.keywords || []).join(' ').toLowerCase();
        const content = `${title} ${description} ${keywords}`;

        // Mission-related content
        const missionTerms = ['mars', 'rover', 'perseverance', 'curiosity', 'opportunity', 'mission', 'launch', 'spacecraft', 'probe', 'lander', 'orbiter', 'apollo', 'artemis'];
        if (missionTerms.some(term => content.includes(term))) {
          return 'missions';
        }

        // Earth observation
        const earthTerms = ['earth', 'planet earth', 'blue marble', 'landsat', 'terra', 'aqua', 'modis', 'hurricane', 'weather', 'climate'];
        if (earthTerms.some(term => content.includes(term))) {
          return 'earth';
        }

        // Planetary content
        const planetTerms = ['jupiter', 'saturn', 'venus', 'mercury', 'uranus', 'neptune', 'planet', 'rings', 'moons', 'europa', 'titan', 'io', 'ganymede'];
        if (planetTerms.some(term => content.includes(term))) {
          return 'planets';
        }

        // Deep space objects
        const deepSpaceTerms = ['nebula', 'galaxy', 'star', 'constellation', 'hubble', 'webb', 'telescope', 'supernova', 'black hole', 'quasar', 'pulsar', 'cosmic', 'universe'];
        if (deepSpaceTerms.some(term => content.includes(term))) {
          return 'deep-space';
        }

        // ISS and space station content
        const issTerms = ['iss', 'international space station', 'space station', 'expedition', 'spacewalk', 'eva', 'crew', 'astronaut'];
        if (issTerms.some(term => content.includes(term))) {
          return 'iss';
        }

        // Default to missions for space-related content
        return 'missions';
      }

      // Enhanced ESA Images (European Space Agency)
      async fetchESAImages() {
        const cacheKey = 'esa_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // ESA doesn't have a public API, but we can try their RSS feed
          // For now, we'll use enhanced curated content with real ESA imagery
          const images = this.getESAEnhancedContent();
          this.setCache(cacheKey, images);
          return images;
        } catch (error) {
          console.error('ESA content error:', error);

          // Report error to error manager
          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError(
              'ESA Content Error',
              'Unable to load ESA images. Using cached content.',
              'warning'
            );
          }

          return this.getESAFallback();
        }
      }

      // Enhanced ESA content with real imagery
      getESAEnhancedContent() {
        const baseTime = Date.now();

        return [
          {
            id: 'esa_gaia_1',
            title: 'Gaia\'s Stellar Census of the Milky Way',
            description: 'ESA\'s Gaia mission has created the most detailed 3D map of our galaxy, revealing the positions and motions of nearly 2 billion stars.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/06/gaia_s_stellar_motion_for_the_next_400_000_years/24302366-1-eng-GB/Gaia_s_stellar_motion_for_the_next_400_000_years_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/06/gaia_s_stellar_motion_for_the_next_400_000_years/24302366-1-eng-GB/Gaia_s_stellar_motion_for_the_next_400_000_years_pillars.jpg',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 3 * 60 * 60 * 1000), // 3 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Gaia',
            metadata: {
              mission: 'Gaia',
              type: 'Stellar Cartography',
              attribution: 'ESA/Gaia/DPAC'
            }
          },
          {
            id: 'esa_jwst_1',
            title: 'Webb Telescope - ESA Partnership',
            description: 'The James Webb Space Telescope, a collaboration between NASA, ESA, and CSA, continues to revolutionize our understanding of the cosmos.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/07/webb_s_first_deep_field/24317738-1-eng-GB/Webb_s_first_deep_field_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2022/07/webb_s_first_deep_field/24317738-1-eng-GB/Webb_s_first_deep_field_pillars.jpg',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 5 * 60 * 60 * 1000), // 5 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Webb',
            metadata: {
              mission: 'James Webb Space Telescope',
              type: 'Deep Field',
              attribution: 'NASA/ESA/CSA/STScI'
            }
          },
          {
            id: 'esa_mars_1',
            title: 'Mars Express - Red Planet Explorer',
            description: 'ESA\'s Mars Express continues its mission to study the Red Planet, providing crucial data about Mars\' atmosphere and surface.',
            imageUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2023/01/mars_express_image_of_mars/24675234-1-eng-GB/Mars_Express_image_of_Mars_pillars.jpg',
            thumbnailUrl: 'https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2023/01/mars_express_image_of_mars/24675234-1-eng-GB/Mars_Express_image_of_Mars_pillars.jpg',
            source: 'esa',
            category: 'planets',
            timestamp: new Date(baseTime - 7 * 60 * 60 * 1000), // 7 hours ago
            sourceUrl: 'https://www.esa.int/Science_Exploration/Space_Science/Mars_Express',
            metadata: {
              mission: 'Mars Express',
              type: 'Planetary Observation',
              attribution: 'ESA/DLR/FU Berlin'
            }
          }
        ];
      }

      // Enhanced SpaceX API Integration
      async fetchSpaceXImages() {
        const cacheKey = 'spacex_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch multiple recent launches for more content
          const [latestResponse, recentResponse] = await Promise.all([
            this.fetchWithRetry('https://api.spacexdata.com/v4/launches/latest'),
            this.fetchWithRetry('https://api.spacexdata.com/v4/launches/query', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: {
                  success: true,
                  'links.flickr.original': { $ne: [] }
                },
                options: {
                  limit: 5,
                  sort: { date_utc: -1 },
                  populate: ['rocket', 'payloads']
                }
              })
            })
          ]);

          const allImages = [];

          // Process latest launch
          if (latestResponse.ok) {
            const latestLaunch = await latestResponse.json();
            const latestImages = this.parseSpaceXLaunch(latestLaunch);
            allImages.push(...latestImages);
          }

          // Process recent launches
          if (recentResponse.ok) {
            const recentData = await recentResponse.json();
            if (recentData.docs) {
              recentData.docs.forEach(launch => {
                const launchImages = this.parseSpaceXLaunch(launch);
                allImages.push(...launchImages);
              });
            }
          }

          // Remove duplicates and limit results
          const uniqueImages = this.removeDuplicates(allImages).slice(0, 8);

          this.setCache(cacheKey, uniqueImages);
          return uniqueImages.length > 0 ? uniqueImages : this.getSpaceXFallback();

        } catch (error) {
          console.error('SpaceX API error:', error);

          // Report error to error manager
          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError(
              'SpaceX API Error',
              'Unable to load SpaceX launch data. Using cached content.',
              'warning'
            );
          }

          return this.getSpaceXFallback();
        }
      }

      // Enhanced SpaceX launch data parsing
      parseSpaceXLaunch(launch) {
        const images = [];

        if (launch.links && launch.links.flickr && launch.links.flickr.original && launch.links.flickr.original.length > 0) {
          const rocketName = launch.rocket?.name || 'Falcon 9';
          const flightNumber = launch.flight_number || 'Unknown';

          // Limit to 3 images per launch to avoid overwhelming
          const imageUrls = launch.links.flickr.original.slice(0, 3);

          imageUrls.forEach((imageUrl, index) => {
            let description = launch.details || `SpaceX ${launch.name} mission launch`;

            // Enhance description with mission details
            if (launch.payloads && launch.payloads.length > 0) {
              const payloadNames = launch.payloads.map(p => p.name || 'payload').join(', ');
              description += ` carrying ${payloadNames}`;
            }

            // Truncate long descriptions
            if (description.length > 200) {
              description = description.substring(0, 200) + '...';
            }

            images.push({
              id: `spacex_${launch.id}_${index}`,
              title: `${launch.name} - Flight ${flightNumber}`,
              description: description,
              imageUrl: imageUrl,
              thumbnailUrl: imageUrl,
              source: 'spacex',
              category: 'missions',
              timestamp: new Date(launch.date_utc),
              sourceUrl: launch.links.webcast || launch.links.wikipedia || 'https://www.spacex.com',
              metadata: {
                mission: launch.name,
                rocket: rocketName,
                success: launch.success,
                flightNumber: flightNumber,
                launchpad: launch.launchpad,
                payloads: launch.payloads?.map(p => p.name).join(', ') || 'Unknown',
                attribution: 'SpaceX'
              }
            });
          });
        }

        return images;
      }

      // Enhanced ISS Images (International Space Station)
      async fetchISSImages() {
        const cacheKey = 'iss_images';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Try to get ISS position for context
          const issPosition = await this.getISSPosition();

          // Generate ISS content with current position context
          const images = this.getISSEnhancedContent(issPosition);
          this.setCache(cacheKey, images);
          return images;
        } catch (error) {
          console.error('ISS content error:', error);

          // Report error to error manager
          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError(
              'ISS Content Error',
              'Unable to load ISS images. Using cached content.',
              'warning'
            );
          }

          return this.getISSFallback();
        }
      }

      // Get current ISS position
      async getISSPosition() {
        try {
          const response = await this.fetchWithRetry('http://api.open-notify.org/iss-now.json');
          if (response.ok) {
            const data = await response.json();
            return {
              latitude: parseFloat(data.iss_position.latitude),
              longitude: parseFloat(data.iss_position.longitude),
              timestamp: data.timestamp
            };
          }
        } catch (error) {
          console.warn('ISS position API unavailable:', error);
        }
        return null;
      }

      // Enhanced ISS content with position context
      getISSEnhancedContent(issPosition) {
        const baseTime = Date.now();
        const locationContext = issPosition ?
          `Currently over ${this.getLocationFromCoords(issPosition.latitude, issPosition.longitude)}` :
          'Orbiting Earth at 408 km altitude';

        return [
          {
            id: 'iss_earth_1',
            title: 'Earth from the International Space Station',
            description: `A stunning view of Earth captured from the ISS. ${locationContext}. The station completes an orbit every 90 minutes, providing astronauts with breathtaking views of our planet.`,
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            source: 'iss',
            category: 'earth',
            timestamp: new Date(baseTime - 45 * 60 * 1000), // 45 minutes ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              altitude: '408 km',
              crew: 'Expedition 70',
              attribution: 'NASA/ISS Expedition Crew',
              coordinates: issPosition
            }
          },
          {
            id: 'iss_aurora_1',
            title: 'Aurora Borealis from Space',
            description: 'A spectacular aurora borealis captured from the International Space Station, showing the dancing lights of charged particles interacting with Earth\'s magnetic field.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(baseTime - 2 * 60 * 60 * 1000), // 2 hours ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              phenomenon: 'Aurora Borealis',
              attribution: 'NASA/ISS Expedition Crew'
            }
          },
          {
            id: 'iss_spacewalk_1',
            title: 'Spacewalk Outside the ISS',
            description: 'Astronauts conducting a spacewalk (EVA) outside the International Space Station for maintenance and scientific experiments.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss067e000001/iss067e000001~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss067e000001/iss067e000001~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(baseTime - 4 * 60 * 60 * 1000), // 4 hours ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/main/index.html',
            metadata: {
              location: 'ISS',
              activity: 'Spacewalk (EVA)',
              attribution: 'NASA/ISS Expedition Crew'
            }
          }
        ];
      }

      // Simple location approximation from coordinates
      getLocationFromCoords(lat, lon) {
        // Simplified location detection - in a real app, you'd use a geocoding service
        if (lat > 60) return 'the Arctic region';
        if (lat < -60) return 'Antarctica';
        if (lat > 30 && lon > -30 && lon < 60) return 'Europe/Asia';
        if (lat > 30 && lon > -130 && lon < -60) return 'North America';
        if (lat < -30 && lon > 110 && lon < 180) return 'Australia/Oceania';
        if (lat < 30 && lat > -30 && lon > -90 && lon < -30) return 'South America';
        if (lat < 30 && lat > -30 && lon > -20 && lon < 50) return 'Africa';
        return 'the Pacific Ocean';
      }

      // Enhanced NASA Astronomy Picture of the Day
      async fetchAPOD() {
        const cacheKey = 'nasa_apod';
        const cached = this.getFromCache(cacheKey);
        if (cached) return cached;

        try {
          // Fetch current APOD and recent ones for more content
          const today = new Date();
          const dates = [];

          // Get last 5 days of APOD
          for (let i = 0; i < 5; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            dates.push(date.toISOString().split('T')[0]);
          }

          const apodImages = [];

          for (const date of dates) {
            try {
              const response = await this.fetchWithRetry(
                `https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&date=${date}`
              );

              if (response.ok) {
                const data = await response.json();

                if (data.media_type === 'image' && data.url) {
                  // Truncate long descriptions
                  let description = data.explanation || 'Astronomy Picture of the Day from NASA';
                  if (description.length > 300) {
                    description = description.substring(0, 300) + '...';
                  }

                  const image = {
                    id: `apod_${data.date}`,
                    title: `APOD: ${data.title}`,
                    description: description,
                    imageUrl: data.hdurl || data.url,
                    thumbnailUrl: data.url,
                    source: 'nasa',
                    category: 'deep-space',
                    timestamp: new Date(data.date),
                    sourceUrl: `https://apod.nasa.gov/apod/ap${data.date.replace(/-/g, '').substring(2)}.html`,
                    metadata: {
                      copyright: data.copyright,
                      type: 'APOD',
                      date: data.date,
                      attribution: data.copyright ? `© ${data.copyright}` : 'NASA APOD',
                      hdUrl: data.hdurl
                    }
                  };

                  apodImages.push(image);
                }
              }
            } catch (dateError) {
              console.warn(`APOD fetch failed for ${date}:`, dateError);
            }
          }

          this.setCache(cacheKey, apodImages);
          return apodImages;

        } catch (error) {
          console.error('APOD API error:', error);
          return this.getAPODFallback();
        }
      }

      // APOD fallback data
      getAPODFallback() {
        return [
          {
            id: 'apod_fallback_1',
            title: 'APOD: Webb\'s First Deep Field',
            description: 'NASA\'s James Webb Space Telescope has delivered the deepest and sharpest infrared image of the distant universe so far.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA24825/PIA24825~thumb.jpg',
            source: 'nasa',
            category: 'deep-space',
            timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000), // 5 hours ago
            sourceUrl: 'https://apod.nasa.gov/',
            metadata: {
              type: 'APOD',
              attribution: 'NASA/ESA/CSA/STScI'
            }
          }
        ];
      }

      // Combine and sort images from all sources
      combineAndSort(imageArrays) {
        const allImages = imageArrays.flat();

        // Remove duplicates based on title similarity
        const uniqueImages = this.removeDuplicates(allImages);

        // Sort by timestamp (newest first)
        return uniqueImages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      }

      // Remove duplicate images
      removeDuplicates(images) {
        const seen = new Set();
        return images.filter(image => {
          const key = image.title.toLowerCase().replace(/[^a-z0-9]/g, '');
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      // Filter images by category
      filterByCategory(images, category) {
        if (category === 'all') return images;
        return images.filter(image => image.category === category);
      }

      // Fetch with retry logic
      async fetchWithRetry(url, attempts = this.retryAttempts) {
        for (let i = 0; i < attempts; i++) {
          try {
            const response = await fetch(url);
            if (response.ok) return response;
            throw new Error(`HTTP ${response.status}`);
          } catch (error) {
            if (i === attempts - 1) throw error;
            await this.delay(this.retryDelay * Math.pow(2, i)); // Exponential backoff
          }
        }
      }

      // Utility methods
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      getFromCache(key) {
        const cached = this.cache.get(key);
        if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
          return cached.data;
        }
        return null;
      }

      setCache(key, data) {
        this.cache.set(key, {
          data: data,
          timestamp: Date.now()
        });
      }

      getPlaceholderImage() {
        return 'https://via.placeholder.com/400x225/0033a0/ffffff?text=Space+Image';
      }

      // Fallback data when APIs are unavailable
      getFallbackImages() {
        return [
          ...this.getNASAFallback(),
          ...this.getESAFallback(),
          ...this.getSpaceXFallback(),
          ...this.getISSFallback()
        ];
      }

      getNASAFallback() {
        return [
          {
            id: 'nasa_fallback_1',
            title: 'Perseverance Mars Rover Self-Portrait',
            description: 'NASA\'s Perseverance rover took this selfie over a rock nicknamed "Rochette," on Sol 198.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA24546/PIA24546~thumb.jpg',
            source: 'nasa',
            category: 'missions',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            sourceUrl: 'https://images.nasa.gov/',
            metadata: { mission: 'Mars 2020' }
          },
          {
            id: 'nasa_fallback_2',
            title: 'Hubble Views the Crab Nebula',
            description: 'This Hubble Space Telescope image shows the Crab Nebula, the result of a supernova explosion.',
            imageUrl: 'https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/PIA23122/PIA23122~thumb.jpg',
            source: 'nasa',
            category: 'deep-space',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
            sourceUrl: 'https://images.nasa.gov/',
            metadata: { telescope: 'Hubble' }
          }
        ];
      }

      getESAFallback() {
        const baseTime = Date.now();
        return [
          {
            id: 'esa_fallback_1',
            title: 'Gaia\'s Stellar Census',
            description: 'ESA\'s Gaia mission has created the most detailed 3D map of our galaxy, cataloging nearly 2 billion stars.',
            imageUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Gaia+Mission',
            thumbnailUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Gaia+Mission',
            source: 'esa',
            category: 'deep-space',
            timestamp: new Date(baseTime - 6 * 60 * 60 * 1000), // 6 hours ago
            sourceUrl: 'https://www.esa.int/',
            metadata: {
              mission: 'Gaia',
              type: 'Stellar Cartography',
              attribution: 'ESA/Gaia/DPAC'
            }
          },
          {
            id: 'esa_fallback_2',
            title: 'BepiColombo Mercury Mission',
            description: 'ESA\'s BepiColombo mission continues its journey to Mercury, studying the innermost planet of our solar system.',
            imageUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+BepiColombo',
            thumbnailUrl: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+BepiColombo',
            source: 'esa',
            category: 'missions',
            timestamp: new Date(baseTime - 8 * 60 * 60 * 1000), // 8 hours ago
            sourceUrl: 'https://www.esa.int/',
            metadata: {
              mission: 'BepiColombo',
              target: 'Mercury',
              attribution: 'ESA/JAXA'
            }
          }
        ];
      }

      getSpaceXFallback() {
        const baseTime = Date.now();
        return [
          {
            id: 'spacex_fallback_1',
            title: 'Falcon Heavy - Arabsat-6A Mission',
            description: 'SpaceX Falcon Heavy rocket launches the Arabsat-6A communications satellite, demonstrating the power of reusable rocket technology.',
            imageUrl: 'https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/KSC-20200530-PH-SPX01_0005/KSC-20200530-PH-SPX01_0005~thumb.jpg',
            source: 'spacex',
            category: 'missions',
            timestamp: new Date(baseTime - 3 * 60 * 60 * 1000), // 3 hours ago
            sourceUrl: 'https://www.spacex.com/',
            metadata: {
              rocket: 'Falcon Heavy',
              mission: 'Arabsat-6A',
              attribution: 'SpaceX'
            }
          },
          {
            id: 'spacex_fallback_2',
            title: 'Starship Development Test',
            description: 'SpaceX continues development of Starship, the next-generation spacecraft designed for missions to Mars and beyond.',
            imageUrl: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Starship',
            thumbnailUrl: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Starship',
            source: 'spacex',
            category: 'missions',
            timestamp: new Date(baseTime - 6 * 60 * 60 * 1000), // 6 hours ago
            sourceUrl: 'https://www.spacex.com/',
            metadata: {
              rocket: 'Starship',
              mission: 'Development Test',
              attribution: 'SpaceX'
            }
          }
        ];
      }

      getISSFallback() {
        return [
          {
            id: 'iss_fallback_1',
            title: 'Earth from the International Space Station',
            description: 'A stunning view of Earth\'s curvature captured from the International Space Station.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e013602/iss066e013602~thumb.jpg',
            source: 'iss',
            category: 'earth',
            timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000), // 1 hour ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/',
            metadata: { location: 'ISS' }
          },
          {
            id: 'iss_fallback_2',
            title: 'Aurora from Space',
            description: 'A spectacular aurora borealis captured from the International Space Station.',
            imageUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            thumbnailUrl: 'https://images-assets.nasa.gov/image/iss066e054063/iss066e054063~thumb.jpg',
            source: 'iss',
            category: 'iss',
            timestamp: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
            sourceUrl: 'https://www.nasa.gov/mission_pages/station/',
            metadata: { location: 'ISS', phenomenon: 'Aurora' }
          }
        ];
      }
    }

    // Initialize the data manager
    const imageDataManager = new ImageDataManager();

    // Global image data store for interaction handling
    let currentImageData = [];

    // Performance monitoring
    const performanceMonitor = {
      startTime: Date.now(),
      imageLoadTimes: [],

      recordImageLoad(startTime, endTime, success = true) {
        this.imageLoadTimes.push({
          duration: endTime - startTime,
          success: success,
          timestamp: Date.now()
        });
      },

      getAverageLoadTime() {
        const successfulLoads = this.imageLoadTimes.filter(load => load.success);
        if (successfulLoads.length === 0) return 0;

        const total = successfulLoads.reduce((sum, load) => sum + load.duration, 0);
        return Math.round(total / successfulLoads.length);
      },

      getLoadSuccessRate() {
        if (this.imageLoadTimes.length === 0) return 100;

        const successful = this.imageLoadTimes.filter(load => load.success).length;
        return Math.round((successful / this.imageLoadTimes.length) * 100);
      },

      logPerformanceStats() {
        console.log('🚀 Performance Stats:', {
          averageImageLoadTime: `${this.getAverageLoadTime()}ms`,
          loadSuccessRate: `${this.getLoadSuccessRate()}%`,
          totalImagesLoaded: this.imageLoadTimes.length,
          pageLoadTime: `${Date.now() - this.startTime}ms`
        });
      }
    };
  </script>
  <script>
    (function initTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") { document.body.classList.add("dark"); document.getElementById("themeToggle").textContent = "☀️"; }
      document.getElementById("themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        document.getElementById("themeToggle").textContent = isDark ? "☀️" : "🌙";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });
    })();

    (function stickyDropdowns() {
      const OPEN = "open"; const DELAY = 160;
      document.querySelectorAll(".dropdown").forEach(dd => {
        let t = null; const btn = dd.querySelector(".dropbtn"); const menu = dd.querySelector(".dropdown-content");
        function open() { dd.classList.add(OPEN); btn?.setAttribute("aria-expanded", "true"); if (t) { clearTimeout(t); t = null; } }
        function close() { if (t) clearTimeout(t); t = setTimeout(() => { dd.classList.remove(OPEN); btn?.setAttribute("aria-expanded", "false"); }, DELAY); }
        dd.addEventListener("pointerenter", open); dd.addEventListener("pointerleave", close);
        btn?.addEventListener("focus", open);
        menu?.addEventListener("focusout", e => { if (!dd.contains(e.relatedTarget)) close(); });
        menu?.querySelectorAll("a").forEach(a => { a.addEventListener("click", () => { menu.querySelectorAll("a").forEach(el => el.classList.remove("clicked")); a.classList.add("clicked"); dd.classList.remove(OPEN); btn?.setAttribute("aria-expanded", "false"); }); });
      });
    })();

    (function initMoonPhase() {
      function getMoonPhase() {
        const now = new Date(); const m = now.getMonth() + 1; const d = now.getDate(); const y = now.getFullYear();
        if (y === 2025 && m === 8) {
          if (d <= 3) return 7; if (d <= 6) return 0; if (d <= 10) return 1; if (d <= 13) return 2; if (d <= 17) return 3; if (d <= 20) return 4; if (d <= 24) return 5; if (d <= 27) return 6; return 7;
        }
        const base = new Date(2024, 7, 4); const days = (now - base) / (1000 * 60 * 60 * 24); const cycle = days / 29.53; return Math.floor((cycle - Math.floor(cycle)) * 8) % 8;
      }
      function info(p) { return [{ name: "New Moon", emoji: "🌑" }, { name: "Waxing Crescent", emoji: "🌒" }, { name: "First Quarter", emoji: "🌓" }, { name: "Waxing Gibbous", emoji: "🌔" }, { name: "Full Moon", emoji: "🌕" }, { name: "Waning Gibbous", emoji: "🌖" }, { name: "Last Quarter", emoji: "🌗" }, { name: "Waning Crescent", emoji: "🌘" }][p]; }
      const phase = getMoonPhase(), data = info(phase), now = new Date();
      document.getElementById("moon-display").textContent = data.emoji;
      document.querySelector(".moon-label").textContent = data.name;
      document.getElementById("moon-context").textContent = `${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} • New York City, NY`;
    })();

    // Enhanced Image Modal System
    (function initImageModal() {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const modalTitle = document.querySelector('.modal-title');
      const modalDescription = document.querySelector('.modal-description');
      const modalSource = document.querySelector('.modal-source');
      const modalDate = document.querySelector('.modal-date');
      const modalCategory = document.querySelector('.modal-category');
      const modalMission = document.querySelector('.modal-mission');
      const modalMissionName = document.querySelector('.modal-mission-name');
      const modalInstrument = document.querySelector('.modal-instrument');
      const modalInstrumentName = document.querySelector('.modal-instrument-name');
      const modalLocation = document.querySelector('.modal-location');
      const modalLocationName = document.querySelector('.modal-location-name');
      const modalTechnicalInfo = document.querySelector('.modal-technical-info');
      const modalResolution = document.querySelector('.modal-resolution');
      const modalResolutionValue = document.querySelector('.modal-resolution-value');
      const modalCoordinates = document.querySelector('.modal-coordinates');
      const modalCoordinatesValue = document.querySelector('.modal-coordinates-value');
      const modalAltitude = document.querySelector('.modal-altitude');
      const modalAltitudeValue = document.querySelector('.modal-altitude-value');
      const modalKeywords = document.querySelector('.modal-keywords');
      const keywordsContainer = document.querySelector('.keywords-container');
      const modalAttribution = document.querySelector('.modal-attribution');
      const modalSourceLink = document.getElementById('modal-source-link');
      const modalLoading = document.querySelector('.modal-loading');

      const closeBtn = document.querySelector('.modal-close');
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      const shareBtn = document.getElementById('modal-share');
      const downloadBtn = document.getElementById('modal-download');
      const favoriteBtn = document.getElementById('modal-favorite');
      const fullscreenBtn = document.getElementById('modal-fullscreen');
      const infoToggleBtn = document.getElementById('modal-info-toggle');
      const socialShareMenu = document.getElementById('social-share-menu');

      let currentImageIndex = 0;
      let filteredImages = [];

      // Open modal with image data
      function openModal(imageId) {
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        // Get current filtered images for navigation
        filteredImages = getCurrentFilteredImages();
        currentImageIndex = filteredImages.findIndex(img => img.id === imageId);

        // Show modal
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        modal.setAttribute('aria-hidden', 'false');

        // Load image data
        loadModalImage(imageData);

        // Update navigation buttons
        updateNavigationButtons();

        // Focus management
        closeBtn.focus();
      }

      // Load image and metadata into modal
      function loadModalImage(imageData) {
        // Show loading state
        modalLoading.style.display = 'flex';
        modalImage.style.opacity = '0';

        // Load high-resolution image
        const highResImage = new Image();

        highResImage.onload = function () {
          modalImage.src = imageData.imageUrl;
          modalImage.alt = imageData.title;
          modalLoading.style.display = 'none';
          modalImage.style.opacity = '1';
        };

        highResImage.onerror = function () {
          modalImage.src = imageData.thumbnailUrl;
          modalImage.alt = imageData.title;
          modalLoading.style.display = 'none';
          modalImage.style.opacity = '1';
        };

        // Start loading
        highResImage.src = imageData.imageUrl;

        // Update metadata
        modalTitle.textContent = imageData.title;
        modalDescription.textContent = imageData.description;
        modalSource.textContent = imageData.source.toUpperCase();
        modalDate.textContent = formatModalDate(imageData.timestamp);
        modalDate.setAttribute('datetime', imageData.timestamp.toISOString());
        modalCategory.textContent = formatCategory(imageData.category);

        // Update mission info if available
        if (imageData.metadata?.mission) {
          modalMission.style.display = 'block';
          modalMissionName.textContent = imageData.metadata.mission;
        } else {
          modalMission.style.display = 'none';
        }

        // Update instrument info if available
        if (imageData.metadata?.instrument) {
          modalInstrument.style.display = 'block';
          modalInstrumentName.textContent = imageData.metadata.instrument;
        } else {
          modalInstrument.style.display = 'none';
        }

        // Update location info if available
        if (imageData.metadata?.location) {
          modalLocation.style.display = 'block';
          modalLocationName.textContent = imageData.metadata.location;
        } else {
          modalLocation.style.display = 'none';
        }

        // Update technical information
        updateTechnicalInfo(imageData);

        // Update keywords
        updateKeywords(imageData);

        // Update attribution
        const attribution = imageData.metadata?.attribution || `${imageData.source.toUpperCase()}`;
        modalAttribution.textContent = attribution;

        // Update source link
        modalSourceLink.href = imageData.sourceUrl;

        // Update favorite status
        updateFavoriteStatus(imageData.id);

        // Store current image data for actions
        modal.dataset.currentImageId = imageData.id;
      }

      // Get currently filtered images
      function getCurrentFilteredImages() {
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
        if (activeFilter === 'all') {
          return currentImageData;
        }
        return currentImageData.filter(img => img.category === activeFilter);
      }

      // Update navigation button states
      function updateNavigationButtons() {
        prevBtn.disabled = currentImageIndex <= 0;
        nextBtn.disabled = currentImageIndex >= filteredImages.length - 1;
      }

      // Navigate to previous image
      function navigatePrevious() {
        if (currentImageIndex > 0) {
          currentImageIndex--;
          const imageData = filteredImages[currentImageIndex];
          loadModalImage(imageData);
          updateNavigationButtons();
        }
      }

      // Navigate to next image
      function navigateNext() {
        if (currentImageIndex < filteredImages.length - 1) {
          currentImageIndex++;
          const imageData = filteredImages[currentImageIndex];
          loadModalImage(imageData);
          updateNavigationButtons();
        }
      }

      // Close modal
      function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        modal.setAttribute('aria-hidden', 'true');

        // Clear image source to save memory
        setTimeout(() => {
          modalImage.src = '';
        }, 300);
      }

      // Format date for modal display
      function formatModalDate(timestamp) {
        return new Date(timestamp).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Format category for display
      function formatCategory(category) {
        const categoryMap = {
          'missions': 'Space Missions',
          'deep-space': 'Deep Space',
          'earth': 'Earth Observation',
          'planets': 'Planetary Science',
          'iss': 'International Space Station'
        };
        return categoryMap[category] || category;
      }

      // Enhanced share functionality
      function shareImage() {
        const imageId = modal.dataset.currentImageId;
        if (window.livestreamSocialManager) {
          livestreamSocialManager.shareImage(imageId, 'native');
        } else {
          // Fallback to original functionality
          const imageData = currentImageData.find(img => img.id === imageId);
          if (!imageData) return;

          const shareData = {
            title: imageData.title,
            text: `Check out this amazing space image: ${imageData.title}`,
            url: `${window.location.href}#image-${imageId}`
          };

          if (navigator.share) {
            navigator.share(shareData);
          } else {
            const shareText = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
            navigator.clipboard.writeText(shareText).then(() => {
              showToast('Link copied to clipboard!');
            }).catch(() => {
              prompt('Copy this link to share:', shareData.url);
            });
          }
        }
      }

      // Download functionality
      function downloadImage() {
        const imageId = modal.dataset.currentImageId;
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        const link = document.createElement('a');
        link.href = imageData.imageUrl;
        link.download = `${imageData.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Update technical information
      function updateTechnicalInfo(imageData) {
        let hasInfo = false;

        // Resolution info
        if (imageData.metadata?.resolution) {
          modalResolution.style.display = 'block';
          modalResolutionValue.textContent = imageData.metadata.resolution;
          hasInfo = true;
        } else {
          modalResolution.style.display = 'none';
        }

        // Coordinates info (for ISS images)
        if (imageData.metadata?.coordinates) {
          modalCoordinates.style.display = 'block';
          const coords = imageData.metadata.coordinates;
          modalCoordinatesValue.textContent = `${coords.latitude.toFixed(2)}°, ${coords.longitude.toFixed(2)}°`;
          hasInfo = true;
        } else {
          modalCoordinates.style.display = 'none';
        }

        // Altitude info (for ISS images)
        if (imageData.metadata?.altitude) {
          modalAltitude.style.display = 'block';
          modalAltitudeValue.textContent = imageData.metadata.altitude;
          hasInfo = true;
        } else {
          modalAltitude.style.display = 'none';
        }

        // Show/hide technical info section
        modalTechnicalInfo.style.display = hasInfo ? 'block' : 'none';
      }

      // Update keywords display
      function updateKeywords(imageData) {
        keywordsContainer.innerHTML = '';

        if (imageData.metadata?.keywords && imageData.metadata.keywords.length > 0) {
          imageData.metadata.keywords.forEach(keyword => {
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.textContent = keyword;
            keywordsContainer.appendChild(tag);
          });
          modalKeywords.style.display = 'block';
        } else {
          modalKeywords.style.display = 'none';
        }
      }

      // Favorites management
      function getFavorites() {
        return JSON.parse(localStorage.getItem('space-image-favorites') || '[]');
      }

      function addToFavorites(imageId) {
        const favorites = getFavorites();
        if (!favorites.includes(imageId)) {
          favorites.push(imageId);
          localStorage.setItem('space-image-favorites', JSON.stringify(favorites));
          showToast('Added to favorites!');
        }
      }

      function removeFromFavorites(imageId) {
        const favorites = getFavorites();
        const index = favorites.indexOf(imageId);
        if (index > -1) {
          favorites.splice(index, 1);
          localStorage.setItem('space-image-favorites', JSON.stringify(favorites));
          showToast('Removed from favorites');
        }
      }

      function updateFavoriteStatus(imageId) {
        const favorites = getFavorites();
        const isFavorite = favorites.includes(imageId);
        favoriteBtn.classList.toggle('active', isFavorite);
        favoriteBtn.title = isFavorite ? 'Remove from Favorites' : 'Add to Favorites';
      }

      // Toggle technical info visibility
      function toggleTechnicalInfo() {
        const isVisible = modalTechnicalInfo.style.display !== 'none';
        modalTechnicalInfo.style.display = isVisible ? 'none' : 'block';
        modalKeywords.style.display = isVisible ? 'none' : 'block';
        infoToggleBtn.classList.toggle('active', !isVisible);
      }

      // Fullscreen functionality
      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          modalImage.requestFullscreen().catch(err => {
            showToast('Fullscreen not supported');
          });
        } else {
          document.exitFullscreen();
        }
      }

      // Enhanced social sharing
      function shareToSocial(platform) {
        const imageId = modal.dataset.currentImageId;
        const imageData = currentImageData.find(img => img.id === imageId);
        if (!imageData) return;

        const url = `${window.location.href}#image-${imageId}`;
        const text = `Check out this amazing space image: ${imageData.title}`;

        let shareUrl = '';

        switch (platform) {
          case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            break;
          case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            break;
          case 'reddit':
            shareUrl = `https://reddit.com/submit?title=${encodeURIComponent(imageData.title)}&url=${encodeURIComponent(url)}`;
            break;
          case 'copy':
            navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
              showToast('Link copied to clipboard!');
            });
            return;
        }

        if (shareUrl) {
          window.open(shareUrl, '_blank', 'width=600,height=400');
        }
      }

      // Toggle social share menu
      function toggleSocialShareMenu() {
        const isVisible = socialShareMenu.style.display !== 'none';
        socialShareMenu.style.display = isVisible ? 'none' : 'block';
      }

      // Show auto-refresh status
      function showAutoRefreshStatus(message, type = 'info') {
        const statusElement = document.getElementById('auto-refresh-status');
        const statusText = statusElement.querySelector('.status-text');

        statusText.textContent = message;
        statusElement.className = `auto-refresh-status visible ${type}`;

        // Auto-hide after 3 seconds
        setTimeout(() => {
          statusElement.classList.remove('visible');
        }, 3000);
      }

      // Show toast notification
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 2em;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 1em 2em;
          border-radius: 8px;
          z-index: 10002;
          font-size: 0.9em;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 3000);
      }

      // Event listeners
      document.addEventListener('click', function (e) {
        // Handle expand button clicks
        if (e.target.classList.contains('expand-btn')) {
          e.preventDefault();
          const imageId = e.target.dataset.imageId;
          openModal(imageId);
        }

        // Handle gallery share button clicks
        if (e.target.classList.contains('share-btn') && !e.target.id) {
          e.preventDefault();
          const imageId = e.target.dataset.imageId;

          if (window.livestreamSocialManager) {
            livestreamSocialManager.shareImage(imageId, 'native');
          } else {
            // Fallback functionality
            const imageData = currentImageData.find(img => img.id === imageId);
            if (imageData) {
              const shareData = {
                title: imageData.title,
                text: `Check out this space image: ${imageData.title}`,
                url: window.location.href
              };

              if (navigator.share) {
                navigator.share(shareData);
              } else {
                navigator.clipboard.writeText(`${shareData.title} - ${shareData.url}`).then(() => {
                  showToast('Link copied to clipboard!');
                });
              }
            }
          }
        }
      });

      // Modal event listeners
      closeBtn.addEventListener('click', closeModal);
      prevBtn.addEventListener('click', navigatePrevious);
      nextBtn.addEventListener('click', navigateNext);
      shareBtn.addEventListener('click', toggleSocialShareMenu);
      downloadBtn.addEventListener('click', downloadImage);
      favoriteBtn.addEventListener('click', function () {
        const imageId = modal.dataset.currentImageId;
        const favorites = getFavorites();
        if (favorites.includes(imageId)) {
          removeFromFavorites(imageId);
        } else {
          addToFavorites(imageId);
        }
        updateFavoriteStatus(imageId);
      });
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      infoToggleBtn.addEventListener('click', toggleTechnicalInfo);

      // Social sharing event listeners
      document.addEventListener('click', function (e) {
        if (e.target.closest('.social-btn')) {
          const platform = e.target.closest('.social-btn').dataset.platform;
          shareToSocial(platform);
        }
      });

      // Close modal when clicking overlay
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', function (e) {
        if (modal.classList.contains('active')) {
          switch (e.key) {
            case 'Escape':
              closeModal();
              break;
            case 'ArrowLeft':
              navigatePrevious();
              break;
            case 'ArrowRight':
              navigateNext();
              break;
          }
        }

        // Handle expand/share button keyboard activation
        if (e.key === 'Enter' || e.key === ' ') {
          if (e.target.classList.contains('expand-btn') || e.target.classList.contains('share-btn')) {
            e.preventDefault();
            e.target.click();
          }
        }
      });
    })();

    // Filter and Controls Functionality
    (function initControls() {
      const gallery = document.getElementById('image-gallery');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const viewBtns = document.querySelectorAll('.view-btn');
      const refreshBtn = document.querySelector('.refresh-btn');
      const lastRefreshTime = document.getElementById('last-refresh');

      let currentFilter = 'all';
      let currentView = 'grid';
      let currentSearch = '';
      let currentSourceFilter = 'all';
      let currentDateFilter = 'all';
      let currentSort = 'date-desc';

      // Enhanced filter functionality
      function filterImages(category = currentFilter) {
        currentFilter = category;
        applyAllFilters();

        // Update active filter button
        filterBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === category);
        });
      }

      // Apply all active filters
      function applyAllFilters() {
        const cards = Array.from(gallery.querySelectorAll('.image-card'));
        let visibleCount = 0;

        cards.forEach(card => {
          const shouldShow = passesAllFilters(card);

          if (shouldShow) {
            card.style.display = 'block';
            card.style.animation = 'fadeIn 0.3s ease-in-out';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Sort visible cards
        sortVisibleCards();

        // Update results count
        updateResultsCount(visibleCount, cards.length);
      }

      // Check if card passes all active filters
      function passesAllFilters(card) {
        const cardCategory = card.dataset.category;
        const cardSource = card.dataset.source;
        const cardImageId = card.dataset.imageId;

        // Find image data for this card
        const imageData = currentImageData.find(img => img.id === cardImageId);
        if (!imageData) return false;

        // Category filter
        if (currentFilter !== 'all' && cardCategory !== currentFilter) {
          return false;
        }

        // Source filter
        if (currentSourceFilter !== 'all' && cardSource !== currentSourceFilter) {
          return false;
        }

        // Date filter
        if (!passesDateFilter(imageData)) {
          return false;
        }

        // Search filter
        if (currentSearch && !passesSearchFilter(imageData)) {
          return false;
        }

        return true;
      }

      // Check if image passes date filter
      function passesDateFilter(imageData) {
        if (currentDateFilter === 'all') return true;

        const imageDate = new Date(imageData.timestamp);
        const now = new Date();

        switch (currentDateFilter) {
          case 'today':
            return imageDate.toDateString() === now.toDateString();
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return imageDate >= weekAgo;
          case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            return imageDate >= monthAgo;
          default:
            return true;
        }
      }

      // Check if image passes search filter
      function passesSearchFilter(imageData) {
        if (!currentSearch) return true;

        const searchTerm = currentSearch.toLowerCase();
        const searchableText = [
          imageData.title,
          imageData.description,
          imageData.source,
          imageData.category,
          imageData.metadata?.mission || '',
          imageData.metadata?.instrument || '',
          imageData.metadata?.location || '',
          ...(imageData.metadata?.keywords || [])
        ].join(' ').toLowerCase();

        return searchableText.includes(searchTerm);
      }

      // Sort visible cards
      function sortVisibleCards() {
        const visibleCards = Array.from(gallery.querySelectorAll('.image-card[style*="block"]'));

        visibleCards.sort((a, b) => {
          const aData = currentImageData.find(img => img.id === a.dataset.imageId);
          const bData = currentImageData.find(img => img.id === b.dataset.imageId);

          if (!aData || !bData) return 0;

          switch (currentSort) {
            case 'date-desc':
              return new Date(bData.timestamp) - new Date(aData.timestamp);
            case 'date-asc':
              return new Date(aData.timestamp) - new Date(bData.timestamp);
            case 'title-asc':
              return aData.title.localeCompare(bData.title);
            case 'source-asc':
              return aData.source.localeCompare(bData.source);
            default:
              return 0;
          }
        });

        // Reorder DOM elements
        visibleCards.forEach(card => {
          gallery.appendChild(card);
        });
      }

      // Update results count display
      function updateResultsCount(visible, total) {
        let countElement = document.getElementById('results-count');
        if (!countElement) {
          countElement = document.createElement('div');
          countElement.id = 'results-count';
          countElement.className = 'results-count';
          gallery.parentNode.insertBefore(countElement, gallery);
        }

        if (visible === total) {
          countElement.textContent = `Showing all ${total} images`;
        } else {
          countElement.textContent = `Showing ${visible} of ${total} images`;
        }

        countElement.style.cssText = `
          text-align: center;
          margin-bottom: 1em;
          font-size: 0.9em;
          color: #666;
          font-style: italic;
        `;
      }

      // View switching functionality
      function switchView(view) {
        if (view === 'list') {
          gallery.classList.add('list-view');
        } else {
          gallery.classList.remove('list-view');
        }

        // Update active view button
        viewBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === view);
        });

        currentView = view;
      }

      // Enhanced refresh functionality
      async function refreshGallery() {
        const startTime = performance.now();
        refreshBtn.classList.add('spinning');

        try {
          // Fetch fresh data from all sources
          const images = await imageDataManager.fetchAllImages();

          // Check if we got new content
          const hasNewContent = images.length !== currentImageData.length ||
            images.some((img, index) => img.id !== currentImageData[index]?.id);

          // Update the gallery with new images
          await updateGalleryWithImages(images);

          updateLastRefreshTime();

          // Re-apply all filters to maintain state
          applyAllFilters();

          const endTime = performance.now();
          const refreshTime = Math.round(endTime - startTime);

          // Show success feedback
          const originalText = refreshBtn.title;
          refreshBtn.title = `Refreshed in ${refreshTime}ms`;
          setTimeout(() => {
            refreshBtn.title = originalText;
          }, 2000);

          // Show status for auto-refresh
          if (hasNewContent) {
            showAutoRefreshStatus(`Gallery updated with fresh content (${refreshTime}ms)`, 'success');
          } else {
            showAutoRefreshStatus(`No new content available (${refreshTime}ms)`, 'info');
          }

          return true; // Success

        } catch (error) {
          console.error('Refresh failed:', error);

          // Show error feedback
          const originalText = refreshBtn.title;
          refreshBtn.title = 'Refresh failed - try again';
          setTimeout(() => {
            refreshBtn.title = originalText;
          }, 3000);

          showAutoRefreshStatus('Refresh failed - check connection', 'error');

          // Report to error manager
          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError(
              'Refresh Failed',
              'Unable to refresh gallery content. Please check your internet connection.',
              'error'
            );
          }

          throw error; // Re-throw for auto-refresh manager

        } finally {
          refreshBtn.classList.remove('spinning');
        }
      }

      // Update gallery with new image data
      async function updateGalleryWithImages(images) {
        // Store image data globally for interaction handling
        currentImageData = images;

        // Clear existing content
        gallery.innerHTML = '';

        // Add loading indicator
        gallery.innerHTML = '<div class="loading-message">Loading fresh space imagery...</div>';

        // Simulate loading delay for better UX
        await new Promise(resolve => setTimeout(resolve, 500));

        // Clear loading message
        gallery.innerHTML = '';

        // Create image cards from data with performance optimization
        const fragment = document.createDocumentFragment();

        images.forEach((imageData, index) => {
          const card = createImageCard(imageData, index);
          fragment.appendChild(card);
        });

        // Batch DOM update for better performance
        gallery.appendChild(fragment);

        // Reinitialize lazy loading for new images
        initializeLazyLoading();

        // Log NASA API integration success
        const nasaImages = images.filter(img => img.source === 'nasa');
        console.log(`NASA API Integration: Loaded ${nasaImages.length} images from NASA sources`);
      }

      // Enhanced image card creation with performance optimizations
      function createImageCard(imageData, index = 0) {
        const card = document.createElement('article');
        card.className = 'image-card';
        card.dataset.category = imageData.category;
        card.dataset.source = imageData.source;
        card.dataset.imageId = imageData.id;

        const timeAgo = getTimeAgo(imageData.timestamp);
        const attribution = imageData.metadata?.attribution || imageData.source.toUpperCase();

        // Add NASA-specific styling for APOD images
        const isAPOD = imageData.metadata?.type === 'APOD';
        const apodClass = isAPOD ? ' apod-image' : '';

        // Determine loading strategy based on position
        const isAboveFold = index < 4; // First 4 images are above fold
        const loadingStrategy = isAboveFold ? 'eager' : 'lazy';
        const priority = isAboveFold ? 'high' : 'low';

        // Optimize image URLs for different screen sizes
        const optimizedImageUrl = getOptimizedImageUrl(imageData.thumbnailUrl, imageData.imageUrl);
        const fallbackUrl = getImageFallback(imageData.source);

        card.innerHTML = `
          <div class="image-container${apodClass}">
            <img ${isAboveFold ? `src="${optimizedImageUrl}"` : `data-src="${optimizedImageUrl}"`}
                 alt="${escapeHtml(imageData.title)}" 
                 loading="${loadingStrategy}"
                 data-priority="${priority}"
                 data-source="${imageData.source}"
                 decoding="async"
                 onerror="this.src='${fallbackUrl}'; this.classList.add('error');">
            <div class="image-overlay">
              <button class="overlay-btn expand-btn" title="View Full Size" data-image-id="${imageData.id}">🔍</button>
              <button class="overlay-btn share-btn" title="Share Image" data-image-id="${imageData.id}">📤</button>
            </div>
            ${isAPOD ? '<div class="apod-badge">APOD</div>' : ''}
          </div>
          <div class="image-info">
            <h3 class="image-title">${escapeHtml(imageData.title)}</h3>
            <p class="image-description">${escapeHtml(imageData.description)}</p>
            <div class="image-meta">
              <span class="source" title="${escapeHtml(attribution)}">${imageData.source.toUpperCase()}</span>
              <time class="timestamp" datetime="${imageData.timestamp.toISOString()}">${timeAgo}</time>
            </div>
            ${imageData.metadata?.copyright ? `<div class="image-attribution">© ${escapeHtml(imageData.metadata.copyright)}</div>` : ''}
          </div>
        `;

        return card;
      }

      // Optimize image URLs based on screen size and connection
      function getOptimizedImageUrl(thumbnailUrl, fullUrl) {
        // Check for mobile device
        const isMobile = window.innerWidth <= 768;

        // Check for high DPI displays
        const isHighDPI = window.devicePixelRatio > 1.5;

        // Check connection speed (if available)
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');

        // Mobile-specific optimizations
        if (isMobile) {
          // Always use thumbnails on slow connections
          if (isSlowConnection) {
            return thumbnailUrl;
          }

          // Use thumbnails on small screens even with fast connection
          if (window.innerWidth <= 480) {
            return thumbnailUrl;
          }

          // Use full resolution only for high DPI mobile displays with good connection
          if (isHighDPI && !isSlowConnection && fullUrl && fullUrl !== thumbnailUrl) {
            return fullUrl;
          }

          return thumbnailUrl;
        }

        // Desktop behavior (existing logic)
        if (isHighDPI && !isSlowConnection && fullUrl && fullUrl !== thumbnailUrl) {
          return fullUrl;
        }

        return thumbnailUrl;
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Calculate time ago string
      function getTimeAgo(timestamp) {
        const now = new Date();
        const diff = now - new Date(timestamp);
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (minutes < 60) {
          return minutes <= 1 ? 'just now' : `${minutes} minutes ago`;
        } else if (hours < 24) {
          return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
        } else {
          return days === 1 ? '1 day ago' : `${days} days ago`;
        }
      }

      // Enhanced lazy loading with performance optimizations
      function initializeLazyLoading() {
        if ('IntersectionObserver' in window) {
          // Create optimized intersection observer
          const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                loadImageWithOptimization(img, observer);
              }
            });
          }, {
            // Load images when they're 100px away from viewport
            rootMargin: '100px 0px',
            // Trigger when 10% of image is visible
            threshold: 0.1
          });

          // Observe all images that need lazy loading
          document.querySelectorAll('img[data-src], img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
          });

          // Store observer globally for cleanup
          window.lazyImageObserver = imageObserver;
        } else {
          // Fallback for older browsers
          loadAllImagesImmediately();
        }
      }

      // Enhanced image loading with performance monitoring
      function loadImageWithOptimization(img, observer) {
        const originalSrc = img.dataset.src || img.src;
        const loadStartTime = performance.now();

        // Create a new image element for preloading
        const imageLoader = new Image();

        // Add loading state
        img.classList.add('loading');

        // Set up performance monitoring
        const timeoutId = setTimeout(() => {
          console.warn('Image loading timeout:', originalSrc);
          performanceMonitor.recordImageLoad(loadStartTime, performance.now(), false);
        }, 10000); // 10 second timeout

        imageLoader.onload = function () {
          clearTimeout(timeoutId);
          const loadEndTime = performance.now();

          // Record successful load
          performanceMonitor.recordImageLoad(loadStartTime, loadEndTime, true);

          // Image loaded successfully
          img.src = originalSrc;
          img.classList.remove('loading');
          img.classList.add('loaded');

          // Remove data-src attribute
          if (img.dataset.src) {
            img.removeAttribute('data-src');
          }

          // Stop observing this image
          observer.unobserve(img);

          // Trigger fade-in animation with RAF for smooth performance
          requestAnimationFrame(() => {
            img.style.opacity = '1';
          });
        };

        imageLoader.onerror = function () {
          clearTimeout(timeoutId);
          const loadEndTime = performance.now();

          // Record failed load
          performanceMonitor.recordImageLoad(loadStartTime, loadEndTime, false);

          // Handle loading error
          img.classList.remove('loading');
          img.classList.add('error');

          // Set fallback image
          img.src = getImageFallback(img.dataset.source || 'nasa');
          img.alt = 'Image unavailable - ' + (img.alt || 'Space image');

          observer.unobserve(img);
        };

        // Optimize loading based on connection
        if (navigator.connection) {
          const connection = navigator.connection;
          if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
            // Add delay for slow connections to prevent overwhelming
            setTimeout(() => {
              imageLoader.src = originalSrc;
            }, 100);
          } else {
            imageLoader.src = originalSrc;
          }
        } else {
          imageLoader.src = originalSrc;
        }
      }

      // Fallback for browsers without IntersectionObserver
      function loadAllImagesImmediately() {
        document.querySelectorAll('img[data-src]').forEach(img => {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        });
      }

      // Get appropriate fallback image based on source
      function getImageFallback(source) {
        const fallbacks = {
          nasa: 'https://via.placeholder.com/400x225/0033a0/ffffff?text=NASA+Image+Unavailable',
          spacex: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Image+Unavailable',
          esa: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Image+Unavailable',
          iss: 'https://via.placeholder.com/400x225/28a745/ffffff?text=ISS+Image+Unavailable'
        };
        return fallbacks[source] || fallbacks.nasa;
      }

      // Update last refresh time
      function updateLastRefreshTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        lastRefreshTime.textContent = timeString;
      }

      // Search functionality
      const searchInput = document.getElementById('search-input');
      const searchClear = document.getElementById('search-clear');
      const searchSuggestions = document.getElementById('search-suggestions');
      const advancedToggle = document.getElementById('advanced-toggle');
      const sortToggle = document.getElementById('sort-toggle');
      const advancedFilters = document.getElementById('advanced-filters');
      const sortOptions = document.getElementById('sort-options');

      // Search input handling
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value.trim();
        searchClear.style.display = currentSearch ? 'block' : 'none';
        applyAllFilters();

        // Hide suggestions when typing
        if (currentSearch) {
          searchSuggestions.style.display = 'none';
        }
      });

      searchInput.addEventListener('focus', () => {
        if (!currentSearch) {
          searchSuggestions.style.display = 'block';
        }
      });

      searchInput.addEventListener('blur', () => {
        // Delay hiding to allow clicking suggestions
        setTimeout(() => {
          searchSuggestions.style.display = 'none';
        }, 200);
      });

      searchClear.addEventListener('click', () => {
        searchInput.value = '';
        currentSearch = '';
        searchClear.style.display = 'none';
        applyAllFilters();
        searchInput.focus();
      });

      // Search suggestions
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-btn')) {
          const searchTerm = e.target.dataset.search;
          searchInput.value = searchTerm;
          currentSearch = searchTerm;
          searchClear.style.display = 'block';
          searchSuggestions.style.display = 'none';
          applyAllFilters();
        }
      });

      // Advanced filters toggle
      advancedToggle.addEventListener('click', () => {
        const isVisible = advancedFilters.style.display !== 'none';
        advancedFilters.style.display = isVisible ? 'none' : 'block';
        advancedToggle.classList.toggle('active', !isVisible);
      });

      // Sort options toggle
      sortToggle.addEventListener('click', () => {
        const isVisible = sortOptions.style.display !== 'none';
        sortOptions.style.display = isVisible ? 'none' : 'block';
        sortToggle.classList.toggle('active', !isVisible);
      });

      // Source filter buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('source-filter-btn')) {
          currentSourceFilter = e.target.dataset.source;
          document.querySelectorAll('.source-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.source === currentSourceFilter);
          });
          applyAllFilters();
        }
      });

      // Date filter buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('date-filter-btn')) {
          currentDateFilter = e.target.dataset.range;
          document.querySelectorAll('.date-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.range === currentDateFilter);
          });
          applyAllFilters();
        }
      });

      // Sort buttons
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('sort-btn')) {
          currentSort = e.target.dataset.sort;
          document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.sort === currentSort);
          });
          applyAllFilters();
        }
      });

      // Event listeners
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterImages(btn.dataset.filter);
        });
      });

      viewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          switchView(btn.dataset.view);
        });
      });

      refreshBtn.addEventListener('click', () => {
        autoRefreshManager.forceRefresh();
      });

      // Auto-refresh toggle
      const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
      autoRefreshToggle.addEventListener('click', () => {
        autoRefreshManager.toggle();
        autoRefreshToggle.classList.toggle('enabled', autoRefreshManager.isEnabled);
        autoRefreshToggle.textContent = autoRefreshManager.isEnabled ? 'Auto' : 'Manual';

        showAutoRefreshStatus(
          autoRefreshManager.isEnabled ? 'Auto-refresh enabled' : 'Auto-refresh disabled',
          autoRefreshManager.isEnabled ? 'success' : 'error'
        );
      });

      // Keyboard navigation for controls
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          if (e.target.classList.contains('filter-btn') ||
            e.target.classList.contains('view-btn') ||
            e.target.classList.contains('refresh-btn')) {
            e.preventDefault();
            e.target.click();
          }
        }
      });

      // Initialize
      updateLastRefreshTime();

      // Load initial data
      async function initializeGallery() {
        try {
          // Show loading state
          gallery.innerHTML = '<div class="loading-message">Loading space imagery from NASA, ESA, SpaceX, and ISS...</div>';

          // Fetch initial data
          const images = await imageDataManager.fetchAllImages();

          if (images.length > 0) {
            await updateGalleryWithImages(images);
          } else {
            // Show error if no images loaded
            gallery.innerHTML = '<div class="error-message">Unable to load images. Please check your connection and try refreshing.</div>';
          }
        } catch (error) {
          console.error('Failed to initialize gallery:', error);
          gallery.innerHTML = '<div class="error-message">Failed to load images. Please try refreshing the page.</div>';
        }
      }

      // Memory management and cleanup
      function cleanupResources() {
        // Clean up intersection observer
        if (window.lazyImageObserver) {
          window.lazyImageObserver.disconnect();
        }

        // Clear image cache periodically
        if (imageDataManager.cache.size > 50) {
          const oldestEntries = Array.from(imageDataManager.cache.entries())
            .sort((a, b) => a[1].timestamp - b[1].timestamp)
            .slice(0, 20);

          oldestEntries.forEach(([key]) => {
            imageDataManager.cache.delete(key);
          });

          console.log('🧹 Cleaned up old cache entries');
        }
      }

      // Performance optimization: Cleanup on page visibility change
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          cleanupResources();
        } else if (document.visibilityState === 'visible') {
          // Log performance stats when page becomes visible
          performanceMonitor.logPerformanceStats();
        }
      });

      // Start initialization
      initializeGallery();

      // Enhanced Auto-Refresh System
      const autoRefreshManager = {
        interval: 5 * 60 * 1000, // 5 minutes default
        minInterval: 2 * 60 * 1000, // 2 minutes minimum
        maxInterval: 15 * 60 * 1000, // 15 minutes maximum
        currentInterval: 5 * 60 * 1000,
        intervalId: null,
        lastUserActivity: Date.now(),
        isEnabled: true,
        consecutiveFailures: 0,

        init() {
          this.startAutoRefresh();
          this.setupActivityTracking();
          this.setupVisibilityTracking();
          this.setupNetworkTracking();
        },

        startAutoRefresh() {
          this.stopAutoRefresh();
          this.intervalId = setInterval(() => {
            this.performAutoRefresh();
          }, this.currentInterval);

          console.log(`🔄 Auto-refresh started: ${this.currentInterval / 1000}s interval`);
        },

        stopAutoRefresh() {
          if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
          }
        },

        async performAutoRefresh() {
          if (!this.shouldRefresh()) {
            return;
          }

          console.log('🔄 Auto-refresh triggered');

          try {
            await refreshGallery();
            this.onRefreshSuccess();
          } catch (error) {
            this.onRefreshFailure(error);
          }
        },

        shouldRefresh() {
          // Don't refresh if disabled
          if (!this.isEnabled) {
            console.log('⏸️ Auto-refresh disabled');
            return false;
          }

          // Don't refresh if page is not visible
          if (document.visibilityState !== 'visible') {
            console.log('👁️ Page not visible, skipping refresh');
            return false;
          }

          // Don't refresh if modal is open
          if (document.getElementById('image-modal').classList.contains('active')) {
            console.log('🖼️ Modal open, skipping refresh');
            return false;
          }

          // Don't refresh if performance is poor
          const avgLoadTime = performanceMonitor.getAverageLoadTime();
          if (avgLoadTime > 5000) {
            console.log('⏳ Poor performance, skipping refresh');
            this.adjustInterval('increase');
            return false;
          }

          // Don't refresh if user was recently active
          const timeSinceActivity = Date.now() - this.lastUserActivity;
          if (timeSinceActivity < 30000) { // 30 seconds
            console.log('👆 Recent user activity, skipping refresh');
            return false;
          }

          return true;
        },

        onRefreshSuccess() {
          this.consecutiveFailures = 0;

          // Improve interval if performance is good
          const avgLoadTime = performanceMonitor.getAverageLoadTime();
          if (avgLoadTime < 2000) {
            this.adjustInterval('decrease');
          }

          this.updateRefreshIndicator('success');
        },

        onRefreshFailure(error) {
          console.error('Auto-refresh failed:', error);
          this.consecutiveFailures++;

          // Increase interval after failures
          if (this.consecutiveFailures >= 2) {
            this.adjustInterval('increase');
          }

          // Disable after too many failures
          if (this.consecutiveFailures >= 5) {
            this.disable();
            showToast('Auto-refresh disabled due to repeated failures');
          }

          this.updateRefreshIndicator('error');
        },

        adjustInterval(direction) {
          const oldInterval = this.currentInterval;

          if (direction === 'increase') {
            this.currentInterval = Math.min(this.currentInterval * 1.5, this.maxInterval);
          } else if (direction === 'decrease') {
            this.currentInterval = Math.max(this.currentInterval * 0.8, this.minInterval);
          }

          if (this.currentInterval !== oldInterval) {
            console.log(`⏱️ Interval adjusted: ${oldInterval / 1000}s → ${this.currentInterval / 1000}s`);
            this.startAutoRefresh(); // Restart with new interval
          }
        },

        setupActivityTracking() {
          const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

          events.forEach(event => {
            document.addEventListener(event, () => {
              this.lastUserActivity = Date.now();
            }, { passive: true });
          });
        },

        setupVisibilityTracking() {
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              console.log('👁️ Page visible, resuming auto-refresh');
              this.lastUserActivity = Date.now();

              // Check if we should refresh immediately after becoming visible
              const timeSinceLastRefresh = Date.now() - this.getLastRefreshTime();
              if (timeSinceLastRefresh > this.currentInterval) {
                setTimeout(() => this.performAutoRefresh(), 2000); // Small delay
              }
            } else {
              console.log('👁️ Page hidden, auto-refresh will pause');
            }
          });
        },

        setupNetworkTracking() {
          if ('connection' in navigator) {
            const connection = navigator.connection;

            const updateForConnection = () => {
              const effectiveType = connection.effectiveType;

              if (effectiveType === 'slow-2g' || effectiveType === '2g') {
                this.currentInterval = this.maxInterval;
                console.log('📶 Slow connection detected, using maximum interval');
              } else if (effectiveType === '4g') {
                this.currentInterval = this.minInterval;
                console.log('📶 Fast connection detected, using minimum interval');
              }

              this.startAutoRefresh();
            };

            connection.addEventListener('change', updateForConnection);
            updateForConnection(); // Initial setup
          }
        },

        getLastRefreshTime() {
          const lastRefreshElement = document.getElementById('last-refresh');
          const lastRefreshText = lastRefreshElement?.textContent;

          if (lastRefreshText && lastRefreshText !== '--' && lastRefreshText !== 'just now') {
            // Parse time from "3:45 PM" format
            const today = new Date();
            const [time, period] = lastRefreshText.split(' ');
            const [hours, minutes] = time.split(':').map(Number);

            let hour24 = hours;
            if (period === 'PM' && hours !== 12) hour24 += 12;
            if (period === 'AM' && hours === 12) hour24 = 0;

            const lastRefresh = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour24, minutes);
            return lastRefresh.getTime();
          }

          return Date.now() - this.currentInterval; // Assume it's time to refresh
        },

        updateRefreshIndicator(status) {
          const refreshBtn = document.querySelector('.refresh-btn');

          refreshBtn.classList.remove('success', 'error');

          if (status === 'success') {
            refreshBtn.classList.add('success');
            setTimeout(() => refreshBtn.classList.remove('success'), 2000);
          } else if (status === 'error') {
            refreshBtn.classList.add('error');
            setTimeout(() => refreshBtn.classList.remove('error'), 3000);
          }
        },

        enable() {
          this.isEnabled = true;
          this.consecutiveFailures = 0;
          this.startAutoRefresh();
          console.log('✅ Auto-refresh enabled');
        },

        disable() {
          this.isEnabled = false;
          this.stopAutoRefresh();
          console.log('❌ Auto-refresh disabled');
        },

        toggle() {
          if (this.isEnabled) {
            this.disable();
          } else {
            this.enable();
          }
        },

        forceRefresh() {
          console.log('🔄 Force refresh triggered');
          this.lastUserActivity = Date.now() - 60000; // Fake old activity
          this.performAutoRefresh();
        }
      };

      // Initialize auto-refresh system
      autoRefreshManager.init();

      // Mobile Touch Gesture System
      const mobileGestureManager = {
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        isDragging: false,
        isModalOpen: false,

        init() {
          if ('ontouchstart' in window) {
            this.setupTouchEvents();
            this.setupPullToRefresh();
            this.optimizeForMobile();
          }
        },

        setupTouchEvents() {
          // Gallery swipe navigation
          gallery.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
          gallery.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
          gallery.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });

          // Modal swipe navigation
          const modal = document.getElementById('image-modal');
          modal.addEventListener('touchstart', this.handleModalTouchStart.bind(this), { passive: false });
          modal.addEventListener('touchmove', this.handleModalTouchMove.bind(this), { passive: false });
          modal.addEventListener('touchend', this.handleModalTouchEnd.bind(this), { passive: false });
        },

        handleTouchStart(e) {
          this.startX = e.touches[0].clientX;
          this.startY = e.touches[0].clientY;
          this.isDragging = false;
        },

        handleTouchMove(e) {
          if (!this.startX || !this.startY) return;

          this.currentX = e.touches[0].clientX;
          this.currentY = e.touches[0].clientY;

          const diffX = Math.abs(this.currentX - this.startX);
          const diffY = Math.abs(this.currentY - this.startY);

          // Detect horizontal swipe
          if (diffX > diffY && diffX > 50) {
            this.isDragging = true;
            e.preventDefault(); // Prevent scrolling
          }
        },

        handleTouchEnd(e) {
          if (!this.isDragging) return;

          const diffX = this.currentX - this.startX;
          const threshold = 100;

          if (Math.abs(diffX) > threshold) {
            if (diffX > 0) {
              // Swipe right - previous filter
              this.navigateFilter('previous');
            } else {
              // Swipe left - next filter
              this.navigateFilter('next');
            }
          }

          this.resetTouch();
        },

        handleModalTouchStart(e) {
          if (!document.getElementById('image-modal').classList.contains('active')) return;

          this.isModalOpen = true;
          this.startX = e.touches[0].clientX;
          this.startY = e.touches[0].clientY;
        },

        handleModalTouchMove(e) {
          if (!this.isModalOpen) return;

          this.currentX = e.touches[0].clientX;
          this.currentY = e.touches[0].clientY;

          const diffX = Math.abs(this.currentX - this.startX);
          const diffY = Math.abs(this.currentY - this.startY);

          if (diffX > diffY && diffX > 30) {
            e.preventDefault();
          }
        },

        handleModalTouchEnd(e) {
          if (!this.isModalOpen) return;

          const diffX = this.currentX - this.startX;
          const diffY = this.currentY - this.startY;
          const threshold = 80;

          if (Math.abs(diffX) > threshold && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX > 0) {
              // Swipe right - previous image
              document.querySelector('.prev-btn').click();
            } else {
              // Swipe left - next image
              document.querySelector('.next-btn').click();
            }
          } else if (diffY > threshold && Math.abs(diffY) > Math.abs(diffX)) {
            // Swipe down - close modal
            document.querySelector('.modal-close').click();
          }

          this.resetTouch();
        },

        navigateFilter(direction) {
          const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
          const activeBtn = filterBtns.find(btn => btn.classList.contains('active'));
          const currentIndex = filterBtns.indexOf(activeBtn);

          let newIndex;
          if (direction === 'next') {
            newIndex = (currentIndex + 1) % filterBtns.length;
          } else {
            newIndex = currentIndex === 0 ? filterBtns.length - 1 : currentIndex - 1;
          }

          filterBtns[newIndex].click();
          this.showSwipeHint(direction);
        },

        showSwipeHint(direction) {
          const hint = document.createElement('div');
          hint.className = 'swipe-hint';
          hint.textContent = direction === 'next' ? 'Next Filter →' : '← Previous Filter';
          hint.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1em 2em;
            border-radius: 8px;
            z-index: 10000;
            font-size: 0.9em;
            pointer-events: none;
          `;

          document.body.appendChild(hint);
          setTimeout(() => {
            document.body.removeChild(hint);
          }, 1500);
        },

        setupPullToRefresh() {
          let startY = 0;
          let pullDistance = 0;
          const threshold = 100;

          document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
              startY = e.touches[0].clientY;
            }
          }, { passive: true });

          document.addEventListener('touchmove', (e) => {
            if (startY && window.scrollY === 0) {
              pullDistance = e.touches[0].clientY - startY;

              if (pullDistance > 0) {
                this.updatePullIndicator(pullDistance, threshold);
              }
            }
          }, { passive: true });

          document.addEventListener('touchend', () => {
            if (pullDistance > threshold) {
              autoRefreshManager.forceRefresh();
              showAutoRefreshStatus('Pull to refresh triggered', 'success');
            }

            this.hidePullIndicator();
            startY = 0;
            pullDistance = 0;
          }, { passive: true });
        },

        updatePullIndicator(distance, threshold) {
          let indicator = document.getElementById('pull-indicator');
          if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'pull-indicator';
            indicator.innerHTML = '↓ Pull to refresh';
            indicator.style.cssText = `
              position: fixed;
              top: 0;
              left: 50%;
              transform: translateX(-50%);
              background: var(--accent);
              color: white;
              padding: 0.5em 1em;
              border-radius: 0 0 8px 8px;
              z-index: 9999;
              font-size: 0.8em;
              transition: all 0.2s ease;
            `;
            document.body.appendChild(indicator);
          }

          const progress = Math.min(distance / threshold, 1);
          indicator.style.opacity = progress;
          indicator.style.transform = `translateX(-50%) translateY(${-20 + (progress * 20)}px)`;

          if (progress >= 1) {
            indicator.innerHTML = '↑ Release to refresh';
            indicator.style.background = 'var(--highlight)';
          } else {
            indicator.innerHTML = '↓ Pull to refresh';
            indicator.style.background = 'var(--accent)';
          }
        },

        hidePullIndicator() {
          const indicator = document.getElementById('pull-indicator');
          if (indicator) {
            indicator.style.opacity = '0';
            setTimeout(() => {
              if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
              }
            }, 200);
          }
        },

        optimizeForMobile() {
          // Optimize touch targets
          const touchTargets = document.querySelectorAll('button, .image-card, .filter-btn');
          touchTargets.forEach(target => {
            const rect = target.getBoundingClientRect();
            if (rect.height < 44) {
              target.style.minHeight = '44px';
            }
          });

          // Add mobile-specific classes
          document.body.classList.add('mobile-optimized');

          // Optimize scroll performance
          document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.image-gallery')) {
              e.target.style.webkitOverflowScrolling = 'touch';
            }
          }, { passive: true });
        },

        resetTouch() {
          this.startX = 0;
          this.startY = 0;
          this.currentX = 0;
          this.currentY = 0;
          this.isDragging = false;
          this.isModalOpen = false;
        }
      };

      // Initialize mobile gestures
      mobileGestureManager.init();

      // Enhanced Dark Mode Integration
      const themeManager = {
        init() {
          this.setupThemeIntegration();
          this.enhanceDarkModeStyles();
          this.setupThemeTransitions();
          this.handleSystemThemeChanges();
        },

        setupThemeIntegration() {
          // Listen for theme changes from the main site
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            // Override the existing theme toggle to include livestream-specific enhancements
            const originalToggle = themeToggle.onclick;
            themeToggle.onclick = null;

            themeToggle.addEventListener('click', () => {
              document.body.classList.toggle('dark');
              const isDark = document.body.classList.contains('dark');
              themeToggle.textContent = isDark ? '☀️' : '🌙';
              localStorage.setItem('theme', isDark ? 'dark' : 'light');

              // Apply livestream-specific theme enhancements
              this.applyThemeEnhancements(isDark);
              this.updateImageContrast(isDark);
              this.animateThemeTransition();
            });
          }

          // Apply initial theme
          const savedTheme = localStorage.getItem('theme');
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const shouldBeDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

          if (shouldBeDark) {
            document.body.classList.add('dark');
            if (themeToggle) themeToggle.textContent = '☀️';
            this.applyThemeEnhancements(true);
          }
        },

        applyThemeEnhancements(isDark) {
          // Update CSS custom properties for smooth transitions
          const root = document.documentElement;

          if (isDark) {
            root.style.setProperty('--image-overlay-bg', 'rgba(0, 0, 0, 0.8)');
            root.style.setProperty('--card-shadow', '0 4px 12px rgba(0, 0, 0, 0.4)');
            root.style.setProperty('--text-primary', '#ffffff');
            root.style.setProperty('--text-secondary', '#cccccc');
            root.style.setProperty('--bg-primary', '#121212');
            root.style.setProperty('--bg-secondary', '#1a1a1a');
            root.style.setProperty('--border-color', '#333333');
          } else {
            root.style.setProperty('--image-overlay-bg', 'rgba(0, 0, 0, 0.6)');
            root.style.setProperty('--card-shadow', '0 4px 12px rgba(0, 0, 0, 0.1)');
            root.style.setProperty('--text-primary', '#333333');
            root.style.setProperty('--text-secondary', '#666666');
            root.style.setProperty('--bg-primary', '#ffffff');
            root.style.setProperty('--bg-secondary', '#f8f9fa');
            root.style.setProperty('--border-color', '#eeeeee');
          }

          // Update modal backdrop
          this.updateModalBackdrop(isDark);

          // Update search suggestions theme
          this.updateSearchTheme(isDark);

          // Update auto-refresh status theme
          this.updateStatusTheme(isDark);
        },

        updateImageContrast(isDark) {
          // Adjust image contrast for better visibility in dark mode
          const images = document.querySelectorAll('.image-container img');
          images.forEach(img => {
            if (isDark) {
              img.style.filter = 'brightness(0.9) contrast(1.1)';
            } else {
              img.style.filter = 'none';
            }
          });
        },

        updateModalBackdrop(isDark) {
          const modal = document.getElementById('image-modal');
          if (modal) {
            if (isDark) {
              modal.style.background = 'rgba(0, 0, 0, 0.95)';
            } else {
              modal.style.background = 'rgba(0, 0, 0, 0.8)';
            }
          }
        },

        updateSearchTheme(isDark) {
          const searchSuggestions = document.getElementById('search-suggestions');
          if (searchSuggestions) {
            if (isDark) {
              searchSuggestions.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
            } else {
              searchSuggestions.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
            }
          }
        },

        updateStatusTheme(isDark) {
          const statusElement = document.getElementById('auto-refresh-status');
          if (statusElement) {
            if (isDark) {
              statusElement.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            } else {
              statusElement.style.borderColor = 'rgba(0, 0, 0, 0.2)';
            }
          }
        },

        setupThemeTransitions() {
          // Add smooth transitions for theme changes
          const style = document.createElement('style');
          style.textContent = `
            * {
              transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
            }
            
            .image-container img {
              transition: filter 0.3s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
            }
          `;
          document.head.appendChild(style);

          // Remove transitions after theme change is complete
          setTimeout(() => {
            style.remove();
          }, 300);
        },

        animateThemeTransition() {
          // Create a subtle animation effect for theme switching
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: ${document.body.classList.contains('dark') ? '#000' : '#fff'};
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.15s ease;
          `;

          document.body.appendChild(overlay);

          requestAnimationFrame(() => {
            overlay.style.opacity = '0.3';
            setTimeout(() => {
              overlay.style.opacity = '0';
              setTimeout(() => {
                document.body.removeChild(overlay);
              }, 150);
            }, 50);
          });
        },

        handleSystemThemeChanges() {
          // Listen for system theme changes
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          mediaQuery.addListener((e) => {
            // Only auto-switch if user hasn't manually set a preference
            const savedTheme = localStorage.getItem('theme');
            if (!savedTheme) {
              const shouldBeDark = e.matches;
              document.body.classList.toggle('dark', shouldBeDark);

              const themeToggle = document.getElementById('themeToggle');
              if (themeToggle) {
                themeToggle.textContent = shouldBeDark ? '☀️' : '🌙';
              }

              this.applyThemeEnhancements(shouldBeDark);
              this.animateThemeTransition();
            }
          });
        },

        // Method to programmatically switch themes
        setTheme(theme) {
          const isDark = theme === 'dark';
          document.body.classList.toggle('dark', isDark);

          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.textContent = isDark ? '☀️' : '🌙';
          }

          localStorage.setItem('theme', theme);
          this.applyThemeEnhancements(isDark);
          this.animateThemeTransition();
        },

        // Get current theme
        getCurrentTheme() {
          return document.body.classList.contains('dark') ? 'dark' : 'light';
        }
      };

      // Initialize theme manager
      themeManager.init();

      // Make theme manager globally available
      window.livestreamThemeManager = themeManager;

      // Comprehensive Error Handling System
      const errorManager = {
        errorCounts: {},
        maxRetries: 3,
        retryDelays: [1000, 3000, 5000], // Progressive delays

        init() {
          this.setupGlobalErrorHandling();
          this.setupNetworkErrorHandling();
          this.setupImageErrorHandling();
          this.setupAPIErrorHandling();
        },

        setupGlobalErrorHandling() {
          // Catch unhandled JavaScript errors
          window.addEventListener('error', (event) => {
            this.handleJavaScriptError(event.error, event.filename, event.lineno);
          });

          // Catch unhandled promise rejections
          window.addEventListener('unhandledrejection', (event) => {
            this.handlePromiseRejection(event.reason);
            event.preventDefault(); // Prevent console error
          });

          // Monitor performance and memory issues
          if ('performance' in window && 'memory' in performance) {
            setInterval(() => {
              this.checkPerformanceIssues();
            }, 30000); // Check every 30 seconds
          }
        },

        setupNetworkErrorHandling() {
          // Monitor network connectivity
          window.addEventListener('online', () => {
            this.handleNetworkRestore();
          });

          window.addEventListener('offline', () => {
            this.handleNetworkLoss();
          });

          // Monitor connection quality
          if ('connection' in navigator) {
            navigator.connection.addEventListener('change', () => {
              this.handleConnectionChange();
            });
          }
        },

        setupImageErrorHandling() {
          // Global image error handler
          document.addEventListener('error', (event) => {
            if (event.target.tagName === 'IMG') {
              this.handleImageError(event.target);
            }
          }, true);
        },

        setupAPIErrorHandling() {
          // Enhance fetch to include error handling
          const originalFetch = window.fetch;
          window.fetch = async (...args) => {
            try {
              const response = await originalFetch(...args);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              return response;
            } catch (error) {
              return this.handleFetchError(error, args[0]);
            }
          };
        },

        handleJavaScriptError(error, filename, lineno) {
          console.error('JavaScript Error:', error, 'at', filename, 'line', lineno);

          const errorKey = `js_${error.message}`;
          this.incrementErrorCount(errorKey);

          if (this.errorCounts[errorKey] <= 2) {
            this.showUserFriendlyError(
              'Something went wrong',
              'We encountered a technical issue. The page will try to recover automatically.',
              'warning'
            );
          }

          // Attempt recovery for common errors
          if (error.message.includes('Cannot read property')) {
            this.attemptDOMRecovery();
          }
        },

        handlePromiseRejection(reason) {
          console.error('Unhandled Promise Rejection:', reason);

          const errorKey = `promise_${reason.message || reason}`;
          this.incrementErrorCount(errorKey);

          if (this.errorCounts[errorKey] <= 2) {
            this.showUserFriendlyError(
              'Connection Issue',
              'We\'re having trouble loading some content. Please check your internet connection.',
              'error'
            );
          }
        },

        async handleFetchError(error, url) {
          console.error('Fetch Error:', error, 'for URL:', url);

          const errorKey = `fetch_${url}`;
          this.incrementErrorCount(errorKey);

          // Determine error type and show appropriate message
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            this.showUserFriendlyError(
              'Network Error',
              'Unable to connect to the server. Please check your internet connection and try again.',
              'error'
            );
          } else if (error.message.includes('404')) {
            this.showUserFriendlyError(
              'Content Not Found',
              'The requested content is no longer available.',
              'warning'
            );
          } else if (error.message.includes('500')) {
            this.showUserFriendlyError(
              'Server Error',
              'The server is experiencing issues. We\'ll try again automatically.',
              'error'
            );
          }

          // Attempt retry for recoverable errors
          if (this.shouldRetry(errorKey)) {
            return this.retryFetch(url, errorKey);
          }

          throw error;
        },

        handleImageError(img) {
          const errorKey = `image_${img.src}`;
          this.incrementErrorCount(errorKey);

          // Try fallback image
          const fallbackUrl = this.getImageFallback(img.dataset.source || 'nasa');

          if (img.src !== fallbackUrl) {
            img.src = fallbackUrl;
            img.alt = 'Image unavailable - ' + (img.alt || 'Space image');
            img.classList.add('error-fallback');
          } else {
            // Even fallback failed, show placeholder
            this.replaceWithPlaceholder(img);
          }
        },

        handleNetworkLoss() {
          this.showUserFriendlyError(
            'Connection Lost',
            'You\'re currently offline. Some features may not work until your connection is restored.',
            'warning',
            0 // Don't auto-hide
          );

          // Disable auto-refresh
          if (window.autoRefreshManager) {
            autoRefreshManager.disable();
          }

          // Show offline indicator
          this.showOfflineIndicator();
        },

        handleNetworkRestore() {
          this.hideError();
          this.hideOfflineIndicator();

          this.showUserFriendlyError(
            'Connection Restored',
            'You\'re back online! Refreshing content...',
            'success'
          );

          // Re-enable auto-refresh
          if (window.autoRefreshManager) {
            autoRefreshManager.enable();
            setTimeout(() => autoRefreshManager.forceRefresh(), 1000);
          }
        },

        handleConnectionChange() {
          if ('connection' in navigator) {
            const connection = navigator.connection;
            const effectiveType = connection.effectiveType;

            if (effectiveType === 'slow-2g' || effectiveType === '2g') {
              this.showUserFriendlyError(
                'Slow Connection',
                'Your connection is slow. We\'ve optimized the experience for better performance.',
                'info'
              );
            }
          }
        },

        checkPerformanceIssues() {
          if ('memory' in performance) {
            const memory = performance.memory;
            const memoryUsage = memory.usedJSHeapSize / memory.jsHeapSizeLimit;

            if (memoryUsage > 0.9) {
              this.showUserFriendlyError(
                'Performance Warning',
                'The page is using a lot of memory. Consider refreshing for better performance.',
                'warning'
              );

              // Trigger cleanup
              this.performMemoryCleanup();
            }
          }
        },

        shouldRetry(errorKey) {
          return this.errorCounts[errorKey] <= this.maxRetries;
        },

        async retryFetch(url, errorKey) {
          const retryCount = this.errorCounts[errorKey] - 1;
          const delay = this.retryDelays[Math.min(retryCount, this.retryDelays.length - 1)];

          this.showUserFriendlyError(
            'Retrying...',
            `Attempting to reconnect (${retryCount + 1}/${this.maxRetries})`,
            'info'
          );

          await new Promise(resolve => setTimeout(resolve, delay));

          try {
            return await fetch(url);
          } catch (error) {
            this.incrementErrorCount(errorKey);
            throw error;
          }
        },

        attemptDOMRecovery() {
          // Try to recover from DOM-related errors
          try {
            // Reinitialize critical components
            if (typeof initializeLazyLoading === 'function') {
              initializeLazyLoading();
            }

            // Reapply event listeners
            this.reattachEventListeners();

          } catch (recoveryError) {
            console.error('Recovery attempt failed:', recoveryError);
          }
        },

        reattachEventListeners() {
          // Reattach critical event listeners
          const refreshBtn = document.querySelector('.refresh-btn');
          if (refreshBtn && !refreshBtn.hasAttribute('data-listeners-attached')) {
            refreshBtn.addEventListener('click', () => {
              if (window.autoRefreshManager) {
                autoRefreshManager.forceRefresh();
              }
            });
            refreshBtn.setAttribute('data-listeners-attached', 'true');
          }
        },

        performMemoryCleanup() {
          // Clear image caches
          if (window.imageDataManager && imageDataManager.cache) {
            const cacheSize = imageDataManager.cache.size;
            if (cacheSize > 20) {
              // Clear oldest entries
              const entries = Array.from(imageDataManager.cache.entries());
              entries.slice(0, Math.floor(cacheSize / 2)).forEach(([key]) => {
                imageDataManager.cache.delete(key);
              });
            }
          }

          // Clear performance monitor data
          if (window.performanceMonitor) {
            performanceMonitor.imageLoadTimes = performanceMonitor.imageLoadTimes.slice(-50);
          }
        },

        replaceWithPlaceholder(img) {
          const placeholder = document.createElement('div');
          placeholder.className = 'image-placeholder';
          placeholder.innerHTML = `
            <div class="placeholder-icon">🚀</div>
            <div class="placeholder-text">Image unavailable</div>
          `;
          placeholder.style.cssText = `
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            font-size: 0.9em;
            height: 100%;
            min-height: 200px;
          `;

          img.parentNode.replaceChild(placeholder, img);
        },

        getImageFallback(source) {
          const fallbacks = {
            nasa: 'https://via.placeholder.com/400x225/0033a0/ffffff?text=NASA+Image+Unavailable',
            spacex: 'https://via.placeholder.com/400x225/005288/ffffff?text=SpaceX+Image+Unavailable',
            esa: 'https://via.placeholder.com/400x225/6f42c1/ffffff?text=ESA+Image+Unavailable',
            iss: 'https://via.placeholder.com/400x225/28a745/ffffff?text=ISS+Image+Unavailable'
          };
          return fallbacks[source] || fallbacks.nasa;
        },

        showOfflineIndicator() {
          let indicator = document.getElementById('offline-indicator');
          if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'offline-indicator';
            indicator.innerHTML = '📡 Offline';
            indicator.style.cssText = `
              position: fixed;
              top: 80px;
              right: 2em;
              background: #dc3545;
              color: white;
              padding: 0.5em 1em;
              border-radius: 20px;
              font-size: 0.8em;
              z-index: 10001;
              animation: slideInRight 0.3s ease;
            `;
            document.body.appendChild(indicator);
          }
        },

        hideOfflineIndicator() {
          const indicator = document.getElementById('offline-indicator');
          if (indicator) {
            indicator.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
              if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
              }
            }, 300);
          }
        },

        showUserFriendlyError(title, message, type = 'error', autoHide = 5000) {
          // Remove existing error
          this.hideError();

          const errorElement = document.createElement('div');
          errorElement.id = 'user-error-message';
          errorElement.className = `user-error ${type}`;

          const colors = {
            error: { bg: '#dc3545', border: '#c82333' },
            warning: { bg: '#ffc107', border: '#e0a800', color: '#000' },
            success: { bg: '#28a745', border: '#1e7e34' },
            info: { bg: '#17a2b8', border: '#138496' }
          };

          const color = colors[type] || colors.error;

          errorElement.innerHTML = `
            <div class="error-content">
              <div class="error-title">${title}</div>
              <div class="error-message">${message}</div>
              <button class="error-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
          `;

          errorElement.style.cssText = `
            position: fixed;
            top: 2em;
            left: 50%;
            transform: translateX(-50%);
            background: ${color.bg};
            color: ${color.color || '#fff'};
            border: 2px solid ${color.border};
            border-radius: 8px;
            padding: 1em;
            max-width: 400px;
            z-index: 10002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInDown 0.3s ease;
          `;

          document.body.appendChild(errorElement);

          if (autoHide > 0) {
            setTimeout(() => this.hideError(), autoHide);
          }
        },

        hideError() {
          const errorElement = document.getElementById('user-error-message');
          if (errorElement) {
            errorElement.style.animation = 'slideOutUp 0.3s ease';
            setTimeout(() => {
              if (errorElement.parentNode) {
                errorElement.parentNode.removeChild(errorElement);
              }
            }, 300);
          }
        },

        incrementErrorCount(key) {
          this.errorCounts[key] = (this.errorCounts[key] || 0) + 1;
        },

        // Public API for manual error reporting
        reportError(title, message, type = 'error') {
          this.showUserFriendlyError(title, message, type);
        },

        // Get error statistics
        getErrorStats() {
          return {
            totalErrors: Object.values(this.errorCounts).reduce((sum, count) => sum + count, 0),
            errorTypes: Object.keys(this.errorCounts).length,
            errorCounts: { ...this.errorCounts }
          };
        }
      };

      // Initialize error handling
      errorManager.init();

      // Make error manager globally available
      window.livestreamErrorManager = errorManager;

      // Enhanced Social Sharing System
      const socialSharingManager = {
        platforms: {
          twitter: {
            name: 'Twitter',
            icon: '🐦',
            color: '#1da1f2',
            urlTemplate: 'https://twitter.com/intent/tweet?text={text}&url={url}&hashtags={hashtags}',
            maxLength: 280
          },
          facebook: {
            name: 'Facebook',
            icon: '📘',
            color: '#4267b2',
            urlTemplate: 'https://www.facebook.com/sharer/sharer.php?u={url}&quote={text}',
            maxLength: 500
          },
          reddit: {
            name: 'Reddit',
            icon: '🔴',
            color: '#ff4500',
            urlTemplate: 'https://reddit.com/submit?title={text}&url={url}',
            maxLength: 300
          },
          linkedin: {
            name: 'LinkedIn',
            icon: '💼',
            color: '#0077b5',
            urlTemplate: 'https://www.linkedin.com/sharing/share-offsite/?url={url}',
            maxLength: 700
          },
          pinterest: {
            name: 'Pinterest',
            icon: '📌',
            color: '#bd081c',
            urlTemplate: 'https://pinterest.com/pin/create/button/?url={url}&media={image}&description={text}',
            maxLength: 500
          },
          telegram: {
            name: 'Telegram',
            icon: '✈️',
            color: '#0088cc',
            urlTemplate: 'https://t.me/share/url?url={url}&text={text}',
            maxLength: 4096
          },
          whatsapp: {
            name: 'WhatsApp',
            icon: '💬',
            color: '#25d366',
            urlTemplate: 'https://wa.me/?text={text}%20{url}',
            maxLength: 65536
          },
          email: {
            name: 'Email',
            icon: '📧',
            color: '#666666',
            urlTemplate: 'mailto:?subject={subject}&body={text}%0A%0A{url}',
            maxLength: 1000
          }
        },

        init() {
          this.setupNativeSharing();
          this.setupCustomSharing();
          this.setupShareTracking();
          this.enhanceExistingSocialButtons();
        },

        setupNativeSharing() {
          // Enhanced Web Share API support
          this.hasNativeShare = 'share' in navigator && 'canShare' in navigator;

          if (this.hasNativeShare) {
            console.log('✅ Native sharing available');
          } else {
            console.log('📱 Using custom sharing fallback');
          }
        },

        setupCustomSharing() {
          // Create enhanced sharing interface
          this.createShareButton();
          this.createShareModal();
        },

        setupShareTracking() {
          // Track sharing analytics
          this.shareStats = {
            totalShares: 0,
            platformStats: {},
            popularImages: {}
          };

          // Load existing stats
          const savedStats = localStorage.getItem('livestream-share-stats');
          if (savedStats) {
            this.shareStats = { ...this.shareStats, ...JSON.parse(savedStats) };
          }
        },

        enhanceExistingSocialButtons() {
          // Enhance existing social buttons with better functionality
          document.addEventListener('click', (e) => {
            if (e.target.closest('.social-btn')) {
              const platform = e.target.closest('.social-btn').dataset.platform;
              const imageId = document.getElementById('image-modal').dataset.currentImageId;

              if (imageId) {
                this.shareImage(imageId, platform);
              }
            }
          });
        },

        async shareImage(imageId, platform = 'native') {
          const imageData = currentImageData.find(img => img.id === imageId);
          if (!imageData) {
            this.showShareError('Image not found');
            return;
          }

          const shareData = this.prepareShareData(imageData);

          try {
            if (platform === 'native' && this.hasNativeShare) {
              await this.shareNative(shareData);
            } else if (platform === 'copy') {
              await this.copyToClipboard(shareData);
            } else {
              this.shareToSocial(shareData, platform);
            }

            this.trackShare(imageId, platform);
            this.showShareSuccess(platform);

          } catch (error) {
            console.error('Share failed:', error);
            this.showShareError(error.message);
          }
        },

        prepareShareData(imageData) {
          const baseUrl = window.location.origin + window.location.pathname;
          const imageUrl = `${baseUrl}#image-${imageData.id}`;

          // Create compelling share text
          const title = imageData.title;
          const description = this.truncateText(imageData.description, 100);
          const source = imageData.source.toUpperCase();
          const hashtags = this.generateHashtags(imageData);

          const shareText = `🚀 ${title}\n\n${description}\n\n📸 ${source}`;
          const shortText = `🚀 Amazing space image: ${title}`;

          return {
            title: title,
            text: shareText,
            shortText: shortText,
            url: imageUrl,
            imageUrl: imageData.imageUrl,
            hashtags: hashtags,
            source: source,
            description: description
          };
        },

        generateHashtags(imageData) {
          const hashtags = ['Space', 'Astronomy'];

          // Add source-specific hashtags
          switch (imageData.source) {
            case 'nasa':
              hashtags.push('NASA', 'SpaceExploration');
              break;
            case 'spacex':
              hashtags.push('SpaceX', 'RocketLaunch');
              break;
            case 'esa':
              hashtags.push('ESA', 'EuropeanSpace');
              break;
            case 'iss':
              hashtags.push('ISS', 'SpaceStation');
              break;
          }

          // Add category-specific hashtags
          switch (imageData.category) {
            case 'missions':
              hashtags.push('SpaceMission');
              break;
            case 'deep-space':
              hashtags.push('DeepSpace', 'Cosmos');
              break;
            case 'earth':
              hashtags.push('EarthFromSpace');
              break;
            case 'planets':
              hashtags.push('Planets', 'SolarSystem');
              break;
          }

          return hashtags.join(',');
        },

        async shareNative(shareData) {
          const nativeShareData = {
            title: shareData.title,
            text: shareData.shortText,
            url: shareData.url
          };

          // Check if we can share this data
          if (navigator.canShare && !navigator.canShare(nativeShareData)) {
            throw new Error('Cannot share this content');
          }

          await navigator.share(nativeShareData);
        },

        shareToSocial(shareData, platform) {
          const platformConfig = this.platforms[platform];
          if (!platformConfig) {
            throw new Error(`Platform ${platform} not supported`);
          }

          // Prepare platform-specific data
          const text = this.truncateText(shareData.text, platformConfig.maxLength);
          const encodedData = {
            text: encodeURIComponent(text),
            url: encodeURIComponent(shareData.url),
            image: encodeURIComponent(shareData.imageUrl),
            hashtags: encodeURIComponent(shareData.hashtags),
            subject: encodeURIComponent(`Amazing space image: ${shareData.title}`)
          };

          // Build share URL
          let shareUrl = platformConfig.urlTemplate;
          Object.keys(encodedData).forEach(key => {
            shareUrl = shareUrl.replace(`{${key}}`, encodedData[key]);
          });

          // Open share window
          const windowFeatures = 'width=600,height=400,scrollbars=yes,resizable=yes';
          window.open(shareUrl, '_blank', windowFeatures);
        },

        async copyToClipboard(shareData) {
          const shareText = `${shareData.text}\n\n${shareData.url}`;

          if (navigator.clipboard) {
            await navigator.clipboard.writeText(shareText);
          } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
          }
        },

        createShareButton() {
          // Enhanced share button for gallery cards
          const style = document.createElement('style');
          style.textContent = `
            .enhanced-share-btn {
              position: relative;
              overflow: visible;
            }
            
            .share-options {
              position: absolute;
              bottom: 100%;
              right: 0;
              background: white;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
              padding: 0.5em;
              display: none;
              z-index: 1000;
              min-width: 200px;
            }
            
            .share-options.visible {
              display: block;
              animation: shareOptionsSlideIn 0.2s ease;
            }
            
            @keyframes shareOptionsSlideIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            
            .quick-share-btn {
              display: flex;
              align-items: center;
              gap: 0.5em;
              padding: 0.4em 0.8em;
              border: none;
              background: none;
              cursor: pointer;
              border-radius: 4px;
              font-size: 0.8em;
              width: 100%;
              text-align: left;
              transition: background 0.2s ease;
            }
            
            .quick-share-btn:hover {
              background: #f0f0f0;
            }
          `;
          document.head.appendChild(style);
        },

        createShareModal() {
          // Enhanced share modal (already exists, but we'll enhance it)
          const existingModal = document.getElementById('image-modal');
          if (existingModal) {
            this.enhanceShareModal(existingModal);
          }
        },

        enhanceShareModal(modal) {
          // Add more social platforms to existing modal
          const socialButtons = modal.querySelector('.social-buttons');
          if (socialButtons) {
            // Clear existing buttons and rebuild with enhanced set
            socialButtons.innerHTML = '';

            const platforms = ['twitter', 'facebook', 'reddit', 'linkedin', 'whatsapp', 'copy'];
            platforms.forEach(platform => {
              const config = this.platforms[platform] || { name: 'Copy Link', icon: '📋', color: '#666' };

              const button = document.createElement('button');
              button.className = 'social-btn';
              button.dataset.platform = platform;
              button.style.borderColor = config.color;

              button.innerHTML = `
                <span class="social-icon">${config.icon}</span>
                <span class="social-text">${config.name}</span>
              `;

              button.addEventListener('mouseenter', () => {
                button.style.backgroundColor = config.color;
                button.style.color = 'white';
              });

              button.addEventListener('mouseleave', () => {
                button.style.backgroundColor = '';
                button.style.color = '';
              });

              socialButtons.appendChild(button);
            });
          }
        },

        trackShare(imageId, platform) {
          this.shareStats.totalShares++;
          this.shareStats.platformStats[platform] = (this.shareStats.platformStats[platform] || 0) + 1;
          this.shareStats.popularImages[imageId] = (this.shareStats.popularImages[imageId] || 0) + 1;

          // Save stats
          localStorage.setItem('livestream-share-stats', JSON.stringify(this.shareStats));

          // Log for analytics
          console.log('📊 Share tracked:', { imageId, platform, totalShares: this.shareStats.totalShares });
        },

        showShareSuccess(platform) {
          const platformName = this.platforms[platform]?.name || platform;
          const message = platform === 'copy' ? 'Link copied to clipboard!' : `Shared to ${platformName}!`;

          if (window.showToast) {
            showToast(message);
          } else {
            // Fallback notification
            this.showNotification(message, 'success');
          }
        },

        showShareError(error) {
          const message = `Share failed: ${error}`;

          if (window.livestreamErrorManager) {
            livestreamErrorManager.reportError('Share Error', message, 'error');
          } else {
            this.showNotification(message, 'error');
          }
        },

        showNotification(message, type) {
          const notification = document.createElement('div');
          notification.className = `share-notification ${type}`;
          notification.textContent = message;
          notification.style.cssText = `
            position: fixed;
            bottom: 2em;
            right: 2em;
            background: ${type === 'success' ? '#28a745' : '#dc3545'};
            color: white;
            padding: 1em;
            border-radius: 8px;
            z-index: 10003;
            animation: slideInUp 0.3s ease;
          `;

          document.body.appendChild(notification);
          setTimeout(() => {
            notification.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }, 3000);
        },

        truncateText(text, maxLength) {
          if (text.length <= maxLength) return text;
          return text.substring(0, maxLength - 3) + '...';
        },

        // Public API methods
        getShareStats() {
          return { ...this.shareStats };
        },

        getMostSharedImages() {
          return Object.entries(this.shareStats.popularImages)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10);
        },

        getPopularPlatforms() {
          return Object.entries(this.shareStats.platformStats)
            .sort(([, a], [, b]) => b - a);
        }
      };

      // Initialize social sharing
      socialSharingManager.init();

      // Make social sharing manager globally available
      window.livestreamSocialManager = socialSharingManager;

      // Comprehensive Test Suite
      const testSuite = {
        tests: [],
        results: {
          passed: 0,
          failed: 0,
          total: 0,
          details: []
        },

        init() {
          this.setupTestEnvironment();
          this.registerTests();

          // Auto-run tests in development mode
          if (this.isDevelopmentMode()) {
            console.log('🧪 Running automated tests...');
            setTimeout(() => this.runAllTests(), 2000);
          }
        },

        isDevelopmentMode() {
          return window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.search.includes('test=true');
        },

        setupTestEnvironment() {
          // Create test utilities
          this.mockData = this.createMockData();
          this.testUtils = this.createTestUtils();
        },

        createMockData() {
          return {
            sampleImage: {
              id: 'test_nasa_1',
              title: 'Test Mars Rover Image',
              description: 'A test image from Mars showing the rover in action.',
              imageUrl: 'https://via.placeholder.com/400x225/0033a0/ffffff?text=Test+Image',
              thumbnailUrl: 'https://via.placeholder.com/400x225/0033a0/ffffff?text=Test+Thumb',
              source: 'nasa',
              category: 'missions',
              timestamp: new Date(),
              sourceUrl: 'https://nasa.gov/test',
              metadata: {
                mission: 'Test Mission',
                photographer: 'Test Photographer',
                keywords: ['mars', 'rover', 'test']
              }
            },
            sampleImages: [
              // Multiple test images for comprehensive testing
              {
                id: 'test_spacex_1',
                title: 'Test SpaceX Launch',
                description: 'Test launch image',
                source: 'spacex',
                category: 'missions',
                timestamp: new Date(Date.now() - 60000)
              },
              {
                id: 'test_esa_1',
                title: 'Test ESA Deep Space',
                description: 'Test deep space image',
                source: 'esa',
                category: 'deep-space',
                timestamp: new Date(Date.now() - 120000)
              }
            ]
          };
        },

        createTestUtils() {
          return {
            waitFor: (condition, timeout = 5000) => {
              return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const check = () => {
                  if (condition()) {
                    resolve();
                  } else if (Date.now() - startTime > timeout) {
                    reject(new Error('Timeout waiting for condition'));
                  } else {
                    setTimeout(check, 100);
                  }
                };
                check();
              });
            },

            simulateClick: (element) => {
              const event = new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window
              });
              element.dispatchEvent(event);
            },

            simulateKeyPress: (element, key) => {
              const event = new KeyboardEvent('keydown', {
                key: key,
                bubbles: true,
                cancelable: true
              });
              element.dispatchEvent(event);
            },

            createTestElement: (tag, attributes = {}) => {
              const element = document.createElement(tag);
              Object.keys(attributes).forEach(key => {
                element.setAttribute(key, attributes[key]);
              });
              return element;
            }
          };
        },

        registerTests() {
          // Unit Tests
          this.addTest('Image Data Manager - Parse NASA Image', this.testParseNASAImage);
          this.addTest('Image Data Manager - Categorize Images', this.testCategorizeImages);
          this.addTest('Image Data Manager - Cache Management', this.testCacheManagement);

          // Filter and Search Tests
          this.addTest('Filter System - Category Filtering', this.testCategoryFiltering);
          this.addTest('Search System - Text Search', this.testTextSearch);
          this.addTest('Filter System - Multiple Filters', this.testMultipleFilters);

          // Modal Tests
          this.addTest('Modal System - Open and Close', this.testModalOpenClose);
          this.addTest('Modal System - Navigation', this.testModalNavigation);
          this.addTest('Modal System - Keyboard Controls', this.testModalKeyboard);

          // Performance Tests
          this.addTest('Performance - Image Loading', this.testImageLoadingPerformance);
          this.addTest('Performance - Memory Usage', this.testMemoryUsage);
          this.addTest('Performance - Scroll Performance', this.testScrollPerformance);

          // Error Handling Tests
          this.addTest('Error Handling - API Failures', this.testAPIErrorHandling);
          this.addTest('Error Handling - Network Issues', this.testNetworkErrorHandling);
          this.addTest('Error Handling - Image Load Failures', this.testImageErrorHandling);

          // Social Sharing Tests
          this.addTest('Social Sharing - Share Data Generation', this.testShareDataGeneration);
          this.addTest('Social Sharing - Platform Integration', this.testPlatformIntegration);

          // Accessibility Tests
          this.addTest('Accessibility - Keyboard Navigation', this.testKeyboardNavigation);
          this.addTest('Accessibility - Screen Reader Support', this.testScreenReaderSupport);
          this.addTest('Accessibility - Focus Management', this.testFocusManagement);

          // Mobile Tests
          this.addTest('Mobile - Touch Gestures', this.testTouchGestures);
          this.addTest('Mobile - Responsive Layout', this.testResponsiveLayout);

          // Integration Tests
          this.addTest('Integration - Full User Journey', this.testFullUserJourney);
          this.addTest('Integration - Auto-refresh Cycle', this.testAutoRefreshCycle);
        },

        addTest(name, testFunction) {
          this.tests.push({ name, testFunction: testFunction.bind(this) });
        },

        async runAllTests() {
          console.log('🚀 Starting comprehensive test suite...');
          this.results = { passed: 0, failed: 0, total: 0, details: [] };

          for (const test of this.tests) {
            await this.runTest(test);
          }

          this.displayResults();
        },

        async runTest(test) {
          this.results.total++;
          const startTime = performance.now();

          try {
            await test.testFunction();
            const duration = performance.now() - startTime;
            this.results.passed++;
            this.results.details.push({
              name: test.name,
              status: 'PASSED',
              duration: Math.round(duration),
              error: null
            });
            console.log(`✅ ${test.name} (${Math.round(duration)}ms)`);
          } catch (error) {
            const duration = performance.now() - startTime;
            this.results.failed++;
            this.results.details.push({
              name: test.name,
              status: 'FAILED',
              duration: Math.round(duration),
              error: error.message
            });
            console.error(`❌ ${test.name}: ${error.message}`);
          }
        },

        // Unit Tests
        async testParseNASAImage() {
          if (!window.imageDataManager) throw new Error('ImageDataManager not available');

          const mockNASAItem = {
            data: [{
              nasa_id: 'test123',
              title: 'Test Image',
              description: 'Test description',
              date_created: '2023-01-01T00:00:00Z',
              photographer: 'Test Photographer',
              keywords: ['mars', 'rover']
            }],
            links: [{ rel: 'preview', href: 'https://test.com/image.jpg' }]
          };

          const result = imageDataManager.parseNASAImage(mockNASAItem);

          if (!result.id || !result.title || !result.source) {
            throw new Error('Parsed image missing required fields');
          }

          if (result.source !== 'nasa') {
            throw new Error('Source not set correctly');
          }
        },

        async testCategorizeImages() {
          if (!window.imageDataManager) throw new Error('ImageDataManager not available');

          const testCases = [
            { title: 'Mars Rover Perseverance', expected: 'missions' },
            { title: 'Hubble Deep Space Image', expected: 'deep-space' },
            { title: 'Earth from ISS', expected: 'iss' },
            { title: 'Jupiter Great Red Spot', expected: 'planets' }
          ];

          testCases.forEach(testCase => {
            const result = imageDataManager.categorizeNASAImage({ title: testCase.title });
            if (result !== testCase.expected) {
              throw new Error(`Categorization failed: ${testCase.title} -> ${result}, expected ${testCase.expected}`);
            }
          });
        },

        async testCacheManagement() {
          if (!window.imageDataManager) throw new Error('ImageDataManager not available');

          const testKey = 'test_cache_key';
          const testData = { test: 'data' };

          // Test cache set
          imageDataManager.setCache(testKey, testData);

          // Test cache get
          const retrieved = imageDataManager.getFromCache(testKey);
          if (!retrieved || retrieved.test !== 'data') {
            throw new Error('Cache set/get failed');
          }

          // Test cache expiry (simulate old timestamp)
          imageDataManager.cache.set(testKey, {
            data: testData,
            timestamp: Date.now() - (10 * 60 * 1000) // 10 minutes ago
          });

          const expired = imageDataManager.getFromCache(testKey);
          if (expired) {
            throw new Error('Cache expiry not working');
          }
        },

        // Filter and Search Tests
        async testCategoryFiltering() {
          // Wait for gallery to be initialized
          await this.testUtils.waitFor(() => document.querySelector('.image-gallery'));

          const filterBtn = document.querySelector('[data-filter="missions"]');
          if (!filterBtn) throw new Error('Filter button not found');

          this.testUtils.simulateClick(filterBtn);

          // Check if filter was applied
          if (!filterBtn.classList.contains('active')) {
            throw new Error('Filter button not activated');
          }
        },

        async testTextSearch() {
          const searchInput = document.getElementById('search-input');
          if (!searchInput) throw new Error('Search input not found');

          // Simulate search input
          searchInput.value = 'mars';
          searchInput.dispatchEvent(new Event('input', { bubbles: true }));

          // Wait for search to process
          await new Promise(resolve => setTimeout(resolve, 100));

          // Check if search was applied (currentSearch should be set)
          if (typeof currentSearch === 'undefined') {
            throw new Error('Search functionality not working');
          }
        },

        async testMultipleFilters() {
          // Test combining category and source filters
          const categoryBtn = document.querySelector('[data-filter="missions"]');
          const sourceBtn = document.querySelector('[data-source="nasa"]');

          if (!categoryBtn || !sourceBtn) {
            throw new Error('Filter buttons not found');
          }

          this.testUtils.simulateClick(categoryBtn);
          this.testUtils.simulateClick(sourceBtn);

          // Both filters should be active
          if (!categoryBtn.classList.contains('active') || !sourceBtn.classList.contains('active')) {
            throw new Error('Multiple filters not working');
          }
        },

        // Modal Tests
        async testModalOpenClose() {
          const modal = document.getElementById('image-modal');
          const expandBtn = document.querySelector('.expand-btn');
          const closeBtn = document.querySelector('.modal-close');

          if (!modal || !expandBtn || !closeBtn) {
            throw new Error('Modal elements not found');
          }

          // Test open
          this.testUtils.simulateClick(expandBtn);
          await this.testUtils.waitFor(() => modal.classList.contains('active'));

          // Test close
          this.testUtils.simulateClick(closeBtn);
          await this.testUtils.waitFor(() => !modal.classList.contains('active'));
        },

        async testModalNavigation() {
          const modal = document.getElementById('image-modal');
          const prevBtn = document.querySelector('.prev-btn');
          const nextBtn = document.querySelector('.next-btn');

          if (!modal || !prevBtn || !nextBtn) {
            throw new Error('Modal navigation elements not found');
          }

          // Open modal first
          const expandBtn = document.querySelector('.expand-btn');
          this.testUtils.simulateClick(expandBtn);
          await this.testUtils.waitFor(() => modal.classList.contains('active'));

          // Test navigation
          const initialImageId = modal.dataset.currentImageId;
          this.testUtils.simulateClick(nextBtn);

          // Wait for navigation to complete
          await new Promise(resolve => setTimeout(resolve, 100));

          // Check if image changed (in a real scenario)
          // This is a basic test - in practice we'd check if the image actually changed
        },

        async testModalKeyboard() {
          const modal = document.getElementById('image-modal');

          // Open modal
          const expandBtn = document.querySelector('.expand-btn');
          this.testUtils.simulateClick(expandBtn);
          await this.testUtils.waitFor(() => modal.classList.contains('active'));

          // Test escape key
          this.testUtils.simulateKeyPress(document, 'Escape');
          await this.testUtils.waitFor(() => !modal.classList.contains('active'));
        },

        // Performance Tests
        async testImageLoadingPerformance() {
          if (!window.performanceMonitor) {
            throw new Error('Performance monitor not available');
          }

          const avgLoadTime = performanceMonitor.getAverageLoadTime();
          const successRate = performanceMonitor.getLoadSuccessRate();

          if (avgLoadTime > 10000) { // 10 seconds threshold
            throw new Error(`Image loading too slow: ${avgLoadTime}ms average`);
          }

          if (successRate < 80) { // 80% success rate threshold
            throw new Error(`Image loading success rate too low: ${successRate}%`);
          }
        },

        async testMemoryUsage() {
          if (!('memory' in performance)) {
            console.log('⚠️ Memory API not available, skipping memory test');
            return;
          }

          const memory = performance.memory;
          const memoryUsage = memory.usedJSHeapSize / memory.jsHeapSizeLimit;

          if (memoryUsage > 0.8) { // 80% memory usage threshold
            throw new Error(`Memory usage too high: ${Math.round(memoryUsage * 100)}%`);
          }
        },

        async testScrollPerformance() {
          const gallery = document.querySelector('.image-gallery');
          if (!gallery) throw new Error('Gallery not found');

          const startTime = performance.now();

          // Simulate scroll
          gallery.scrollTop = 100;

          // Wait for scroll to complete
          await new Promise(resolve => setTimeout(resolve, 100));

          const scrollTime = performance.now() - startTime;

          if (scrollTime > 100) { // 100ms threshold for scroll response
            throw new Error(`Scroll performance too slow: ${scrollTime}ms`);
          }
        },

        // Error Handling Tests
        async testAPIErrorHandling() {
          if (!window.livestreamErrorManager) {
            throw new Error('Error manager not available');
          }

          // Simulate API error
          const originalFetch = window.fetch;
          window.fetch = () => Promise.reject(new Error('Test API error'));

          try {
            await imageDataManager.fetchNASAImages();
          } catch (error) {
            // Expected to fail
          }

          // Restore fetch
          window.fetch = originalFetch;

          // Check if error was handled
          const errorStats = livestreamErrorManager.getErrorStats();
          if (errorStats.totalErrors === 0) {
            throw new Error('API error not tracked');
          }
        },

        async testNetworkErrorHandling() {
          if (!window.livestreamErrorManager) {
            throw new Error('Error manager not available');
          }

          // Simulate network offline
          const originalOnline = navigator.onLine;
          Object.defineProperty(navigator, 'onLine', {
            writable: true,
            value: false
          });

          // Trigger offline event
          window.dispatchEvent(new Event('offline'));

          // Wait for offline handling
          await new Promise(resolve => setTimeout(resolve, 100));

          // Check for offline indicator
          const offlineIndicator = document.getElementById('offline-indicator');
          if (!offlineIndicator) {
            throw new Error('Offline indicator not shown');
          }

          // Restore online status
          Object.defineProperty(navigator, 'onLine', {
            writable: true,
            value: originalOnline
          });

          window.dispatchEvent(new Event('online'));
        },

        async testImageErrorHandling() {
          // Create test image element
          const testImg = this.testUtils.createTestElement('img', {
            'src': 'https://invalid-url.com/nonexistent.jpg',
            'data-source': 'nasa'
          });

          document.body.appendChild(testImg);

          // Trigger error event
          testImg.dispatchEvent(new Event('error'));

          // Wait for error handling
          await new Promise(resolve => setTimeout(resolve, 100));

          // Check if fallback was applied
          if (!testImg.src.includes('placeholder')) {
            throw new Error('Image error fallback not applied');
          }

          // Cleanup
          document.body.removeChild(testImg);
        },

        // Social Sharing Tests
        async testShareDataGeneration() {
          if (!window.livestreamSocialManager) {
            throw new Error('Social manager not available');
          }

          const shareData = livestreamSocialManager.prepareShareData(this.mockData.sampleImage);

          if (!shareData.title || !shareData.url || !shareData.hashtags) {
            throw new Error('Share data generation incomplete');
          }

          if (!shareData.hashtags.includes('Space')) {
            throw new Error('Hashtag generation not working');
          }
        },

        async testPlatformIntegration() {
          if (!window.livestreamSocialManager) {
            throw new Error('Social manager not available');
          }

          const platforms = Object.keys(livestreamSocialManager.platforms);

          if (platforms.length < 5) {
            throw new Error('Insufficient social platforms configured');
          }

          // Test platform configuration
          const twitter = livestreamSocialManager.platforms.twitter;
          if (!twitter.urlTemplate || !twitter.maxLength) {
            throw new Error('Platform configuration incomplete');
          }
        },

        // Accessibility Tests
        async testKeyboardNavigation() {
          const filterBtns = document.querySelectorAll('.filter-btn');
          if (filterBtns.length === 0) throw new Error('Filter buttons not found');

          // Test tab navigation
          filterBtns[0].focus();

          // Test enter key activation
          this.testUtils.simulateKeyPress(filterBtns[0], 'Enter');

          if (!filterBtns[0].classList.contains('active')) {
            throw new Error('Keyboard activation not working');
          }
        },

        async testScreenReaderSupport() {
          const modal = document.getElementById('image-modal');
          if (!modal) throw new Error('Modal not found');

          // Check ARIA attributes
          if (!modal.hasAttribute('aria-hidden')) {
            throw new Error('Modal missing aria-hidden attribute');
          }

          if (!modal.hasAttribute('role')) {
            throw new Error('Modal missing role attribute');
          }
        },

        async testFocusManagement() {
          const modal = document.getElementById('image-modal');
          const closeBtn = document.querySelector('.modal-close');

          if (!modal || !closeBtn) throw new Error('Modal elements not found');

          // Open modal
          const expandBtn = document.querySelector('.expand-btn');
          this.testUtils.simulateClick(expandBtn);
          await this.testUtils.waitFor(() => modal.classList.contains('active'));

          // Check if focus moved to close button
          if (document.activeElement !== closeBtn) {
            console.log('⚠️ Focus management could be improved');
          }
        },

        // Mobile Tests
        async testTouchGestures() {
          if (!window.mobileGestureManager) {
            console.log('⚠️ Mobile gesture manager not available, skipping touch test');
            return;
          }

          // This is a basic test - full touch testing would require more complex simulation
          const gallery = document.querySelector('.image-gallery');
          if (!gallery) throw new Error('Gallery not found');

          // Check if touch event listeners are attached
          // In a real test, we'd simulate touch events
        },

        async testResponsiveLayout() {
          const gallery = document.querySelector('.image-gallery');
          if (!gallery) throw new Error('Gallery not found');

          // Test different viewport sizes
          const originalWidth = window.innerWidth;

          // Simulate mobile viewport
          Object.defineProperty(window, 'innerWidth', {
            writable: true,
            configurable: true,
            value: 375
          });

          window.dispatchEvent(new Event('resize'));

          // Wait for layout adjustment
          await new Promise(resolve => setTimeout(resolve, 100));

          // Check if mobile layout is applied
          const computedStyle = getComputedStyle(gallery);

          // Restore original width
          Object.defineProperty(window, 'innerWidth', {
            writable: true,
            configurable: true,
            value: originalWidth
          });
        },

        // Integration Tests
        async testFullUserJourney() {
          // Test complete user flow: load page -> filter -> open modal -> share

          // 1. Wait for page load
          await this.testUtils.waitFor(() => document.querySelector('.image-gallery'));

          // 2. Apply filter
          const filterBtn = document.querySelector('[data-filter="missions"]');
          if (filterBtn) this.testUtils.simulateClick(filterBtn);

          // 3. Open modal
          const expandBtn = document.querySelector('.expand-btn');
          if (expandBtn) {
            this.testUtils.simulateClick(expandBtn);
            await this.testUtils.waitFor(() => document.getElementById('image-modal').classList.contains('active'));
          }

          // 4. Test share (if available)
          const shareBtn = document.getElementById('modal-share');
          if (shareBtn) {
            this.testUtils.simulateClick(shareBtn);
          }

          // Journey completed successfully if no errors thrown
        },

        async testAutoRefreshCycle() {
          if (!window.autoRefreshManager) {
            throw new Error('Auto-refresh manager not available');
          }

          // Test refresh functionality
          const initialInterval = autoRefreshManager.currentInterval;

          if (!initialInterval || initialInterval <= 0) {
            throw new Error('Auto-refresh not properly configured');
          }

          // Test manual refresh
          try {
            await autoRefreshManager.performAutoRefresh();
          } catch (error) {
            // Expected to potentially fail in test environment
            console.log('⚠️ Auto-refresh test completed with expected limitations');
          }
        },

        displayResults() {
          const passRate = Math.round((this.results.passed / this.results.total) * 100);

          console.log('\n🧪 Test Suite Results:');
          console.log(`✅ Passed: ${this.results.passed}`);
          console.log(`❌ Failed: ${this.results.failed}`);
          console.log(`📊 Total: ${this.results.total}`);
          console.log(`📈 Pass Rate: ${passRate}%`);

          if (this.results.failed > 0) {
            console.log('\n❌ Failed Tests:');
            this.results.details
              .filter(test => test.status === 'FAILED')
              .forEach(test => {
                console.log(`  • ${test.name}: ${test.error}`);
              });
          }

          // Show test results in UI if in development mode
          if (this.isDevelopmentMode()) {
            this.showTestResultsUI();
          }
        },

        showTestResultsUI() {
          const resultsDiv = document.createElement('div');
          resultsDiv.id = 'test-results';
          resultsDiv.style.cssText = `
            position: fixed;
            top: 2em;
            right: 2em;
            background: ${this.results.failed === 0 ? '#28a745' : '#dc3545'};
            color: white;
            padding: 1em;
            border-radius: 8px;
            z-index: 10004;
            font-family: monospace;
            font-size: 0.8em;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          `;

          const passRate = Math.round((this.results.passed / this.results.total) * 100);

          resultsDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 0.5em;">🧪 Test Results</div>
            <div>✅ Passed: ${this.results.passed}</div>
            <div>❌ Failed: ${this.results.failed}</div>
            <div>📊 Pass Rate: ${passRate}%</div>
            <button onclick="this.parentElement.remove()" style="
              position: absolute;
              top: 0.5em;
              right: 0.5em;
              background: none;
              border: none;
              color: white;
              cursor: pointer;
              font-size: 1.2em;
            ">×</button>
          `;

          document.body.appendChild(resultsDiv);

          // Auto-hide after 10 seconds
          setTimeout(() => {
            if (resultsDiv.parentNode) {
              resultsDiv.parentNode.removeChild(resultsDiv);
            }
          }, 10000);
        }
      };

      // Initialize test suite
      testSuite.init();

      // Make test suite globally available
      window.livestreamTestSuite = testSuite;

      // Advanced Performance Analytics and Optimization System
      const performanceAnalytics = {
        metrics: {
          pageLoadTime: 0,
          firstContentfulPaint: 0,
          largestContentfulPaint: 0,
          cumulativeLayoutShift: 0,
          firstInputDelay: 0,
          imageLoadTimes: [],
          apiResponseTimes: [],
          userInteractions: [],
          errorCount: 0,
          memoryUsage: [],
          networkRequests: [],
          coreWebVitals: {},
          bundleSize: 0
        },

        budgets: {
          pageLoadTime: 3000, // 3 seconds
          imageLoadTime: 2000, // 2 seconds per image
          apiResponseTime: 5000, // 5 seconds
          memoryUsage: 100 * 1024 * 1024, // 100MB
          bundleSize: 500 * 1024, // 500KB
          cumulativeLayoutShift: 0.1,
          largestContentfulPaint: 2500
        },

        init() {
          this.setupPerformanceObservers();
          this.trackPageLoad();
          this.setupMemoryMonitoring();
          this.setupNetworkMonitoring();
          this.setupUserInteractionTracking();
          this.setupErrorTracking();
          this.optimizeBundle();
          this.startPeriodicReporting();
          this.createPerformanceDashboard();
        },

        setupPerformanceObservers() {
          // Core Web Vitals monitoring
          if ('PerformanceObserver' in window) {
            try {
              // Largest Contentful Paint
              const lcpObserver = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                const lastEntry = entries[entries.length - 1];
                this.metrics.largestContentfulPaint = lastEntry.startTime;
                this.metrics.coreWebVitals.lcp = lastEntry.startTime;
                this.checkBudget('largestContentfulPaint', lastEntry.startTime);
              });
              lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });

              // First Input Delay
              const fidObserver = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                entries.forEach(entry => {
                  this.metrics.firstInputDelay = entry.processingStart - entry.startTime;
                  this.metrics.coreWebVitals.fid = entry.processingStart - entry.startTime;
                });
              });
              fidObserver.observe({ entryTypes: ['first-input'] });

              // Cumulative Layout Shift
              const clsObserver = new PerformanceObserver((list) => {
                let clsValue = 0;
                const entries = list.getEntries();
                entries.forEach(entry => {
                  if (!entry.hadRecentInput) {
                    clsValue += entry.value;
                  }
                });
                this.metrics.cumulativeLayoutShift = clsValue;
                this.metrics.coreWebVitals.cls = clsValue;
                this.checkBudget('cumulativeLayoutShift', clsValue);
              });
              clsObserver.observe({ entryTypes: ['layout-shift'] });
            } catch (error) {
              console.warn('Performance observers not fully supported:', error);
            }
          }

          // First Contentful Paint
          if ('performance' in window && 'getEntriesByType' in performance) {
            const paintEntries = performance.getEntriesByType('paint');
            paintEntries.forEach(entry => {
              if (entry.name === 'first-contentful-paint') {
                this.metrics.firstContentfulPaint = entry.startTime;
              }
            });
          }
        },

        trackPageLoad() {
          const startTime = performance.now();

          window.addEventListener('load', () => {
            const loadTime = performance.now() - startTime;
            this.metrics.pageLoadTime = loadTime;
            this.checkBudget('pageLoadTime', loadTime);

            // Track resource loading
            const resources = performance.getEntriesByType('resource');
            let totalSize = 0;

            resources.forEach(resource => {
              const size = resource.transferSize || 0;
              totalSize += size;

              this.metrics.networkRequests.push({
                name: resource.name,
                duration: resource.responseEnd - resource.requestStart,
                size: size,
                type: resource.initiatorType,
                timestamp: Date.now()
              });
            });

            this.metrics.bundleSize = totalSize;
            this.checkBudget('bundleSize', totalSize);
          });
        },

        setupMemoryMonitoring() {
          if ('memory' in performance) {
            const trackMemory = () => {
              const memInfo = {
                used: performance.memory.usedJSHeapSize,
                total: performance.memory.totalJSHeapSize,
                limit: performance.memory.jsHeapSizeLimit,
                timestamp: Date.now()
              };

              this.metrics.memoryUsage.push(memInfo);
              this.checkBudget('memoryUsage', memInfo.used);

              // Keep only last 100 entries
              if (this.metrics.memoryUsage.length > 100) {
                this.metrics.memoryUsage = this.metrics.memoryUsage.slice(-100);
              }
            };

            trackMemory();
            setInterval(trackMemory, 30000); // Every 30 seconds
          }
        },

        setupNetworkMonitoring() {
          // Monitor API response times
          const originalFetch = window.fetch;
          window.fetch = async (...args) => {
            const startTime = performance.now();
            try {
              const response = await originalFetch(...args);
              const endTime = performance.now();
              const duration = endTime - startTime;

              this.metrics.apiResponseTimes.push({
                url: args[0],
                duration: duration,
                status: response.status,
                timestamp: Date.now()
              });

              this.checkBudget('apiResponseTime', duration);
              return response;
            } catch (error) {
              const endTime = performance.now();
              const duration = endTime - startTime;

              this.metrics.apiResponseTimes.push({
                url: args[0],
                duration: duration,
                status: 'error',
                error: error.message,
                timestamp: Date.now()
              });

              this.metrics.errorCount++;
              throw error;
            }
          };
        },

        setupUserInteractionTracking() {
          // Track user interactions for analytics
          const trackInteraction = (type, target, data = {}) => {
            this.metrics.userInteractions.push({
              type,
              target: target.tagName + (target.id ? '#' + target.id : '') + (target.className ? '.' + target.className.split(' ')[0] : ''),
              timestamp: Date.now(),
              ...data
            });

            // Keep only last 1000 interactions
            if (this.metrics.userInteractions.length > 1000) {
              this.metrics.userInteractions = this.metrics.userInteractions.slice(-1000);
            }
          };

          // Click tracking with popular content analytics
          document.addEventListener('click', (e) => {
            trackInteraction('click', e.target, {
              x: e.clientX,
              y: e.clientY
            });

            // Track popular images
            if (e.target.closest('.image-card')) {
              const imageCard = e.target.closest('.image-card');
              const imageId = imageCard.dataset.imageId;
              const category = imageCard.dataset.category;

              this.trackEvent('image_interaction', {
                imageId,
                category,
                action: 'click'
              });
            }
          });

          // Filter usage tracking
          document.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
              trackInteraction('filter', e.target, {
                filter: e.target.dataset.filter,
                active: e.target.classList.contains('active')
              });

              this.trackEvent('filter_usage', {
                filter: e.target.dataset.filter,
                active: e.target.classList.contains('active')
              });
            }
          });

          // Modal interactions
          document.addEventListener('click', (e) => {
            if (e.target.classList.contains('expand-btn')) {
              trackInteraction('modal_open', e.target);
              this.trackEvent('modal_interaction', { action: 'open' });
            } else if (e.target.classList.contains('modal-close')) {
              trackInteraction('modal_close', e.target);
              this.trackEvent('modal_interaction', { action: 'close' });
            }
          });

          // Search interactions
          const searchInput = document.getElementById('search-input');
          if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                trackInteraction('search', e.target, {
                  query: e.target.value,
                  length: e.target.value.length
                });

                this.trackEvent('search_query', {
                  query: e.target.value,
                  length: e.target.value.length
                });
              }, 500);
            });
          }

          // Scroll tracking for engagement
          let scrollTimeout;
          window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
              const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
              trackInteraction('scroll', document.body, {
                scrollY: window.scrollY,
                scrollPercent: scrollPercent
              });

              // Track engagement milestones
              if (scrollPercent >= 25 && !this.scrollMilestones?.['25']) {
                this.trackEvent('engagement_milestone', { milestone: '25_percent_scroll' });
                this.scrollMilestones = { ...this.scrollMilestones, '25': true };
              }
              if (scrollPercent >= 50 && !this.scrollMilestones?.['50']) {
                this.trackEvent('engagement_milestone', { milestone: '50_percent_scroll' });
                this.scrollMilestones = { ...this.scrollMilestones, '50': true };
              }
              if (scrollPercent >= 75 && !this.scrollMilestones?.['75']) {
                this.trackEvent('engagement_milestone', { milestone: '75_percent_scroll' });
                this.scrollMilestones = { ...this.scrollMilestones, '75': true };
              }
            }, 250);
          });
        },

        setupErrorTracking() {
          window.addEventListener('error', (e) => {
            this.metrics.errorCount++;
            this.trackError('javascript', e.error?.message || e.message, {
              filename: e.filename,
              lineno: e.lineno,
              colno: e.colno,
              stack: e.error?.stack
            });
          });

          window.addEventListener('unhandledrejection', (e) => {
            this.metrics.errorCount++;
            this.trackError('promise', e.reason?.message || 'Unhandled promise rejection', {
              reason: e.reason
            });
          });
        },

        optimizeBundle() {
          // Code splitting and lazy loading optimization
          const optimizeImages = () => {
            // Implement WebP support detection
            const supportsWebP = () => {
              const canvas = document.createElement('canvas');
              canvas.width = 1;
              canvas.height = 1;
              return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
            };

            if (supportsWebP()) {
              document.documentElement.classList.add('webp-support');
            }

            // Optimize for slow connections
            if ('connection' in navigator) {
              const connection = navigator.connection;
              if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                document.documentElement.classList.add('slow-connection');
                this.trackEvent('connection_type', { type: 'slow' });
              } else {
                this.trackEvent('connection_type', { type: connection.effectiveType });
              }
            }
          };

          optimizeImages();

          // Preload critical resources
          const preloadCriticalResources = () => {
            const criticalImages = document.querySelectorAll('.image-card img[data-src]');
            const visibleImages = Array.from(criticalImages).slice(0, 6); // First 6 images

            visibleImages.forEach(img => {
              const link = document.createElement('link');
              link.rel = 'preload';
              link.as = 'image';
              link.href = img.dataset.src;
              document.head.appendChild(link);
            });
          };

          setTimeout(preloadCriticalResources, 1000);
        },

        trackError(type, message, details = {}) {
          console.error(`Performance Analytics - ${type} error:`, message, details);

          this.sendAnalytics('error', {
            type,
            message,
            details,
            timestamp: Date.now(),
            url: window.location.href,
            userAgent: navigator.userAgent
          });
        },

        checkBudget(metric, value) {
          const budget = this.budgets[metric];
          if (budget && value > budget) {
            console.warn(`Performance budget exceeded for ${metric}: ${value} > ${budget}`);
            this.showPerformanceWarning(metric, value, budget);

            this.trackEvent('performance_budget_exceeded', {
              metric,
              value,
              budget,
              exceedBy: value - budget
            });
          }
        },

        showPerformanceWarning(metric, value, budget) {
          // Only show in development mode
          if (window.location.hostname === 'localhost' || window.location.search.includes('dev=true')) {
            const warning = document.createElement('div');
            warning.className = 'performance-indicator warning';
            warning.innerHTML = `
              <strong>⚠️ Performance Budget Exceeded</strong><br>
              ${metric}: ${Math.round(value)}${metric.includes('Time') ? 'ms' : metric === 'memoryUsage' ? 'B' : metric === 'bundleSize' ? 'B' : ''}<br>
              Budget: ${budget}${metric.includes('Time') ? 'ms' : metric === 'memoryUsage' ? 'B' : metric === 'bundleSize' ? 'B' : ''}
            `;

            document.body.appendChild(warning);

            setTimeout(() => {
              warning.remove();
            }, 8000);
          }
        },

        getMetricsSummary() {
          const avgImageLoadTime = this.metrics.imageLoadTimes.length > 0
            ? this.metrics.imageLoadTimes.reduce((sum, item) => sum + item.loadTime, 0) / this.metrics.imageLoadTimes.length
            : 0;

          const avgApiResponseTime = this.metrics.apiResponseTimes.length > 0
            ? this.metrics.apiResponseTimes.reduce((sum, item) => sum + item.duration, 0) / this.metrics.apiResponseTimes.length
            : 0;

          const currentMemory = this.metrics.memoryUsage.length > 0
            ? this.metrics.memoryUsage[this.metrics.memoryUsage.length - 1]
            : null;

          return {
            pageLoadTime: Math.round(this.metrics.pageLoadTime),
            firstContentfulPaint: Math.round(this.metrics.firstContentfulPaint),
            largestContentfulPaint: Math.round(this.metrics.largestContentfulPaint),
            cumulativeLayoutShift: Math.round(this.metrics.cumulativeLayoutShift * 1000) / 1000,
            firstInputDelay: Math.round(this.metrics.firstInputDelay),
            avgImageLoadTime: Math.round(avgImageLoadTime),
            avgApiResponseTime: Math.round(avgApiResponseTime),
            totalInteractions: this.metrics.userInteractions.length,
            errorCount: this.metrics.errorCount,
            currentMemoryUsage: currentMemory ? Math.round(currentMemory.used / 1024 / 1024) + 'MB' : 'N/A',
            networkRequests: this.metrics.networkRequests.length,
            bundleSize: Math.round(this.metrics.bundleSize / 1024) + 'KB',
            coreWebVitals: this.metrics.coreWebVitals
          };
        },

        startPeriodicReporting() {
          // Report metrics every 5 minutes
          setInterval(() => {
            this.sendAnalytics('performance_report', this.getMetricsSummary());
          }, 5 * 60 * 1000);

          // Report popular content every 10 minutes
          setInterval(() => {
            this.reportPopularContent();
          }, 10 * 60 * 1000);
        },

        reportPopularContent() {
          const imageInteractions = this.metrics.userInteractions.filter(i => i.type === 'click' && i.target.includes('image-card'));
          const filterUsage = this.metrics.userInteractions.filter(i => i.type === 'filter');
          const searchQueries = this.metrics.userInteractions.filter(i => i.type === 'search');

          this.sendAnalytics('popular_content_report', {
            mostClickedImages: this.getMostPopular(imageInteractions, 'target'),
            mostUsedFilters: this.getMostPopular(filterUsage, 'filter'),
            topSearchQueries: this.getMostPopular(searchQueries, 'query'),
            timestamp: Date.now()
          });
        },

        getMostPopular(interactions, key) {
          const counts = {};
          interactions.forEach(interaction => {
            const value = interaction[key] || 'unknown';
            counts[value] = (counts[value] || 0) + 1;
          });

          return Object.entries(counts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10)
            .map(([item, count]) => ({ item, count }));
        },

        sendAnalytics(eventType, data) {
          const analyticsData = {
            eventType,
            data,
            timestamp: Date.now(),
            sessionId: this.getSessionId(),
            userId: this.getUserId(),
            page: 'livestream-images',
            url: window.location.href,
            referrer: document.referrer,
            userAgent: navigator.userAgent,
            viewport: {
              width: window.innerWidth,
              height: window.innerHeight
            },
            connection: this.getConnectionInfo()
          };

          // Store in localStorage for development
          if (window.location.hostname === 'localhost' || window.location.search.includes('dev=true')) {
            const stored = JSON.parse(localStorage.getItem('livestream_analytics') || '[]');
            stored.push(analyticsData);

            // Keep only last 1000 events
            if (stored.length > 1000) {
              stored.splice(0, stored.length - 1000);
            }

            localStorage.setItem('livestream_analytics', JSON.stringify(stored));
            console.log('📊 Analytics Event:', eventType, data);
          }

          // In production, send to analytics service
          // fetch('/api/analytics', {
          //   method: 'POST',
          //   headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify(analyticsData)
          // }).catch(error => console.warn('Analytics send failed:', error));
        },

        getSessionId() {
          let sessionId = sessionStorage.getItem('livestream_session_id');
          if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('livestream_session_id', sessionId);
          }
          return sessionId;
        },

        getUserId() {
          let userId = localStorage.getItem('livestream_user_id');
          if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('livestream_user_id', userId);
          }
          return userId;
        },

        getConnectionInfo() {
          if ('connection' in navigator) {
            return {
              effectiveType: navigator.connection.effectiveType,
              downlink: navigator.connection.downlink,
              rtt: navigator.connection.rtt,
              saveData: navigator.connection.saveData
            };
          }
          return null;
        },

        createPerformanceDashboard() {
          // Performance monitoring dashboard (development only)
          if (window.location.hostname === 'localhost' || window.location.search.includes('dev=true')) {
            const dashboard = document.createElement('div');
            dashboard.id = 'performance-dashboard';
            dashboard.style.cssText = `
              position: fixed;
              top: 100px;
              right: 2em;
              background: rgba(0, 0, 0, 0.95);
              color: white;
              padding: 1em;
              border-radius: 8px;
              font-family: monospace;
              font-size: 0.7em;
              z-index: 10007;
              max-width: 320px;
              display: none;
              backdrop-filter: blur(10px);
              border: 1px solid #333;
            `;

            const updateDashboard = () => {
              const metrics = this.getMetricsSummary();
              const vitalsStatus = this.getCoreWebVitalsStatus(metrics.coreWebVitals);

              dashboard.innerHTML = `
                <div style="margin-bottom: 0.8em; font-weight: bold; color: #00ff00;">📊 Performance Dashboard</div>
                
                <div style="margin-bottom: 0.5em; color: #ffc107;"><strong>Core Web Vitals</strong></div>
                <div style="font-size: 0.9em; margin-bottom: 0.5em;">
                  <div>LCP: ${metrics.largestContentfulPaint}ms ${vitalsStatus.lcp}</div>
                  <div>FID: ${metrics.firstInputDelay}ms ${vitalsStatus.fid}</div>
                  <div>CLS: ${metrics.cumulativeLayoutShift} ${vitalsStatus.cls}</div>
                </div>
                
                <div style="margin-bottom: 0.5em; color: #17a2b8;"><strong>Performance Metrics</strong></div>
                <div style="font-size: 0.9em; margin-bottom: 0.5em;">
                  <div>Page Load: ${metrics.pageLoadTime}ms</div>
                  <div>FCP: ${metrics.firstContentfulPaint}ms</div>
                  <div>Bundle Size: ${metrics.bundleSize}</div>
                  <div>Memory: ${metrics.currentMemoryUsage}</div>
                </div>
                
                <div style="margin-bottom: 0.5em; color: #28a745;"><strong>User Analytics</strong></div>
                <div style="font-size: 0.9em; margin-bottom: 0.5em;">
                  <div>Interactions: ${metrics.totalInteractions}</div>
                  <div>API Avg: ${metrics.avgApiResponseTime}ms</div>
                  <div>Image Avg: ${metrics.avgImageLoadTime}ms</div>
                  <div>Errors: ${metrics.errorCount}</div>
                </div>
                
                <div style="display: flex; gap: 0.5em; margin-top: 0.8em;">
                  <button onclick="window.performanceAnalytics.clearAnalyticsData()" style="
                    background: #dc3545; border: none; color: white; padding: 0.3em 0.6em;
                    border-radius: 4px; cursor: pointer; font-size: 0.8em;
                  ">Clear Data</button>
                  <button onclick="console.log(window.performanceAnalytics.getAnalyticsData())" style="
                    background: #17a2b8; border: none; color: white; padding: 0.3em 0.6em;
                    border-radius: 4px; cursor: pointer; font-size: 0.8em;
                  ">Log Data</button>
                  <button onclick="this.parentElement.parentElement.style.display='none'" style="
                    background: #6c757d; border: none; color: white; padding: 0.3em 0.6em;
                    border-radius: 4px; cursor: pointer; font-size: 0.8em;
                  ">Close</button>
                </div>
              `;
            };

            document.body.appendChild(dashboard);

            // Toggle dashboard with Ctrl+Shift+P
            document.addEventListener('keydown', (e) => {
              if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                dashboard.style.display = dashboard.style.display === 'none' ? 'block' : 'none';
                if (dashboard.style.display === 'block') {
                  updateDashboard();
                  // Update every 3 seconds when visible
                  const interval = setInterval(() => {
                    if (dashboard.style.display === 'block') {
                      updateDashboard();
                    } else {
                      clearInterval(interval);
                    }
                  }, 3000);
                }
              }
            });
          }
        },

        getCoreWebVitalsStatus(vitals) {
          const getStatus = (value, good, needsImprovement) => {
            if (value <= good) return '✅';
            if (value <= needsImprovement) return '⚠️';
            return '❌';
          };

          return {
            lcp: getStatus(vitals.lcp || 0, 2500, 4000),
            fid: getStatus(vitals.fid || 0, 100, 300),
            cls: getStatus(vitals.cls || 0, 0.1, 0.25)
          };
        },

        // Public API for manual tracking
        trackEvent(eventName, properties = {}) {
          this.sendAnalytics('custom_event', {
            eventName,
            properties
          });
        },

        trackPageView(page = window.location.pathname) {
          this.sendAnalytics('page_view', {
            page,
            title: document.title
          });
        },

        getAnalyticsData() {
          return JSON.parse(localStorage.getItem('livestream_analytics') || '[]');
        },

        clearAnalyticsData() {
          localStorage.removeItem('livestream_analytics');
          sessionStorage.removeItem('livestream_session_id');
          console.log('🗑️ Analytics data cleared');
        }
      };

      // Initialize performance analytics
      performanceAnalytics.init();

      // Make it globally available
      window.performanceAnalytics = performanceAnalytics;

      // Track initial page view
      performanceAnalytics.trackPageView();

      // Cleanup on page unload
      window.addEventListener('beforeunload', cleanupResources);

      // Log initial performance after 5 seconds
      setTimeout(() => {
        performanceMonitor.logPerformanceStats();
      }, 5000);

      // Show development mode indicators
      if (window.location.hostname === 'localhost' || window.location.search.includes('dev=true')) {
        document.body.setAttribute('data-dev-mode', 'true');

        // Add performance help indicator
        const perfHelp = document.createElement('div');
        perfHelp.className = 'perf-help';
        perfHelp.innerHTML = '📊 Press Ctrl+Shift+P for Performance Dashboard';
        document.body.appendChild(perfHelp);

        // Hide after 10 seconds
        setTimeout(() => {
          perfHelp.style.opacity = '0';
          setTimeout(() => perfHelp.remove(), 1000);
        }, 10000);
      }

      // Final Integration Test Suite
      const integrationTest = {
        async runFullIntegrationTest() {
          console.log('🚀 Running Full Integration Test Suite...');

          const results = {
            navigation: await this.testNavigation(),
            apiIntegration: await this.testAPIIntegration(),
            userJourney: await this.testUserJourney(),
            performance: await this.testPerformance(),
            accessibility: await this.testAccessibility(),
            mobileResponsiveness: await this.testMobileResponsiveness()
          };

          const overallSuccess = Object.values(results).every(result => result.success);

          console.log('📊 Integration Test Results:', results);
          console.log(overallSuccess ? '✅ All integration tests passed!' : '❌ Some integration tests failed');

          return { success: overallSuccess, results };
        },

        async testNavigation() {
          try {
            // Test navigation highlighting
            const livestreamDropdown = document.querySelector('[data-menu="livestream"]');
            const activeLink = document.querySelector('a[href="livestream-images.html"].clicked');

            return {
              success: !!(livestreamDropdown && activeLink),
              details: {
                dropdownExists: !!livestreamDropdown,
                activeLinkHighlighted: !!activeLink
              }
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        async testAPIIntegration() {
          try {
            const apiTests = [];

            // Test NASA API
            try {
              const nasaResponse = await fetch('https://images-api.nasa.gov/search?q=mars&media_type=image&page_size=1');
              apiTests.push({ api: 'NASA', success: nasaResponse.ok });
            } catch (error) {
              apiTests.push({ api: 'NASA', success: false, error: error.message });
            }

            // Test SpaceX API
            try {
              const spacexResponse = await fetch('https://api.spacexdata.com/v4/launches/latest');
              apiTests.push({ api: 'SpaceX', success: spacexResponse.ok });
            } catch (error) {
              apiTests.push({ api: 'SpaceX', success: false, error: error.message });
            }

            const allAPIsWorking = apiTests.every(test => test.success);

            return {
              success: allAPIsWorking,
              details: apiTests
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        async testUserJourney() {
          try {
            const journeyTests = [];

            // Test filter functionality
            const filterButtons = document.querySelectorAll('.filter-btn');
            journeyTests.push({
              test: 'Filter buttons exist',
              success: filterButtons.length >= 6
            });

            // Test search input
            const searchInput = document.getElementById('search-input');
            journeyTests.push({
              test: 'Search input exists',
              success: !!searchInput
            });

            // Test modal structure
            const modal = document.getElementById('image-modal');
            journeyTests.push({
              test: 'Modal exists',
              success: !!modal
            });

            // Test image gallery
            const gallery = document.getElementById('image-gallery');
            journeyTests.push({
              test: 'Image gallery exists',
              success: !!gallery
            });

            const allJourneyTestsPass = journeyTests.every(test => test.success);

            return {
              success: allJourneyTestsPass,
              details: journeyTests
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        async testPerformance() {
          try {
            const performanceTests = [];

            // Test performance analytics availability
            performanceTests.push({
              test: 'Performance analytics initialized',
              success: !!window.performanceAnalytics
            });

            // Test performance monitor
            performanceTests.push({
              test: 'Performance monitor initialized',
              success: !!window.performanceMonitor
            });

            // Test lazy loading support
            performanceTests.push({
              test: 'Intersection Observer supported',
              success: 'IntersectionObserver' in window
            });

            // Test memory monitoring
            performanceTests.push({
              test: 'Memory monitoring available',
              success: 'memory' in performance
            });

            const allPerformanceTestsPass = performanceTests.every(test => test.success);

            return {
              success: allPerformanceTestsPass,
              details: performanceTests
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        async testAccessibility() {
          try {
            const accessibilityTests = [];

            // Test ARIA labels
            const modalWithAria = document.querySelector('#image-modal[aria-labelledby]');
            accessibilityTests.push({
              test: 'Modal has ARIA labels',
              success: !!modalWithAria
            });

            // Test keyboard navigation elements
            const focusableElements = document.querySelectorAll(
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            accessibilityTests.push({
              test: 'Focusable elements exist',
              success: focusableElements.length > 0
            });

            // Test semantic HTML
            const mainElement = document.querySelector('main');
            accessibilityTests.push({
              test: 'Semantic main element exists',
              success: !!mainElement
            });

            const allAccessibilityTestsPass = accessibilityTests.every(test => test.success);

            return {
              success: allAccessibilityTestsPass,
              details: accessibilityTests
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        },

        async testMobileResponsiveness() {
          try {
            const responsiveTests = [];

            // Test viewport meta tag
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            responsiveTests.push({
              test: 'Viewport meta tag exists',
              success: !!viewportMeta
            });

            // Test responsive grid
            const gallery = document.getElementById('image-gallery');
            const galleryStyles = gallery ? window.getComputedStyle(gallery) : null;
            responsiveTests.push({
              test: 'Gallery uses CSS Grid',
              success: galleryStyles && galleryStyles.display === 'grid'
            });

            // Test touch support detection
            responsiveTests.push({
              test: 'Touch support detected',
              success: 'ontouchstart' in window || navigator.maxTouchPoints > 0
            });

            const allResponsiveTestsPass = responsiveTests.every(test => test.success);

            return {
              success: allResponsiveTestsPass,
              details: responsiveTests
            };
          } catch (error) {
            return { success: false, error: error.message };
          }
        }
      };

      // Make integration test available globally
      window.integrationTest = integrationTest;

      // Auto-run integration test in development mode
      if (window.location.search.includes('integration=true')) {
        setTimeout(() => {
          integrationTest.runFullIntegrationTest();
        }, 3000);
      }
    })();
  </script>
</body>

</html>