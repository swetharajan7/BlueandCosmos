<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExploreX Analytics System Test</title>
    <link rel="stylesheet" href="explorex-analytics-styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .test-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .control-group h3 {
            margin-top: 0;
            color: #495057;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .status-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-value {
            font-weight: bold;
            color: #495057;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metric-card h4 {
            margin-top: 0;
            color: #495057;
        }

        .log-container {
            background: #212529;
            color: #28a745;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .dashboard-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .performance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .performance-good { background-color: #28a745; }
        .performance-needs-improvement { background-color: #ffc107; }
        .performance-poor { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="dashboard-toggle">
        <button class="btn" onclick="toggleAnalyticsDashboard()">
            📊 Analytics Dashboard
        </button>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h1>📊 ExploreX Analytics & Performance Monitoring Test</h1>
            <p>Comprehensive testing of analytics tracking, performance monitoring, and dashboard functionality</p>
        </div>

        <div class="status-display">
            <h3>System Status</h3>
            <div class="status-item">
                <span>Analytics System:</span>
                <span class="status-value" id="analytics-status">Initializing...</span>
            </div>
            <div class="status-item">
                <span>Performance Monitor:</span>
                <span class="status-value" id="performance-status">Initializing...</span>
            </div>
            <div class="status-item">
                <span>Dashboard:</span>
                <span class="status-value" id="dashboard-status">Initializing...</span>
            </div>
            <div class="status-item">
                <span>Events Tracked:</span>
                <span class="status-value" id="events-count">0</span>
            </div>
            <div class="status-item">
                <span>Performance Alerts:</span>
                <span class="status-value" id="alerts-count">0</span>
            </div>
        </div>

        <div class="test-controls">
            <div class="control-group">
                <h3>📈 Event Tracking</h3>
                <button class="btn" onclick="trackPageView()">Track Page View</button>
                <button class="btn" onclick="trackSearch()">Track Search</button>
                <button class="btn" onclick="trackExperienceView()">Track Experience View</button>
                <button class="btn" onclick="trackUserInteraction()">Track Interaction</button>
                <button class="btn secondary" onclick="trackConversion()">Track Conversion</button>
            </div>

            <div class="control-group">
                <h3>⚡ Performance Testing</h3>
                <button class="btn" onclick="simulateSlowResource()">Simulate Slow Resource</button>
                <button class="btn" onclick="simulateMemoryUsage()">Simulate Memory Usage</button>
                <button class="btn" onclick="measureCustomTiming()">Measure Custom Timing</button>
                <button class="btn warning" onclick="triggerPerformanceAlert()">Trigger Alert</button>
            </div>

            <div class="control-group">
                <h3>🚨 Error Simulation</h3>
                <button class="btn danger" onclick="simulateError()">Simulate Error</button>
                <button class="btn danger" onclick="simulateNetworkError()">Network Error</button>
                <button class="btn danger" onclick="simulateJSError()">JavaScript Error</button>
            </div>

            <div class="control-group">
                <h3>📊 Analytics Actions</h3>
                <button class="btn" onclick="generateAnalyticsReport()">Generate Report</button>
                <button class="btn" onclick="exportAnalyticsData()">Export Data</button>
                <button class="btn secondary" onclick="clearAnalyticsData()">Clear Data</button>
                <button class="btn" onclick="showPerformanceSummary()">Performance Summary</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h4>📈 Real-time Metrics</h4>
                <div id="realtime-metrics">
                    <div class="status-item">
                        <span>Page Views:</span>
                        <span class="status-value" id="pageviews-count">0</span>
                    </div>
                    <div class="status-item">
                        <span>Searches:</span>
                        <span class="status-value" id="searches-count">0</span>
                    </div>
                    <div class="status-item">
                        <span>Interactions:</span>
                        <span class="status-value" id="interactions-count">0</span>
                    </div>
                    <div class="status-item">
                        <span>Conversions:</span>
                        <span class="status-value" id="conversions-count">0</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h4>⚡ Performance Metrics</h4>
                <div id="performance-metrics">
                    <div class="status-item">
                        <span>LCP:</span>
                        <span class="status-value" id="lcp-value">-</span>
                        <span class="performance-indicator" id="lcp-indicator"></span>
                    </div>
                    <div class="status-item">
                        <span>FID:</span>
                        <span class="status-value" id="fid-value">-</span>
                        <span class="performance-indicator" id="fid-indicator"></span>
                    </div>
                    <div class="status-item">
                        <span>CLS:</span>
                        <span class="status-value" id="cls-value">-</span>
                        <span class="performance-indicator" id="cls-indicator"></span>
                    </div>
                    <div class="status-item">
                        <span>Memory Usage:</span>
                        <span class="status-value" id="memory-value">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-container" id="log-container">
            <div>📊 Analytics System Test Console</div>
            <div>Ready for testing...</div>
        </div>
    </div>

    <!-- Load Analytics System -->
    <script src="explorex-analytics.js"></script>
    <script src="explorex-performance-monitor.js"></script>
    <script src="explorex-analytics-dashboard.js"></script>

    <script>
        // Global variables
        let analyticsManager;
        let performanceMonitor;
        let analyticsDashboard;
        let eventCounts = {
            pageViews: 0,
            searches: 0,
            interactions: 0,
            conversions: 0,
            total: 0
        };

        // Initialize systems
        async function initializeSystems() {
            try {
                log('🚀 Initializing Analytics Systems...');

                // Initialize Analytics Manager
                analyticsManager = new window.ExploreXAnalytics.AnalyticsManager();
                await analyticsManager.initialize();
                updateStatus('analytics-status', '✅ Active');
                log('✅ Analytics Manager initialized');

                // Initialize Performance Monitor
                performanceMonitor = new window.ExploreXPerformanceMonitor.PerformanceMonitor();
                await performanceMonitor.initialize();
                updateStatus('performance-status', '✅ Active');
                log('✅ Performance Monitor initialized');

                // Initialize Analytics Dashboard
                analyticsDashboard = new window.ExploreXAnalyticsDashboard.AnalyticsDashboard();
                await analyticsDashboard.initialize(analyticsManager, performanceMonitor);
                updateStatus('dashboard-status', '✅ Ready');
                log('✅ Analytics Dashboard initialized');

                // Start monitoring
                startRealTimeMonitoring();
                log('🎯 All systems initialized successfully!');

            } catch (error) {
                log(`❌ Initialization failed: ${error.message}`);
                console.error('Initialization error:', error);
            }
        }

        // Event tracking functions
        function trackPageView() {
            const pages = ['/experiences', '/search', '/profile', '/itinerary', '/about'];
            const randomPage = pages[Math.floor(Math.random() * pages.length)];
            
            analyticsManager.trackPageView(randomPage, {
                source: 'test',
                timestamp: Date.now()
            });
            
            eventCounts.pageViews++;
            eventCounts.total++;
            updateEventCounts();
            log(`📄 Page view tracked: ${randomPage}`);
        }

        function trackSearch() {
            const queries = ['observatory near me', 'planetarium shows', 'space museum', 'astronomy events', 'stargazing locations'];
            const randomQuery = queries[Math.floor(Math.random() * queries.length)];
            
            analyticsManager.trackSearch(randomQuery, {
                location: 'San Francisco',
                filters: { type: 'observatory', distance: '50mi' }
            }, Array(Math.floor(Math.random() * 20)).fill({}));
            
            eventCounts.searches++;
            eventCounts.total++;
            updateEventCounts();
            log(`🔍 Search tracked: "${randomQuery}"`);
        }

        function trackExperienceView() {
            const experiences = ['Griffith Observatory', 'Hayden Planetarium', 'Kennedy Space Center', 'Palomar Observatory'];
            const randomExp = experiences[Math.floor(Math.random() * experiences.length)];
            
            analyticsManager.trackExperienceView(`exp_${Date.now()}`, {
                name: randomExp,
                type: 'observatory',
                location: 'California',
                rating: 4.5
            });
            
            eventCounts.total++;
            updateEventCounts();
            log(`🏛️ Experience view tracked: ${randomExp}`);
        }

        function trackUserInteraction() {
            const interactions = ['click', 'scroll', 'hover', 'focus'];
            const elements = ['button', 'link', 'image', 'form'];
            const randomInteraction = interactions[Math.floor(Math.random() * interactions.length)];
            const randomElement = elements[Math.floor(Math.random() * elements.length)];
            
            analyticsManager.trackUserInteraction(randomElement, randomInteraction, {
                x: Math.floor(Math.random() * 1000),
                y: Math.floor(Math.random() * 800)
            });
            
            eventCounts.interactions++;
            eventCounts.total++;
            updateEventCounts();
            log(`👆 Interaction tracked: ${randomInteraction} on ${randomElement}`);
        }

        function trackConversion() {
            const conversions = ['booking', 'review', 'photo', 'share'];
            const randomConversion = conversions[Math.floor(Math.random() * conversions.length)];
            
            analyticsManager.trackConversion(randomConversion, {
                value: Math.floor(Math.random() * 100),
                experienceId: `exp_${Date.now()}`
            });
            
            eventCounts.conversions++;
            eventCounts.total++;
            updateEventCounts();
            log(`🎯 Conversion tracked: ${randomConversion}`);
        }

        // Performance testing functions
        function simulateSlowResource() {
            const startTime = performance.now();
            
            // Simulate slow resource loading
            setTimeout(() => {
                const duration = performance.now() - startTime + Math.random() * 3000 + 2000;
                performanceMonitor.recordMetric('resource_load_time', duration, {
                    name: 'slow-test-resource.js',
                    type: 'script',
                    simulated: true
                });
                log(`⏱️ Slow resource simulated: ${Math.round(duration)}ms`);
            }, 100);
        }

        function simulateMemoryUsage() {
            // Create large array to simulate memory usage
            const largeArray = new Array(1000000).fill('memory-test-data');
            
            if ('memory' in performance) {
                const memory = performance.memory;
                performanceMonitor.recordMetric('memory_used', memory.usedJSHeapSize, {
                    simulated: true,
                    arraySize: largeArray.length
                });
                log(`💾 Memory usage simulated: ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB`);
            }
            
            // Clean up
            setTimeout(() => {
                largeArray.length = 0;
            }, 1000);
        }

        function measureCustomTiming() {
            const operationName = `custom_operation_${Date.now()}`;
            
            window.ExploreXPerformance.mark(`${operationName}_start`);
            
            // Simulate some work
            setTimeout(() => {
                window.ExploreXPerformance.mark(`${operationName}_end`);
                const duration = window.ExploreXPerformance.measure(
                    operationName,
                    `${operationName}_start`,
                    `${operationName}_end`
                );
                
                log(`⏱️ Custom timing measured: ${operationName} = ${Math.round(duration)}ms`);
            }, Math.random() * 1000 + 500);
        }

        function triggerPerformanceAlert() {
            performanceMonitor.createAlert('test_alert', {
                message: 'Test performance alert triggered',
                severity: 'medium',
                timestamp: Date.now()
            });
            
            updateAlertsCount();
            log(`🚨 Performance alert triggered`);
        }

        // Error simulation functions
        function simulateError() {
            const error = new Error('Simulated test error');
            error.stack = 'Test stack trace';
            
            analyticsManager.trackError(error, {
                component: 'test-system',
                action: 'simulate-error',
                severity: 'medium'
            });
            
            log(`❌ Error simulated and tracked`);
        }

        function simulateNetworkError() {
            fetch('/non-existent-endpoint')
                .catch(error => {
                    analyticsManager.trackError(error, {
                        type: 'network',
                        endpoint: '/non-existent-endpoint'
                    });
                    log(`🌐 Network error simulated and tracked`);
                });
        }

        function simulateJSError() {
            try {
                // Intentionally cause a reference error
                nonExistentFunction();
            } catch (error) {
                analyticsManager.trackError(error, {
                    type: 'javascript',
                    context: 'test-simulation'
                });
                log(`💥 JavaScript error simulated and tracked`);
            }
        }

        // Analytics actions
        function generateAnalyticsReport() {
            const report = analyticsManager.getAnalyticsDashboard('24h');
            log(`📊 Analytics report generated:`);
            log(`   - Events: ${eventCounts.total}`);
            log(`   - Page Views: ${eventCounts.pageViews}`);
            log(`   - Searches: ${eventCounts.searches}`);
            log(`   - Interactions: ${eventCounts.interactions}`);
            log(`   - Conversions: ${eventCounts.conversions}`);
            console.log('Full analytics report:', report);
        }

        function exportAnalyticsData() {
            const data = {
                events: analyticsManager.events.slice(-100),
                metrics: Object.fromEntries(performanceMonitor.metrics),
                timestamp: Date.now()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `explorex-analytics-${Date.now()}.json`;
            a.click();
            
            log(`📥 Analytics data exported`);
        }

        function clearAnalyticsData() {
            analyticsManager.events = [];
            performanceMonitor.metrics.clear();
            performanceMonitor.alerts = [];
            
            eventCounts = { pageViews: 0, searches: 0, interactions: 0, conversions: 0, total: 0 };
            updateEventCounts();
            updateAlertsCount();
            
            log(`🗑️ Analytics data cleared`);
        }

        function showPerformanceSummary() {
            const summary = performanceMonitor.getPerformanceSummary();
            log(`⚡ Performance Summary:`);
            log(`   - Core Web Vitals: LCP=${summary.coreWebVitals.lcp}ms, FID=${summary.coreWebVitals.fid}ms, CLS=${summary.coreWebVitals.cls}`);
            log(`   - Alerts: ${summary.alerts.length}`);
            log(`   - Metrics: ${Object.keys(summary.metrics).length} types tracked`);
            console.log('Full performance summary:', summary);
        }

        // Dashboard functions
        function toggleAnalyticsDashboard() {
            if (analyticsDashboard) {
                analyticsDashboard.toggleDashboard();
                log(`📊 Analytics dashboard toggled`);
            }
        }

        // Utility functions
        function updateEventCounts() {
            document.getElementById('events-count').textContent = eventCounts.total;
            document.getElementById('pageviews-count').textContent = eventCounts.pageViews;
            document.getElementById('searches-count').textContent = eventCounts.searches;
            document.getElementById('interactions-count').textContent = eventCounts.interactions;
            document.getElementById('conversions-count').textContent = eventCounts.conversions;
        }

        function updateAlertsCount() {
            const alertsCount = performanceMonitor ? performanceMonitor.alerts.length : 0;
            document.getElementById('alerts-count').textContent = alertsCount;
        }

        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = status;
            }
        }

        function log(message) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function startRealTimeMonitoring() {
            setInterval(() => {
                updateAlertsCount();
                
                // Update performance metrics display
                if (performanceMonitor) {
                    const summary = performanceMonitor.getPerformanceSummary();
                    
                    if (summary.coreWebVitals.lcp) {
                        document.getElementById('lcp-value').textContent = `${Math.round(summary.coreWebVitals.lcp)}ms`;
                        updatePerformanceIndicator('lcp-indicator', 'lcp', summary.coreWebVitals.lcp);
                    }
                    
                    if (summary.coreWebVitals.fid) {
                        document.getElementById('fid-value').textContent = `${Math.round(summary.coreWebVitals.fid)}ms`;
                        updatePerformanceIndicator('fid-indicator', 'fid', summary.coreWebVitals.fid);
                    }
                    
                    if (summary.coreWebVitals.cls) {
                        document.getElementById('cls-value').textContent = summary.coreWebVitals.cls.toFixed(3);
                        updatePerformanceIndicator('cls-indicator', 'cls', summary.coreWebVitals.cls);
                    }
                    
                    if (summary.metrics.memory_used) {
                        const memoryMB = Math.round(summary.metrics.memory_used.current / 1024 / 1024);
                        document.getElementById('memory-value').textContent = `${memoryMB}MB`;
                    }
                }
            }, 5000);
        }

        function updatePerformanceIndicator(elementId, metric, value) {
            const element = document.getElementById(elementId);
            if (!element || !value) return;
            
            const thresholds = {
                lcp: { good: 2500, poor: 4000 },
                fid: { good: 100, poor: 300 },
                cls: { good: 0.1, poor: 0.25 }
            };
            
            const threshold = thresholds[metric];
            if (!threshold) return;
            
            element.className = 'performance-indicator ';
            if (value <= threshold.good) {
                element.className += 'performance-good';
            } else if (value <= threshold.poor) {
                element.className += 'performance-needs-improvement';
            } else {
                element.className += 'performance-poor';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeSystems);

        // Add some automatic event generation for demo
        setInterval(() => {
            if (Math.random() < 0.3) { // 30% chance every 10 seconds
                const actions = [trackPageView, trackSearch, trackUserInteraction];
                const randomAction = actions[Math.floor(Math.random() * actions.length)];
                randomAction();
            }
        }, 10000);
    </script>
</body>
</html>